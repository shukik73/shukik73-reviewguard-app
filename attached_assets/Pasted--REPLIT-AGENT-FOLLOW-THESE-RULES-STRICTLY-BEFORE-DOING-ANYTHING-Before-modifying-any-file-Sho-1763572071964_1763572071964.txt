ğŸ§° REPLIT AGENT â€” FOLLOW THESE RULES STRICTLY BEFORE DOING ANYTHING

Before modifying any file:

Show me the code blocks you intend to change.

Do NOT refactor or rewrite large sections.

Modify only the specific lines I approve.

Do NOT touch Stripe, Billing, UI, Tailwind, or HTML.

Do NOT change OCR logic except the return JSON.

After every edit, restart the server and show logs.

Do NOT merge edits across tasks. Complete them one-by-one.

ğŸš€ PHASE 1 â€” Execute Tasks 1â€“6 in ORDER
ğŸ”µ TASK 1 â€” Add â€œReply STOP to opt outâ€ to all SMS

Steps:

Search for all client.messages.create blocks in server.js.

Show me each full block before editing.

After approval, append this to the SMS body:

\nReply STOP to opt out.


Do not change anything else in those blocks.

ğŸ”µ TASK 2 â€” Add login protection to sensitive routes

Wrap the following routes with requireLogin:

/send-sms

/api/extract-text

/feedback

/customers/*

/billing/*

Steps:

Show me these routes first.

Insert this middleware (if not already present):

function requireLogin(req, res, next) {
  if (!req.session.userId) return res.redirect('/login.html');
  next();
}


After approval, apply it to the listed routes.

ğŸ”µ TASK 3 â€” Add SMS rate limiting

We want:

1 SMS per 3 seconds per logged-in user

NOT IP-based (repair shops share networks)

Steps:

Show me the /send-sms handler first.

Add this at the top of the handler:

const lastSMSSent = global.lastSMSSent || new Map();
global.lastSMSSent = lastSMSSent;

const userId = req.session.userId;
if (lastSMSSent.has(userId) && Date.now() - lastSMSSent.get(userId) < 3000) {
  return res.status(429).json({ error: "Please wait 3 seconds before sending another SMS." });
}

lastSMSSent.set(userId, Date.now());


Do not edit anything else in the handler.

ğŸ”µ TASK 4 â€” Fix feedback flow logic

Correct behavior:

If rating = 1â€“3 â†’ send apology SMS, mark status â€œreviewedâ€

If rating = 4â€“5 â†’ send Google Review link, mark status â€œlink_clickedâ€

Steps:

Search for feedback processing route (/feedback or similar).

Show me the block before editing.

Update logic to:

if (rating <= 3) {
  // store negative feedback
  status = "reviewed";
  // send apology SMS (append STOP)
} else {
  status = "link_clicked";
  // send Google Review link SMS (append STOP)
}


Do not change anything outside this block.

ğŸ”µ TASK 5 â€” Fix OCR JSON return format

The frontend expects:

{
  "customerName": "...",
  "customerPhone": "...",
  "device": "...",
  "repair": "...",
  "rawText": "..."
}


Steps:

Show me /api/extract-text route.

Modify ONLY the res.json return object.

Do NOT modify HEIC conversion, detection, or parsing logic.

ğŸ”µ TASK 6 â€” Add Twilio error logging

Steps:

Show me the Twilio send block.

Add:

console.log("Sending SMS:", messageBody);


and add:

.catch(err => {
  console.error("Twilio error:", err);
  return res.status(500).json({ error: "SMS failed", details: err.message });
});


Do NOT change working SMS logic.

ğŸŸ¢ AFTER COMPLETING ALL TASKS

Restart server

Send test SMS

Test feedback

Test negative rating (1â€“3)

Test positive rating (4â€“5)

Test OCR extraction

Test login protection

ğŸ¯ Final Reminder

Do NOT start Phase 2 (architecture refactor) until:

âœ” STOP added
âœ” security fixed
âœ” feedback flow fixed
âœ” SMS reliability fixed
âœ” OCR fixed