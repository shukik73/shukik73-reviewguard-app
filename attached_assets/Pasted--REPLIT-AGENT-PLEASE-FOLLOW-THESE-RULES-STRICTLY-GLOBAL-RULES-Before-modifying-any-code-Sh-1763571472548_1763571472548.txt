ğŸ§° REPLIT AGENT â€” PLEASE FOLLOW THESE RULES STRICTLY
ğŸ“Œ GLOBAL RULES

Before modifying any code:

Show me the file and the exact lines you plan to change.

Do NOT refactor, rewrite, or reorganize large files.

Modify ONLY the lines I approve.

Do NOT delete functionality unless I confirm.

Do NOT change UI/HTML layout unless I request.

Do NOT touch Stripe or billing logic unless I instruct.

After each change, restart the server and show logs.

âœ… TASK 1 â€” Add â€œReply STOP to opt outâ€ to all outgoing SMS
Steps:

Show me the Twilio send block in server.js.

After I approve, append this text to every SMS body:

Reply STOP to opt out.


Do not change any logic except adding this sentence.

âœ… TASK 2 â€” Add login protection to backend routes
Wrap these routes in requireLogin():

/send-sms

/api/extract-text

/feedback

/customer/*

/billing/*

Steps:

Show me the code for each route.

Add:

function requireLogin(req, res, next) {
  if (!req.session.userId) return res.redirect('/login.html');
  next();
}


Wrap route handlers after approval.

Do not change anything else.

âœ… TASK 3 â€” Add SMS rate limiting
Requirements:

1 SMS per 3 seconds per logged-in user

Must NOT use IP-based blocking (repair shops share IPs)

Must NOT block OCR or other endpoints

Steps:

Show /send-sms handler.

Add a small in-memory limit:

const lastSMSSent = new Map();

if (lastSMSSent.has(userId) && Date.now() - lastSMSSent.get(userId) < 3000) {
  return res.status(429).json({ error: "Please wait 3 seconds before sending another SMS." });
}

lastSMSSent.set(userId, Date.now());


Do not modify any other SMS logic.

âœ… TASK 4 â€” Fix feedback flow
Correct behavior:

First SMS:
â€œHow was your experience? (1â€“5)â€

If 1â€“3 stars:

Do NOT send Google Review link

Save status as "reviewed"

Send:
"Thank you for your feedback. A team member will contact you shortly."

If 4â€“5 stars:

Save status "link_clicked"

Send Google Review link

Steps for agent:

Show feedback handler before editing.

Update only the status + response logic.

Do NOT modify SMS templates or UI.

âœ… TASK 5 â€” Fix OCR structured JSON return
Requirements:

Modify /api/extract-text return to:

{
  "customerName": "John Doe",
  "customerPhone": "9545551212",
  "device": "iPhone 13 Pro",
  "repair": "Screen Replacement",
  "rawText": "Full OCR text here..."
}

Steps:

Show the OCR endpoint before editing.

Only update the returned JSON keys â€” nothing else.

âœ… TASK 6 â€” Fix Twilio SMS delivery (must log errors)
Required additions:

Add:

console.log("Sending SMS:", messageBody);


Add:

.catch(err => {
  console.error("Twilio error:", err);
  return res.status(500).json({ error: "SMS failed", details: err.message });
});

Steps:

Show Twilio block.

Add error logging only.

Donâ€™t rewrite the whole send function.

ğŸš« DO NOT TOUCH THESE (unless I say so):

index.html layout

Tailwind CSS

Stripe billing routes

Subscription logic

Email templates

Customer dashboard

Database schema

Camera / Upload UI

OCR detection logic

Review link handling

ğŸ”„ AFTER EACH FIX

Agent must:

Restart server

Run the app

Trigger the feature

Show logs

Wait for confirmation before next task

ğŸ¯ Final Result

If the agent follows this list:

âœ” Legal compliance fixed
âœ” SMS abuse protected
âœ” Login protected
âœ” OCR output fixed
âœ” Feedback flow correct
âœ” Twilio reliability improved
âœ” No UI broken
âœ” No refactor chaos
âœ” No lost logic
âœ” Safe step-by-step improvements