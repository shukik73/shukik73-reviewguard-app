<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Request Manager - Repair Service</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .message-card, .customer-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .message-header, .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-name, .customer-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .message-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .message-type.review {
            background: #d4edda;
            color: #155724;
        }

        .message-type.ready {
            background: #d1ecf1;
            color: #0c5460;
        }

        .message-time, .customer-info {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
        }

        .customer-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 14px;
        }

        .customer-phone {
            font-family: monospace;
            background: #e0e0e0;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .customer-select-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .customer-select-btn:hover {
            background: #5568d3;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .helper-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 25px;
        }

        .info-box h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .file-upload-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }

        .file-upload-label:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-upload-label.has-file {
            border-color: #667eea;
            background: #f0f4ff;
        }

        input[type="file"] {
            display: none;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .file-text {
            color: #666;
            font-size: 14px;
        }

        .preview-container {
            margin-top: 10px;
            display: none;
        }

        .preview-container.active {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 10px;
        }

        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .ocr-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
        }

        .ocr-section h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .ocr-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .ocr-upload-label:hover {
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .ocr-upload-label.processing {
            cursor: wait;
            opacity: 0.7;
        }

        .ocr-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .ocr-status.active {
            display: block;
        }

        .ocr-preview {
            margin-top: 15px;
            max-height: 150px;
            border-radius: 10px;
            display: none;
        }

        .ocr-preview.active {
            display: block;
        }

        .extracted-data {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: none;
        }

        .extracted-data.active {
            display: block;
        }

        .extracted-data-item {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .extracted-data-item strong {
            display: inline-block;
            width: 80px;
        }

        .export-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .template-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .template-section.active {
            display: block;
        }

        .template-section h4 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 15px;
        }

        .template-suggestion {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .use-template-btn {
            margin-top: 8px;
            padding: 6px 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .use-template-btn:hover {
            background: #5568d3;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            .header h1 {
                font-size: 24px;
            }

            .export-btn {
                padding: 8px 14px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Techy Miramar SMS Manager</h1>
            <p>Review requests, pickup notifications & customer management</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'send')">üì§ Send SMS</button>
            <button class="tab" onclick="switchTab(event, 'dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab(event, 'history')">üìú History</button>
            <button class="tab" onclick="switchTab(event, 'customers')">üë• Customers</button>
            <button class="tab" onclick="switchTab(event, 'billing')">üí≥ Billing</button>
        </div>

        <div id="alertBox" class="alert"></div>

        <div id="sendTab" class="tab-content active">

        <div class="ocr-section">
            <h3>üì∏ Quick Fill from Repair Order (Optional)</h3>
            <p style="font-size: 14px; margin-bottom: 15px; opacity: 0.9;">Upload a photo of your repair order to automatically extract customer information</p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input 
                    type="file" 
                    id="ocrPhoto" 
                    accept="image/*"
                    style="display: none;"
                />
                <label for="ocrPhoto" class="ocr-upload-label" id="ocrUploadLabel" style="flex: 1; margin: 0;">
                    <span class="file-icon">üìÑ</span>
                    <span id="ocrUploadText">Click to upload repair order photo</span>
                </label>
                
                <input 
                    type="file" 
                    id="ocrCamera" 
                    accept="image/*"
                    capture="environment"
                    style="display: none;"
                />
                <label for="ocrCamera" class="ocr-upload-label" id="ocrCameraLabel" style="flex: 1; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span class="file-icon">üì∑</span>
                    <span>Take Photo</span>
                </label>
            </div>
            
            <img id="ocrPreview" class="ocr-preview" alt="Repair order preview" />
            
            <div class="ocr-status" id="ocrStatus"></div>
            
            <div class="extracted-data" id="extractedData">
                <div class="extracted-data-item">
                    <strong>Name:</strong> <span id="extractedName">-</span>
                </div>
                <div class="extracted-data-item">
                    <strong>Phone:</strong> <span id="extractedPhone">-</span>
                </div>
                <div class="extracted-data-item">
                    <strong>Device:</strong> <span id="extractedDevice">-</span>
                </div>
                <div class="extracted-data-item">
                    <strong>Repair:</strong> <span id="extractedRepair">-</span>
                </div>
            </div>
        </div>

        <div class="template-section" id="templateSection">
            <h4>üí° Smart Template Suggestions</h4>
            <div id="templateSuggestions"></div>
        </div>

        <form id="reviewForm">
            <div class="form-group">
                <label for="messageType">Message Type *</label>
                <select id="messageType" name="messageType" required>
                    <option value="review">üåü Google Review Request</option>
                    <option value="ready">‚úÖ Device Ready for Pickup</option>
                </select>
            </div>

            <div class="form-group">
                <label for="customerName">Customer Name *</label>
                <input 
                    type="text" 
                    id="customerName" 
                    name="customerName" 
                    placeholder="e.g., John Smith" 
                    required
                />
            </div>

            <div class="form-group">
                <label for="customerPhone">Customer Phone Number *</label>
                <input 
                    type="tel" 
                    id="customerPhone" 
                    name="customerPhone" 
                    placeholder="e.g., +1234567890 or +44 20 7123 4567" 
                    required
                />
                <div class="helper-text">Include country code (e.g., +1 for US, +44 for UK). Spaces and dashes OK.</div>
            </div>

            <div class="form-group" id="reviewLinkGroup">
                <label for="googleReviewLink">Google Review Link</label>
                <input 
                    type="url" 
                    id="googleReviewLink" 
                    name="googleReviewLink" 
                    value="https://g.page/r/CXmh-C0UxHgqEBM/review"
                    readonly
                />
                <div class="helper-text">Your Techy Miramar Google review link</div>
            </div>

            <div class="form-group">
                <label for="additionalInfo">Additional Message (Optional)</label>
                <textarea 
                    id="additionalInfo" 
                    name="additionalInfo" 
                    placeholder="Add any specific notes about the repair or service..."
                ></textarea>
                <div class="helper-text" id="additionalInfoHelper">Personalize the message with repair details</div>
            </div>

            <div class="form-group">
                <label for="photo">Attach Photo of Repair (Optional)</label>
                <div class="file-upload-wrapper">
                    <input 
                        type="file" 
                        id="photo" 
                        name="photo" 
                        accept="image/jpeg,image/png,image/gif,application/pdf"
                    />
                    <label for="photo" class="file-upload-label" id="fileLabel">
                        <span class="file-icon">üìé</span>
                        <span class="file-text" id="fileText">Click to upload before/after photo</span>
                    </label>
                </div>
                <div class="helper-text">Images (JPEG, PNG, GIF) or PDF up to 5MB</div>
                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" class="preview-image" alt="Preview" />
                </div>
            </div>

            <button type="submit" class="btn" id="submitBtn">
                Send Review Request
            </button>
        </form>
        </div>

        <div id="dashboardTab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">üìä Dashboard</h2>
            <div class="stats-grid" id="statsGrid"></div>
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Recent Messages</h3>
            <div id="recentMessages"></div>
        </div>

        <div id="historyTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; margin: 0;">üìú Message History</h2>
                <button onclick="exportMessagesToCSV()" class="export-btn">üì• Export to CSV</button>
            </div>
            <div class="search-box">
                <input 
                    type="text" 
                    id="historySearch" 
                    placeholder="üîç Search by customer name, phone, or message type..."
                    onkeyup="filterHistory()"
                    style="margin-bottom: 20px;"
                />
            </div>
            <div id="messageHistory"></div>
        </div>

        <div id="customersTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; margin: 0;">üë• Customer Database</h2>
                <button onclick="exportCustomersToCSV()" class="export-btn">üì• Export to CSV</button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">Click on a customer to auto-fill their information in the send form</p>
            <div class="search-box">
                <input 
                    type="text" 
                    id="customerSearch" 
                    placeholder="üîç Search by name or phone number..."
                    onkeyup="filterCustomers()"
                    style="margin-bottom: 20px;"
                />
            </div>
            <div id="customerList"></div>
        </div>

        <div id="billingTab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">üí≥ Subscription & Billing</h2>
            
            <div id="subscriptionStatus" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px;">Current Plan & Usage</h3>
                <div id="currentPlanInfo" style="color: #666;">
                    <p>Loading subscription status...</p>
                </div>
                <div id="usageMeter" style="margin-top: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #333;">SMS Usage</span>
                        <span id="usageText" style="color: #666;"></span>
                    </div>
                    <div style="width: 100%; height: 30px; background: #e9ecef; border-radius: 15px; overflow: hidden;">
                        <div id="usageBar" style="height: 100%; background: linear-gradient(90deg, #28a745 0%, #ffc107 70%, #dc3545 90%); width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <div id="usageWarning" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
                </div>
                <div id="portalButtonContainer" style="margin-top: 20px; display: none;">
                    <button onclick="openCustomerPortal()" class="btn" style="background: #667eea;">
                        üîß Manage Subscription
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px;">üí¨ Enter Your Email</h3>
                <input 
                    type="email" 
                    id="billingEmail" 
                    placeholder="your@email.com" 
                    style="width: 100%; max-width: 400px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                    onchange="checkSubscriptionStatus()"
                />
            </div>

            <h3 style="margin-bottom: 20px;">Choose Your Plan</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #f0f0f0;">
                    <h4 style="margin: 0 0 10px 0; font-size: 24px; color: #667eea;">üöÄ Starter</h4>
                    <div style="margin-bottom: 20px;">
                        <span style="font-size: 36px; font-weight: bold; color: #333;">$49</span>
                        <span style="color: #999;">/month</span>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0 0 25px 0; color: #666;">
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ 300 SMS per month</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ Review tracking</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ Automatic follow-ups</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ Customer database</li>
                        <li style="padding: 8px 0;">‚úÖ OCR text extraction</li>
                    </ul>
                    <button 
                        onclick="createCheckoutSession('price_starter')" 
                        class="btn" 
                        style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                    >
                        Subscribe to Starter
                    </button>
                </div>

                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(102,126,234,0.3); border: 3px solid #667eea; position: relative;">
                    <div style="position: absolute; top: -15px; right: 20px; background: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">POPULAR</div>
                    <h4 style="margin: 0 0 10px 0; font-size: 24px; color: #667eea;">‚ö° Pro</h4>
                    <div style="margin-bottom: 20px;">
                        <span style="font-size: 36px; font-weight: bold; color: #333;">$99</span>
                        <span style="color: #999;">/month</span>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0 0 25px 0; color: #666;">
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ 1,000 SMS per month</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ Review tracking</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ Automatic follow-ups</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ Customer database</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úÖ OCR text extraction</li>
                        <li style="padding: 8px 0;">‚úÖ Priority support</li>
                    </ul>
                    <button 
                        onclick="createCheckoutSession('price_pro')" 
                        class="btn" 
                        style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                    >
                        Subscribe to Pro
                    </button>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <p style="margin: 0; color: #666; font-size: 14px;">
                    <strong>Note:</strong> You're currently using test mode. No real charges will be made. 
                    Use test card: <code style="background: white; padding: 2px 6px; border-radius: 4px;">4242 4242 4242 4242</code> with any future expiry date and CVC.
                </p>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('reviewForm');
        const alertBox = document.getElementById('alertBox');
        const submitBtn = document.getElementById('submitBtn');
        const photoInput = document.getElementById('photo');
        const fileLabel = document.getElementById('fileLabel');
        const fileText = document.getElementById('fileText');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const messageTypeSelect = document.getElementById('messageType');
        const reviewLinkGroup = document.getElementById('reviewLinkGroup');
        const additionalInfoHelper = document.getElementById('additionalInfoHelper');
        const ocrPhotoInput = document.getElementById('ocrPhoto');
        const ocrUploadLabel = document.getElementById('ocrUploadLabel');
        const ocrUploadText = document.getElementById('ocrUploadText');
        const ocrPreview = document.getElementById('ocrPreview');
        const ocrStatus = document.getElementById('ocrStatus');
        const extractedData = document.getElementById('extractedData');
        const extractedName = document.getElementById('extractedName');
        const extractedPhone = document.getElementById('extractedPhone');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');

        function updateFormForMessageType() {
            const messageType = messageTypeSelect.value;
            if (messageType === 'review') {
                reviewLinkGroup.style.display = 'block';
                submitBtn.textContent = 'Send Review Request';
                additionalInfoHelper.textContent = 'Personalize the message with repair details';
            } else {
                reviewLinkGroup.style.display = 'none';
                submitBtn.textContent = 'Send Pickup Notification';
                additionalInfoHelper.textContent = 'Add pickup instructions or location details';
            }
        }

        messageTypeSelect.addEventListener('change', updateFormForMessageType);

        updateFormForMessageType();

        function parseTextForCustomerInfo(text) {
            const lines = text.split('\n').map(line => line.trim());
            let name = '';
            let phone = '';
            let device = '';
            let repair = '';

            const phoneRegex = /[\+\(]?[1-9]\d{0,2}[\s\-\.]?\(?\d{2,3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{4}/g;
            const phoneMatches = text.match(phoneRegex);
            if (phoneMatches && phoneMatches.length > 0) {
                phone = phoneMatches[0].replace(/[\s\-\(\)\.]/g, '');
                if (!phone.startsWith('+')) {
                    if (phone.length === 10) {
                        phone = '+1' + phone;
                    } else if (phone.length === 11 && phone.startsWith('1')) {
                        phone = '+' + phone;
                    } else {
                        phone = '+' + phone;
                    }
                }
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.match(/customer\s+#\d+/i)) {
                    for (let j = i + 1; j < Math.min(i + 8, lines.length); j++) {
                        const nextLine = lines[j];
                        if (!nextLine || nextLine.length < 3) continue;
                        if (nextLine.match(/added|store|credits|notifications|email|alert|mobile/i)) continue;
                        if (nextLine.match(/\d{3}/) || nextLine.match(/^\$/) || nextLine.match(/^[A-Z]{2}$/)) continue;
                        
                        const cleaned = nextLine.replace(/[|:;\+\-\(\)\.]/g, ' ').trim();
                        const words = cleaned.split(/\s+/).filter(w => w.length > 1);
                        
                        if (words.length >= 2 && words.length <= 4) {
                            const allLetters = words.every(w => w.match(/^[a-zA-Z]+$/));
                            if (allLetters) {
                                const titleCase = words
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                    .join(' ');
                                name = titleCase;
                                break;
                            }
                        }
                    }
                }
                
                if (line.match(/customer\s+information/i)) {
                    for (let j = i + 1; j < Math.min(i + 15, lines.length); j++) {
                        const nextLine = lines[j];
                        if (!nextLine || nextLine.match(/mobile|store|credits|edit|phone|email/i)) continue;
                        
                        const cleaned = nextLine.replace(/[|:;\+\-\(\)\.]/g, ' ').trim();
                        
                        if (cleaned.length < 5 || cleaned.length > 50) continue;
                        
                        const words = cleaned.split(/\s+/).filter(w => w.length > 1);
                        
                        if (words.length === 2 || words.length === 3) {
                            const allLetters = words.every(w => w.match(/^[a-zA-Z]+$/));
                            
                            if (allLetters && !words.some(w => w.match(/^(customer|information|mobile|store|credits|edit|by|fg|te)$/i))) {
                                const titleCase = words
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                    .join(' ');
                                name = titleCase;
                                break;
                            }
                        }
                    }
                }

                if (!name && line.length > 3 && line.length < 50 && line.match(/^[A-Z][A-Za-z\s]+$/)) {
                    const words = line.split(/\s+/);
                    if (words.length >= 2 && words.length <= 5 && !line.match(/CUSTOMER|INFORMATION|SERVICE|REPAIR|DEVICE|STORE|MOBILE|CREDITS|ESTIMATES|INQUIRIES|TOTAL/i)) {
                        name = line;
                    }
                }

                if (line.match(/service\s+information/i)) {
                    for (let j = i + 1; j < Math.min(i + 10, lines.length); j++) {
                        const nextLine = lines[j];
                        
                        if (nextLine.match(/(computer|cellphone|laptop|tablet|pc)\s+repairs\s*-/i)) {
                            const deviceMatch = nextLine.match(/repairs\s*-\s*(.+)/i);
                            if (deviceMatch) {
                                const parts = deviceMatch[1].trim().split(/\s*-\s*/);
                                let rawDevice = parts.length > 1 ? parts.slice(1).join(' - ') : parts[0];
                                
                                rawDevice = rawDevice.split(/\s+/).filter(word => {
                                    return word.match(/^[a-zA-Z0-9]+$/) && word.length > 1;
                                }).join(' ');
                                
                                device = rawDevice.trim();
                            }
                        }
                        
                        if (nextLine.match(/device\s+issue:/i)) {
                            const issueMatch = nextLine.match(/device\s+issue:\s*(.+)/i);
                            if (issueMatch) {
                                repair = issueMatch[1].trim();
                            }
                        }
                    }
                }
            }

            return { name: name.trim(), phone: phone, device: device.trim(), repair: repair.trim() };
        }

        async function processOCRImage(file, labelElement, textElement) {
            if (!file) return;

            labelElement.classList.add('processing');
            if (textElement) textElement.textContent = 'Processing...';
            ocrStatus.textContent = '‚è≥ Scanning image and extracting text...';
            ocrStatus.classList.add('active');

            const reader = new FileReader();
            reader.onload = async function(e) {
                ocrPreview.src = e.target.result;
                ocrPreview.classList.add('active');

                try {
                    const worker = await Tesseract.createWorker('eng');
                    const { data: { text } } = await worker.recognize(e.target.result);
                    await worker.terminate();

                    console.log('Extracted text:', text);

                    document.getElementById('templateSection').classList.remove('active');
                    document.getElementById('templateSuggestions').innerHTML = '';

                    const customerInfo = parseTextForCustomerInfo(text);
                    
                    extractedName.textContent = customerInfo.name || 'Not found';
                    extractedPhone.textContent = customerInfo.phone || 'Not found';
                    document.getElementById('extractedDevice').textContent = customerInfo.device || 'Not found';
                    document.getElementById('extractedRepair').textContent = customerInfo.repair || 'Not found';
                    extractedData.classList.add('active');

                    if (customerInfo.name) {
                        customerNameInput.value = customerInfo.name;
                    }
                    if (customerInfo.phone) {
                        customerPhoneInput.value = customerInfo.phone;
                    }

                    if (customerInfo.device && customerInfo.repair) {
                        generateTemplateSuggestions(customerInfo.device, customerInfo.repair, customerInfo.name);
                    }

                    if (customerInfo.name || customerInfo.phone) {
                        ocrStatus.textContent = '‚úÖ Customer information extracted! You can edit the fields below if needed.';
                    } else {
                        ocrStatus.textContent = '‚ö†Ô∏è Could not extract customer info. Please enter manually below.';
                    }
                } catch (error) {
                    console.error('OCR Error:', error);
                    ocrStatus.textContent = '‚ùå Error processing image. Please enter information manually.';
                }

                labelElement.classList.remove('processing');
                if (textElement) textElement.textContent = file.name;
            };
            reader.readAsDataURL(file);
        }

        ocrPhotoInput.addEventListener('change', async function(e) {
            await processOCRImage(e.target.files[0], ocrUploadLabel, ocrUploadText);
        });

        const ocrCameraInput = document.getElementById('ocrCamera');
        const ocrCameraLabel = document.getElementById('ocrCameraLabel');
        
        ocrCameraInput.addEventListener('change', async function(e) {
            await processOCRImage(e.target.files[0], ocrCameraLabel, null);
        });

        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileLabel.classList.add('has-file');
                fileText.textContent = file.name;
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewContainer.classList.add('active');
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.remove('active');
                }
            } else {
                fileLabel.classList.remove('has-file');
                fileText.textContent = 'Click to upload before/after photo';
                previewContainer.classList.remove('active');
            }
        });

        function showAlert(message, type) {
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const messageType = messageTypeSelect.value;
            const googleReviewLink = document.getElementById('googleReviewLink').value.trim();
            const additionalInfo = document.getElementById('additionalInfo').value.trim();
            const photoFile = photoInput.files[0];

            if (!customerName || !customerPhone) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const userEmail = localStorage.getItem('userEmail');
                if (!userEmail) {
                    showAlert('‚ùå Please enter your email in the Billing tab first to send SMS', 'error');
                    submitBtn.disabled = false;
                    updateFormForMessageType();
                    return;
                }

                const formData = new FormData();
                formData.append('customerName', customerName);
                formData.append('customerPhone', customerPhone);
                formData.append('messageType', messageType);
                formData.append('userEmail', userEmail);
                if (messageType === 'review' && googleReviewLink) formData.append('googleReviewLink', googleReviewLink);
                if (additionalInfo) formData.append('additionalInfo', additionalInfo);
                if (photoFile) formData.append('photo', photoFile);

                const response = await fetch('/api/send-review-request', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    let successMsg = messageType === 'ready' 
                        ? `‚úÖ Pickup notification sent successfully to ${customerName}!`
                        : `‚úÖ Review request sent successfully to ${customerName}!`;
                    if (data.photoAttached) {
                        successMsg += ' (Photo included)';
                    }
                    showAlert(successMsg, 'success');
                    form.reset();
                    fileLabel.classList.remove('has-file');
                    fileText.textContent = 'Click to upload before/after photo';
                    previewContainer.classList.remove('active');
                    updateFormForMessageType();
                    loadDashboard();
                } else {
                    if (data.code === 'QUOTA_EXCEEDED') {
                        showAlert(`‚ùå ${data.error} Click the Billing tab to upgrade.`, 'error');
                    } else if (data.code === 'EMAIL_REQUIRED') {
                        showAlert('‚ùå Please enter your email in the Billing tab first', 'error');
                    } else {
                        showAlert(`‚ùå Error: ${data.error}`, 'error');
                    }
                }
            } catch (error) {
                showAlert('‚ùå Failed to send request. Please try again.', 'error');
                console.error('Error:', error);
            } finally {
                submitBtn.disabled = false;
                updateFormForMessageType();
            }
        });

        function switchTab(e, tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'billing') {
                loadBillingTab();
            } else if (tabName === 'customers') {
                loadCustomers();
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    const statsGrid = document.getElementById('statsGrid');
                    
                    const reviewPending = stats.reviewStats?.find(s => s.review_status === 'pending')?.count || 0;
                    const reviewClicked = stats.reviewStats?.find(s => s.review_status === 'link_clicked')?.count || 0;
                    const reviewReceived = stats.reviewStats?.find(s => s.review_status === 'reviewed')?.count || 0;
                    const followUpSent = stats.reviewStats?.find(s => s.review_status === 'follow_up_sent')?.count || 0;
                    const needsFollowUp = stats.needsFollowUp || 0;
                    
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${stats.totalMessages}</div>
                            <div class="stat-label">Total Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.totalCustomers}</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.todayMessages}</div>
                            <div class="stat-label">Today's Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.weekMessages}</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #34d399 0%, #10b981 100%);">
                            <div class="stat-number">${reviewReceived}</div>
                            <div class="stat-label">‚úÖ Reviews Received</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                            <div class="stat-number">${reviewClicked}</div>
                            <div class="stat-label">üëÜ Links Clicked</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
                            <div class="stat-number">${reviewPending}</div>
                            <div class="stat-label">‚è≥ Pending Reviews</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);">
                            <div class="stat-number">${needsFollowUp}</div>
                            <div class="stat-label">üîî Needs Follow-up</div>
                            ${needsFollowUp > 0 ? `<button onclick="sendFollowUps()" style="margin-top: 12px; padding: 8px 16px; background: white; color: #ef4444; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Send Follow-ups</button>` : ''}
                        </div>
                    `;

                    const recentMessages = document.getElementById('recentMessages');
                    if (stats.recentMessages.length === 0) {
                        recentMessages.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No messages sent yet</p></div>';
                    } else {
                        recentMessages.innerHTML = stats.recentMessages.map(msg => `
                            <div class="message-card">
                                <div class="message-header">
                                    <span class="message-name">${msg.customer_name}</span>
                                    <span class="message-type ${msg.message_type}">
                                        ${msg.message_type === 'review' ? 'üåü Review' : '‚úÖ Pickup'}
                                    </span>
                                </div>
                                <div class="message-time">${new Date(msg.sent_at).toLocaleString()}</div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                
                if (data.success) {
                    const messageHistory = document.getElementById('messageHistory');
                    
                    if (data.messages.length === 0) {
                        messageHistory.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No message history yet. Send your first message!</p></div>';
                    } else {
                        messageHistory.innerHTML = data.messages.map(msg => {
                            let reviewStatusBadge = '';
                            let reviewButton = '';
                            
                            if (msg.message_type === 'review' && msg.review_status) {
                                const statusMap = {
                                    'pending': { text: 'Pending', icon: '‚è≥', color: '#fbbf24' },
                                    'link_clicked': { text: 'Link Clicked', icon: 'üëÜ', color: '#60a5fa' },
                                    'reviewed': { text: 'Reviewed ‚úì', icon: '‚úÖ', color: '#34d399' },
                                    'follow_up_sent': { text: 'Follow-up Sent', icon: 'üîî', color: '#a78bfa' }
                                };
                                const status = statusMap[msg.review_status] || statusMap['pending'];
                                reviewStatusBadge = `<span class="review-status-badge" style="background: ${status.color}20; color: ${status.color}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 8px;">${status.icon} ${status.text}</span>`;
                                
                                if (msg.review_status !== 'reviewed') {
                                    reviewButton = `<button onclick="markReviewReceived(${msg.id})" style="margin-top: 10px; background: #34d399; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">Mark Review Received ‚úì</button>`;
                                }
                            }
                            
                            return `
                            <div class="message-card">
                                <div class="message-header">
                                    <span class="message-name">${msg.customer_name}</span>
                                    <div>
                                        <span class="message-type ${msg.message_type}">
                                            ${msg.message_type === 'review' ? 'üåü Review Request' : msg.message_type === 'review_follow_up' ? 'üîî Follow-up' : '‚úÖ Device Ready'}
                                        </span>
                                        ${reviewStatusBadge}
                                    </div>
                                </div>
                                <div class="message-time">
                                    üìû ${msg.customer_phone} | üìÖ ${new Date(msg.sent_at).toLocaleString()}
                                </div>
                                ${msg.additional_info ? `<div style="margin-top: 10px; color: #666; font-size: 14px;">${msg.additional_info}</div>` : ''}
                                ${msg.photo_path ? `<div style="margin-top: 10px; color: #667eea; font-size: 13px;">üì∑ Photo attached</div>` : ''}
                                ${reviewButton}
                            </div>
                        `}).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                const data = await response.json();
                
                if (data.success) {
                    const customerList = document.getElementById('customerList');
                    
                    if (data.customers.length === 0) {
                        customerList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No customers yet. Send your first message to add a customer!</p></div>';
                    } else {
                        customerList.innerHTML = data.customers.map(customer => `
                            <div class="customer-card">
                                <div class="customer-header">
                                    <span class="customer-name">${customer.name}</span>
                                    <span class="customer-phone">${customer.phone}</span>
                                </div>
                                <div class="customer-stats">
                                    <span>üí¨ ${customer.message_count} messages</span>
                                    ${customer.last_message_at ? `<span>üìÖ Last: ${new Date(customer.last_message_at).toLocaleDateString()}</span>` : ''}
                                </div>
                                <button class="customer-select-btn" onclick="selectCustomer('${customer.name}', '${customer.phone}')">
                                    Use in Send Form
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function selectCustomer(name, phone) {
            document.getElementById('customerName').value = name;
            document.getElementById('customerPhone').value = phone;
            
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('.tab[onclick*="send"]').classList.add('active');
            document.getElementById('sendTab').classList.add('active');
            showAlert(`‚ú® Customer info loaded: ${name}`, 'success');
        }

        let allMessages = [];
        let allCustomers = [];

        function generateTemplateSuggestions(device, repair, customerName) {
            const templateSection = document.getElementById('templateSection');
            const templateSuggestions = document.getElementById('templateSuggestions');
            const additionalInfoField = document.getElementById('additionalInfo');
            
            const templates = {
                review: `We completed the ${repair} on your ${device}. Everything is working perfectly!`,
                pickup: `Your ${device} is ready! We successfully completed the ${repair}. You can pick it up at your convenience.`
            };

            templateSuggestions.innerHTML = `
                <div class="template-suggestion">
                    <strong>Review Request Template:</strong><br>
                    "${templates.review}"
                    <br>
                    <button class="use-template-btn" onclick="useTemplate('${templates.review.replace(/'/g, "\\'")}')">Use This</button>
                </div>
                <div class="template-suggestion">
                    <strong>Pickup Notification Template:</strong><br>
                    "${templates.pickup}"
                    <br>
                    <button class="use-template-btn" onclick="useTemplate('${templates.pickup.replace(/'/g, "\\'")}')">Use This</button>
                </div>
            `;
            
            templateSection.classList.add('active');
        }

        function useTemplate(template) {
            document.getElementById('additionalInfo').value = template;
            showAlert('‚úÖ Template added to your message!', 'success');
        }

        async function markReviewReceived(messageId) {
            try {
                const response = await fetch(`/api/messages/${messageId}/review-status`, {
                    method: 'PATCH'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Review marked as received!', 'success');
                    loadHistory();
                    loadDashboard();
                } else {
                    showAlert('‚ùå Failed to update review status', 'error');
                }
            } catch (error) {
                console.error('Error marking review:', error);
                showAlert('‚ùå Error updating review status', 'error');
            }
        }

        async function sendFollowUps() {
            try {
                const response = await fetch('/api/messages/needs-followup');
                const data = await response.json();
                
                if (!data.success || data.messages.length === 0) {
                    showAlert('No messages need follow-up right now!', 'info');
                    return;
                }
                
                const confirmed = confirm(`Send follow-up reminders to ${data.messages.length} customer(s)?\n\nThey haven't clicked their review links and it's been 3+ days.`);
                
                if (!confirmed) return;
                
                const messageIds = data.messages.map(msg => msg.id);
                
                const sendResponse = await fetch('/api/follow-ups/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageIds })
                });
                
                const sendData = await sendResponse.json();
                
                if (sendData.success) {
                    showAlert(`‚úÖ Sent ${sendData.sent} follow-up message(s)!`, 'success');
                    loadHistory();
                    loadDashboard();
                } else {
                    showAlert('‚ùå Failed to send follow-ups', 'error');
                }
            } catch (error) {
                console.error('Error sending follow-ups:', error);
                showAlert('‚ùå Error sending follow-ups', 'error');
            }
        }

        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const messageCards = document.querySelectorAll('#messageHistory .message-card');
            
            messageCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const customerCards = document.querySelectorAll('#customerList .customer-card');
            
            customerCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function exportMessagesToCSV() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                
                if (!data.success || data.messages.length === 0) {
                    showAlert('‚ö†Ô∏è No messages to export', 'error');
                    return;
                }

                const headers = ['Date', 'Customer Name', 'Phone', 'Message Type', 'Additional Info'];
                const rows = data.messages.map(msg => [
                    new Date(msg.sent_at).toLocaleString(),
                    msg.customer_name,
                    msg.customer_phone,
                    msg.message_type === 'review' ? 'Review Request' : 'Device Ready',
                    msg.additional_info || ''
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `message-history-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('‚úÖ Message history exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('‚ùå Failed to export messages', 'error');
            }
        }

        async function exportCustomersToCSV() {
            try {
                const response = await fetch('/api/customers');
                const data = await response.json();
                
                if (!data.success || data.customers.length === 0) {
                    showAlert('‚ö†Ô∏è No customers to export', 'error');
                    return;
                }

                const headers = ['Name', 'Phone', 'Total Messages', 'Last Contact'];
                const rows = data.customers.map(customer => [
                    customer.name,
                    customer.phone,
                    customer.message_count,
                    customer.last_message_at ? new Date(customer.last_message_at).toLocaleDateString() : 'Never'
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `customers-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('‚úÖ Customer list exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('‚ùå Failed to export customers', 'error');
            }
        }

        async function createCheckoutSession(planId) {
            const email = document.getElementById('billingEmail').value;
            
            if (!email || !email.includes('@')) {
                showAlert('‚ùå Please enter a valid email address first', 'error');
                return;
            }

            localStorage.setItem('userEmail', email);

            try {
                showAlert('‚è≥ Creating checkout session...', 'success');
                
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, planId }),
                });

                const data = await response.json();
                
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    showAlert('‚ùå ' + (data.error || 'Failed to create checkout session'), 'error');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showAlert('‚ùå Failed to start checkout process', 'error');
            }
        }

        async function checkSubscriptionStatus() {
            const email = document.getElementById('billingEmail').value;
            
            if (!email || !email.includes('@')) {
                document.getElementById('currentPlanInfo').innerHTML = '<p style="color: #999;">Enter your email to check subscription status</p>';
                document.getElementById('usageMeter').style.display = 'none';
                document.getElementById('portalButtonContainer').style.display = 'none';
                return;
            }

            localStorage.setItem('userEmail', email);

            try {
                const response = await fetch(`/api/subscription-status?email=${encodeURIComponent(email)}`);
                const data = await response.json();
                
                let statusHTML = '';
                if (data.subscription_status === 'active') {
                    statusHTML = `
                        <div style="padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 5px;">
                            <p style="margin: 0 0 10px 0; color: #155724; font-weight: bold;">‚úÖ Active Subscription</p>
                            <p style="margin: 0; color: #155724;"><strong>Plan:</strong> ${data.plan.toUpperCase()}</p>
                        </div>
                    `;
                    document.getElementById('portalButtonContainer').style.display = 'block';
                } else if (data.subscription_status === 'trial') {
                    statusHTML = `
                        <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                            <p style="margin: 0 0 10px 0; color: #856404; font-weight: bold;">üéÅ Trial Account</p>
                            <p style="margin: 5px 0 0 0; color: #856404; font-size: 14px;">Subscribe below to get more SMS credits!</p>
                        </div>
                    `;
                    document.getElementById('portalButtonContainer').style.display = 'none';
                } else {
                    statusHTML = `
                        <div style="padding: 15px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 5px;">
                            <p style="margin: 0; color: #721c24; font-weight: bold;">‚ùå No Active Subscription</p>
                            <p style="margin: 5px 0 0 0; color: #721c24; font-size: 14px;">Subscribe below to start sending SMS messages!</p>
                        </div>
                    `;
                    document.getElementById('portalButtonContainer').style.display = 'none';
                }
                
                document.getElementById('currentPlanInfo').innerHTML = statusHTML;
                
                if (data.subscription_status !== 'none') {
                    const usagePercentage = data.usage_percentage || 0;
                    document.getElementById('usageMeter').style.display = 'block';
                    document.getElementById('usageText').textContent = `${data.sms_sent} / ${data.sms_quota} (${usagePercentage}%)`;
                    document.getElementById('usageBar').style.width = `${usagePercentage}%`;
                    
                    const warningDiv = document.getElementById('usageWarning');
                    if (data.warning_level === 'critical') {
                        warningDiv.style.display = 'block';
                        warningDiv.style.background = '#f8d7da';
                        warningDiv.style.color = '#721c24';
                        warningDiv.innerHTML = `<strong>‚ö†Ô∏è Critical:</strong> You've used ${usagePercentage}% of your quota. Only ${data.remaining} messages left! Consider upgrading.`;
                    } else if (data.warning_level === 'high') {
                        warningDiv.style.display = 'block';
                        warningDiv.style.background = '#fff3cd';
                        warningDiv.style.color = '#856404';
                        warningDiv.innerHTML = `<strong>‚ö†Ô∏è Warning:</strong> You've used ${usagePercentage}% of your quota. ${data.remaining} messages remaining.`;
                    } else {
                        warningDiv.style.display = 'none';
                    }
                } else {
                    document.getElementById('usageMeter').style.display = 'none';
                }
            } catch (error) {
                console.error('Subscription status error:', error);
                document.getElementById('currentPlanInfo').innerHTML = '<p style="color: #dc3545;">Error loading subscription status</p>';
            }
        }

        async function openCustomerPortal() {
            const email = localStorage.getItem('userEmail');
            if (!email) {
                showAlert('‚ùå Please enter your email first', 'error');
                return;
            }

            try {
                const response = await fetch('/api/create-portal-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    showAlert('‚ùå ' + (data.error || 'Failed to open billing portal'), 'error');
                }
            } catch (error) {
                console.error('Portal error:', error);
                showAlert('‚ùå Failed to open billing portal', 'error');
            }
        }

        function loadBillingTab() {
            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail) {
                document.getElementById('billingEmail').value = savedEmail;
                checkSubscriptionStatus();
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('session_id')) {
                showAlert('‚úÖ Subscription successful! Your account is now active.', 'success');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>
