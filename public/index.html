<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Request Manager - Repair Service</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .message-card, .customer-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .message-header, .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-name, .customer-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .message-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .message-type.review {
            background: #d4edda;
            color: #155724;
        }

        .message-type.ready {
            background: #d1ecf1;
            color: #0c5460;
        }

        .message-time, .customer-info {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
        }

        .customer-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 14px;
        }

        .customer-phone {
            font-family: monospace;
            background: #e0e0e0;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .customer-select-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .customer-select-btn:hover {
            background: #5568d3;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .helper-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 25px;
        }

        .info-box h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .file-upload-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }

        .file-upload-label:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-upload-label.has-file {
            border-color: #667eea;
            background: #f0f4ff;
        }

        input[type="file"] {
            display: none;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .file-text {
            color: #666;
            font-size: 14px;
        }

        .preview-container {
            margin-top: 10px;
            display: none;
        }

        .preview-container.active {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 10px;
        }

        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .ocr-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
        }

        .ocr-section h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .ocr-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .ocr-upload-label:hover {
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .ocr-upload-label.processing {
            cursor: wait;
            opacity: 0.7;
        }

        .ocr-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .ocr-status.active {
            display: block;
        }

        .ocr-preview {
            margin-top: 15px;
            max-height: 150px;
            border-radius: 10px;
            display: none;
        }

        .ocr-preview.active {
            display: block;
        }

        .extracted-data {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: none;
        }

        .extracted-data.active {
            display: block;
        }

        .extracted-data-item {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .extracted-data-item strong {
            display: inline-block;
            width: 80px;
        }

        .export-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .template-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .template-section.active {
            display: block;
        }

        .template-section h4 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 15px;
        }

        .template-suggestion {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .use-template-btn {
            margin-top: 8px;
            padding: 6px 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .use-template-btn:hover {
            background: #5568d3;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            .header h1 {
                font-size: 24px;
            }

            .export-btn {
                padding: 8px 14px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“± Techy Miramar SMS Manager</h1>
            <p>Review requests, pickup notifications & customer management</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'send')">ðŸ“¤ Send SMS</button>
            <button class="tab" onclick="switchTab(event, 'dashboard')">ðŸ“Š Dashboard</button>
            <button class="tab" onclick="switchTab(event, 'history')">ðŸ“œ History</button>
            <button class="tab" onclick="switchTab(event, 'customers')">ðŸ‘¥ Customers</button>
        </div>

        <div id="alertBox" class="alert"></div>

        <div id="sendTab" class="tab-content active">

        <div class="ocr-section">
            <h3>ðŸ“¸ Quick Fill from Repair Order (Optional)</h3>
            <p style="font-size: 14px; margin-bottom: 15px; opacity: 0.9;">Upload a photo of your repair order to automatically extract customer information</p>
            
            <input 
                type="file" 
                id="ocrPhoto" 
                accept="image/*"
                style="display: none;"
            />
            <label for="ocrPhoto" class="ocr-upload-label" id="ocrUploadLabel">
                <span class="file-icon">ðŸ“„</span>
                <span id="ocrUploadText">Click to upload repair order photo</span>
            </label>
            
            <img id="ocrPreview" class="ocr-preview" alt="Repair order preview" />
            
            <div class="ocr-status" id="ocrStatus"></div>
            
            <div class="extracted-data" id="extractedData">
                <div class="extracted-data-item">
                    <strong>Name:</strong> <span id="extractedName">-</span>
                </div>
                <div class="extracted-data-item">
                    <strong>Phone:</strong> <span id="extractedPhone">-</span>
                </div>
                <div class="extracted-data-item">
                    <strong>Device:</strong> <span id="extractedDevice">-</span>
                </div>
                <div class="extracted-data-item">
                    <strong>Repair:</strong> <span id="extractedRepair">-</span>
                </div>
            </div>
        </div>

        <div class="template-section" id="templateSection">
            <h4>ðŸ’¡ Smart Template Suggestions</h4>
            <div id="templateSuggestions"></div>
        </div>

        <form id="reviewForm">
            <div class="form-group">
                <label for="messageType">Message Type *</label>
                <select id="messageType" name="messageType" required>
                    <option value="review">ðŸŒŸ Google Review Request</option>
                    <option value="ready">âœ… Device Ready for Pickup</option>
                </select>
            </div>

            <div class="form-group">
                <label for="customerName">Customer Name *</label>
                <input 
                    type="text" 
                    id="customerName" 
                    name="customerName" 
                    placeholder="e.g., John Smith" 
                    required
                />
            </div>

            <div class="form-group">
                <label for="customerPhone">Customer Phone Number *</label>
                <input 
                    type="tel" 
                    id="customerPhone" 
                    name="customerPhone" 
                    placeholder="e.g., +1234567890 or +44 20 7123 4567" 
                    required
                />
                <div class="helper-text">Include country code (e.g., +1 for US, +44 for UK). Spaces and dashes OK.</div>
            </div>

            <div class="form-group" id="reviewLinkGroup">
                <label for="googleReviewLink">Google Review Link</label>
                <input 
                    type="url" 
                    id="googleReviewLink" 
                    name="googleReviewLink" 
                    value="https://g.page/r/CXmh-C0UxHgqEBM/review"
                    readonly
                />
                <div class="helper-text">Your Techy Miramar Google review link</div>
            </div>

            <div class="form-group">
                <label for="additionalInfo">Additional Message (Optional)</label>
                <textarea 
                    id="additionalInfo" 
                    name="additionalInfo" 
                    placeholder="Add any specific notes about the repair or service..."
                ></textarea>
                <div class="helper-text" id="additionalInfoHelper">Personalize the message with repair details</div>
            </div>

            <div class="form-group">
                <label for="photo">Attach Photo of Repair (Optional)</label>
                <div class="file-upload-wrapper">
                    <input 
                        type="file" 
                        id="photo" 
                        name="photo" 
                        accept="image/jpeg,image/png,image/gif,application/pdf"
                    />
                    <label for="photo" class="file-upload-label" id="fileLabel">
                        <span class="file-icon">ðŸ“Ž</span>
                        <span class="file-text" id="fileText">Click to upload before/after photo</span>
                    </label>
                </div>
                <div class="helper-text">Images (JPEG, PNG, GIF) or PDF up to 5MB</div>
                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" class="preview-image" alt="Preview" />
                </div>
            </div>

            <button type="submit" class="btn" id="submitBtn">
                Send Review Request
            </button>
        </form>
        </div>

        <div id="dashboardTab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">ðŸ“Š Dashboard</h2>
            <div class="stats-grid" id="statsGrid"></div>
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Recent Messages</h3>
            <div id="recentMessages"></div>
        </div>

        <div id="historyTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; margin: 0;">ðŸ“œ Message History</h2>
                <button onclick="exportMessagesToCSV()" class="export-btn">ðŸ“¥ Export to CSV</button>
            </div>
            <div class="search-box">
                <input 
                    type="text" 
                    id="historySearch" 
                    placeholder="ðŸ” Search by customer name, phone, or message type..."
                    onkeyup="filterHistory()"
                    style="margin-bottom: 20px;"
                />
            </div>
            <div id="messageHistory"></div>
        </div>

        <div id="customersTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; margin: 0;">ðŸ‘¥ Customer Database</h2>
                <button onclick="exportCustomersToCSV()" class="export-btn">ðŸ“¥ Export to CSV</button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">Click on a customer to auto-fill their information in the send form</p>
            <div class="search-box">
                <input 
                    type="text" 
                    id="customerSearch" 
                    placeholder="ðŸ” Search by name or phone number..."
                    onkeyup="filterCustomers()"
                    style="margin-bottom: 20px;"
                />
            </div>
            <div id="customerList"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('reviewForm');
        const alertBox = document.getElementById('alertBox');
        const submitBtn = document.getElementById('submitBtn');
        const photoInput = document.getElementById('photo');
        const fileLabel = document.getElementById('fileLabel');
        const fileText = document.getElementById('fileText');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const messageTypeSelect = document.getElementById('messageType');
        const reviewLinkGroup = document.getElementById('reviewLinkGroup');
        const additionalInfoHelper = document.getElementById('additionalInfoHelper');
        const ocrPhotoInput = document.getElementById('ocrPhoto');
        const ocrUploadLabel = document.getElementById('ocrUploadLabel');
        const ocrUploadText = document.getElementById('ocrUploadText');
        const ocrPreview = document.getElementById('ocrPreview');
        const ocrStatus = document.getElementById('ocrStatus');
        const extractedData = document.getElementById('extractedData');
        const extractedName = document.getElementById('extractedName');
        const extractedPhone = document.getElementById('extractedPhone');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');

        function updateFormForMessageType() {
            const messageType = messageTypeSelect.value;
            if (messageType === 'review') {
                reviewLinkGroup.style.display = 'block';
                submitBtn.textContent = 'Send Review Request';
                additionalInfoHelper.textContent = 'Personalize the message with repair details';
            } else {
                reviewLinkGroup.style.display = 'none';
                submitBtn.textContent = 'Send Pickup Notification';
                additionalInfoHelper.textContent = 'Add pickup instructions or location details';
            }
        }

        messageTypeSelect.addEventListener('change', updateFormForMessageType);

        updateFormForMessageType();

        function parseTextForCustomerInfo(text) {
            const lines = text.split('\n').map(line => line.trim());
            let name = '';
            let phone = '';
            let device = '';
            let repair = '';

            const phoneRegex = /[\+\(]?[1-9]\d{0,2}[\s\-\.]?\(?\d{2,3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{4}/g;
            const phoneMatches = text.match(phoneRegex);
            if (phoneMatches && phoneMatches.length > 0) {
                phone = phoneMatches[0].replace(/[\s\-\(\)\.]/g, '');
                if (!phone.startsWith('+')) {
                    if (phone.length === 10) {
                        phone = '+1' + phone;
                    } else if (phone.length === 11 && phone.startsWith('1')) {
                        phone = '+' + phone;
                    } else {
                        phone = '+' + phone;
                    }
                }
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.match(/customer\s+information/i)) {
                    for (let j = i + 1; j < Math.min(i + 5, lines.length); j++) {
                        const nextLine = lines[j];
                        if (nextLine && nextLine.length > 2 && nextLine.length < 50 && !nextLine.match(/mobile|store|credits|edit/i)) {
                            const words = nextLine.split(/\s+/);
                            if (words.length >= 2 && words.length <= 5) {
                                const possibleName = words.filter(w => w.length > 1 && !w.match(/^\d+$/) && !w.match(/^[\+\(\)]/)).join(' ');
                                if (possibleName.length > 3) {
                                    name = possibleName;
                                    break;
                                }
                            }
                        }
                    }
                }

                if (!name && line.length > 3 && line.length < 50 && line.match(/^[A-Z][A-Z\s]+$/)) {
                    const words = line.split(/\s+/);
                    if (words.length >= 2 && words.length <= 5 && !line.match(/CUSTOMER|INFORMATION|SERVICE|REPAIR|DEVICE|STORE|MOBILE|CREDITS/)) {
                        name = line;
                    }
                }

                if (line.match(/service\s+information/i)) {
                    for (let j = i + 1; j < Math.min(i + 10, lines.length); j++) {
                        const nextLine = lines[j];
                        
                        if (nextLine.match(/(computer|cellphone|laptop|tablet|pc)\s+repairs\s*-/i)) {
                            const deviceMatch = nextLine.match(/repairs\s*-\s*(.+)/i);
                            if (deviceMatch) {
                                const parts = deviceMatch[1].trim().split(/\s*-\s*/);
                                device = parts.length > 1 ? parts.slice(1).join(' - ') : parts[0];
                            }
                        }
                        
                        if (nextLine.match(/device\s+issue:/i)) {
                            const issueMatch = nextLine.match(/device\s+issue:\s*(.+)/i);
                            if (issueMatch) {
                                repair = issueMatch[1].trim();
                            }
                        }
                    }
                }
            }

            return { name: name.trim(), phone: phone, device: device.trim(), repair: repair.trim() };
        }

        ocrPhotoInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            ocrUploadLabel.classList.add('processing');
            ocrUploadText.textContent = 'Processing...';
            ocrStatus.textContent = 'â³ Scanning image and extracting text...';
            ocrStatus.classList.add('active');

            const reader = new FileReader();
            reader.onload = async function(e) {
                ocrPreview.src = e.target.result;
                ocrPreview.classList.add('active');

                try {
                    const worker = await Tesseract.createWorker('eng');
                    const { data: { text } } = await worker.recognize(e.target.result);
                    await worker.terminate();

                    console.log('Extracted text:', text);

                    document.getElementById('templateSection').classList.remove('active');
                    document.getElementById('templateSuggestions').innerHTML = '';

                    const customerInfo = parseTextForCustomerInfo(text);
                    
                    extractedName.textContent = customerInfo.name || 'Not found';
                    extractedPhone.textContent = customerInfo.phone || 'Not found';
                    document.getElementById('extractedDevice').textContent = customerInfo.device || 'Not found';
                    document.getElementById('extractedRepair').textContent = customerInfo.repair || 'Not found';
                    extractedData.classList.add('active');

                    if (customerInfo.name) {
                        customerNameInput.value = customerInfo.name;
                    }
                    if (customerInfo.phone) {
                        customerPhoneInput.value = customerInfo.phone;
                    }

                    if (customerInfo.device && customerInfo.repair) {
                        generateTemplateSuggestions(customerInfo.device, customerInfo.repair, customerInfo.name);
                    }

                    if (customerInfo.name || customerInfo.phone) {
                        ocrStatus.textContent = 'âœ… Customer information extracted! You can edit the fields below if needed.';
                    } else {
                        ocrStatus.textContent = 'âš ï¸ Could not extract customer info. Please enter manually below.';
                    }
                } catch (error) {
                    console.error('OCR Error:', error);
                    ocrStatus.textContent = 'âŒ Error processing image. Please enter information manually.';
                }

                ocrUploadLabel.classList.remove('processing');
                ocrUploadText.textContent = file.name;
            };
            reader.readAsDataURL(file);
        });

        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileLabel.classList.add('has-file');
                fileText.textContent = file.name;
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewContainer.classList.add('active');
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.remove('active');
                }
            } else {
                fileLabel.classList.remove('has-file');
                fileText.textContent = 'Click to upload before/after photo';
                previewContainer.classList.remove('active');
            }
        });

        function showAlert(message, type) {
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const messageType = messageTypeSelect.value;
            const googleReviewLink = document.getElementById('googleReviewLink').value.trim();
            const additionalInfo = document.getElementById('additionalInfo').value.trim();
            const photoFile = photoInput.files[0];

            if (!customerName || !customerPhone) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const formData = new FormData();
                formData.append('customerName', customerName);
                formData.append('customerPhone', customerPhone);
                formData.append('messageType', messageType);
                if (messageType === 'review' && googleReviewLink) formData.append('googleReviewLink', googleReviewLink);
                if (additionalInfo) formData.append('additionalInfo', additionalInfo);
                if (photoFile) formData.append('photo', photoFile);

                const response = await fetch('/api/send-review-request', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    let successMsg = messageType === 'ready' 
                        ? `âœ… Pickup notification sent successfully to ${customerName}!`
                        : `âœ… Review request sent successfully to ${customerName}!`;
                    if (data.photoAttached) {
                        successMsg += ' (Photo included)';
                    }
                    showAlert(successMsg, 'success');
                    form.reset();
                    fileLabel.classList.remove('has-file');
                    fileText.textContent = 'Click to upload before/after photo';
                    previewContainer.classList.remove('active');
                    updateFormForMessageType();
                } else {
                    showAlert(`âŒ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert('âŒ Failed to send request. Please try again.', 'error');
                console.error('Error:', error);
            } finally {
                submitBtn.disabled = false;
                updateFormForMessageType();
            }
        });

        function switchTab(e, tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'customers') {
                loadCustomers();
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    const statsGrid = document.getElementById('statsGrid');
                    
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${stats.totalMessages}</div>
                            <div class="stat-label">Total Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.totalCustomers}</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.todayMessages}</div>
                            <div class="stat-label">Today's Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.weekMessages}</div>
                            <div class="stat-label">This Week</div>
                        </div>
                    `;

                    const recentMessages = document.getElementById('recentMessages');
                    if (stats.recentMessages.length === 0) {
                        recentMessages.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“­</div><p>No messages sent yet</p></div>';
                    } else {
                        recentMessages.innerHTML = stats.recentMessages.map(msg => `
                            <div class="message-card">
                                <div class="message-header">
                                    <span class="message-name">${msg.customer_name}</span>
                                    <span class="message-type ${msg.message_type}">
                                        ${msg.message_type === 'review' ? 'ðŸŒŸ Review' : 'âœ… Pickup'}
                                    </span>
                                </div>
                                <div class="message-time">${new Date(msg.sent_at).toLocaleString()}</div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                
                if (data.success) {
                    const messageHistory = document.getElementById('messageHistory');
                    
                    if (data.messages.length === 0) {
                        messageHistory.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“­</div><p>No message history yet. Send your first message!</p></div>';
                    } else {
                        messageHistory.innerHTML = data.messages.map(msg => `
                            <div class="message-card">
                                <div class="message-header">
                                    <span class="message-name">${msg.customer_name}</span>
                                    <span class="message-type ${msg.message_type}">
                                        ${msg.message_type === 'review' ? 'ðŸŒŸ Review Request' : 'âœ… Device Ready'}
                                    </span>
                                </div>
                                <div class="message-time">
                                    ðŸ“ž ${msg.customer_phone} | ðŸ“… ${new Date(msg.sent_at).toLocaleString()}
                                </div>
                                ${msg.additional_info ? `<div style="margin-top: 10px; color: #666; font-size: 14px;">${msg.additional_info}</div>` : ''}
                                ${msg.photo_path ? `<div style="margin-top: 10px; color: #667eea; font-size: 13px;">ðŸ“· Photo attached</div>` : ''}
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                const data = await response.json();
                
                if (data.success) {
                    const customerList = document.getElementById('customerList');
                    
                    if (data.customers.length === 0) {
                        customerList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ‘¥</div><p>No customers yet. Send your first message to add a customer!</p></div>';
                    } else {
                        customerList.innerHTML = data.customers.map(customer => `
                            <div class="customer-card">
                                <div class="customer-header">
                                    <span class="customer-name">${customer.name}</span>
                                    <span class="customer-phone">${customer.phone}</span>
                                </div>
                                <div class="customer-stats">
                                    <span>ðŸ’¬ ${customer.message_count} messages</span>
                                    ${customer.last_message_at ? `<span>ðŸ“… Last: ${new Date(customer.last_message_at).toLocaleDateString()}</span>` : ''}
                                </div>
                                <button class="customer-select-btn" onclick="selectCustomer('${customer.name}', '${customer.phone}')">
                                    Use in Send Form
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function selectCustomer(name, phone) {
            document.getElementById('customerName').value = name;
            document.getElementById('customerPhone').value = phone;
            
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('.tab[onclick*="send"]').classList.add('active');
            document.getElementById('sendTab').classList.add('active');
            showAlert(`âœ¨ Customer info loaded: ${name}`, 'success');
        }

        let allMessages = [];
        let allCustomers = [];

        function generateTemplateSuggestions(device, repair, customerName) {
            const templateSection = document.getElementById('templateSection');
            const templateSuggestions = document.getElementById('templateSuggestions');
            const additionalInfoField = document.getElementById('additionalInfo');
            
            const templates = {
                review: `We completed the ${repair} on your ${device}. Everything is working perfectly!`,
                pickup: `Your ${device} is ready! We successfully completed the ${repair}. You can pick it up at your convenience.`
            };

            templateSuggestions.innerHTML = `
                <div class="template-suggestion">
                    <strong>Review Request Template:</strong><br>
                    "${templates.review}"
                    <br>
                    <button class="use-template-btn" onclick="useTemplate('${templates.review.replace(/'/g, "\\'")}')">Use This</button>
                </div>
                <div class="template-suggestion">
                    <strong>Pickup Notification Template:</strong><br>
                    "${templates.pickup}"
                    <br>
                    <button class="use-template-btn" onclick="useTemplate('${templates.pickup.replace(/'/g, "\\'")}')">Use This</button>
                </div>
            `;
            
            templateSection.classList.add('active');
        }

        function useTemplate(template) {
            document.getElementById('additionalInfo').value = template;
            showAlert('âœ… Template added to your message!', 'success');
        }

        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const messageCards = document.querySelectorAll('#messageHistory .message-card');
            
            messageCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const customerCards = document.querySelectorAll('#customerList .customer-card');
            
            customerCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function exportMessagesToCSV() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                
                if (!data.success || data.messages.length === 0) {
                    showAlert('âš ï¸ No messages to export', 'error');
                    return;
                }

                const headers = ['Date', 'Customer Name', 'Phone', 'Message Type', 'Additional Info'];
                const rows = data.messages.map(msg => [
                    new Date(msg.sent_at).toLocaleString(),
                    msg.customer_name,
                    msg.customer_phone,
                    msg.message_type === 'review' ? 'Review Request' : 'Device Ready',
                    msg.additional_info || ''
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `message-history-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('âœ… Message history exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('âŒ Failed to export messages', 'error');
            }
        }

        async function exportCustomersToCSV() {
            try {
                const response = await fetch('/api/customers');
                const data = await response.json();
                
                if (!data.success || data.customers.length === 0) {
                    showAlert('âš ï¸ No customers to export', 'error');
                    return;
                }

                const headers = ['Name', 'Phone', 'Total Messages', 'Last Contact'];
                const rows = data.customers.map(customer => [
                    customer.name,
                    customer.phone,
                    customer.message_count,
                    customer.last_message_at ? new Date(customer.last_message_at).toLocaleDateString() : 'Never'
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `customers-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('âœ… Customer list exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('âŒ Failed to export customers', 'error');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });
    </script>
</body>
</html>
