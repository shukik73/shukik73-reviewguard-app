<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Review Manager ‚Äì Techy Miramar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì±</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <header class="border-b border-slate-200 bg-white shadow-sm">
    <div class="max-w-[1100px] mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-lg bg-gradient-to-tr from-indigo-500 to-indigo-600 flex items-center justify-center text-white font-semibold">
          TM
        </div>
        <div>
          <div id="header-branding" class="text-sm font-semibold text-slate-900">
            Loading...
          </div>
          <div class="text-xs text-slate-500">
            Reviews, pickup notifications & customer follow-ups
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <span class="hidden sm:inline text-sm text-slate-600">
          Logged in as <span id="user-display-name" class="font-medium">Loading...</span>
        </span>
        <button
          id="logout-btn"
          class="text-sm px-3 py-1.5 rounded-md border border-slate-200 text-slate-600 hover:bg-slate-50"
        >
          Logout
        </button>
      </div>
    </div>

    <nav class="border-t border-slate-200 bg-white">
      <div class="max-w-[1100px] mx-auto px-4">
        <div class="flex flex-wrap gap-2 sm:gap-3 overflow-x-auto py-2.5">
          <button
            data-section="send-sms"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-indigo-600 bg-indigo-50 font-medium"
          >
            üì§ <span>Send SMS</span>
          </button>
          <button
            data-section="dashboard"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-slate-600 hover:bg-slate-50"
          >
            üìä <span>Dashboard</span>
          </button>
          <button
            data-section="history"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-slate-600 hover:bg-slate-50"
          >
            üìú <span>History</span>
          </button>
          <button
            data-section="customers"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-slate-600 hover:bg-slate-50"
          >
            üë• <span>Customers</span>
          </button>
          <button
            data-section="reviews"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-slate-600 hover:bg-slate-50"
          >
            ü§ñ <span>AI Reviews</span>
          </button>
          <button
            data-section="billing"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-slate-600 hover:bg-slate-50"
          >
            üí≥ <span>Billing</span>
          </button>
          <button
            data-section="feedback"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-slate-600 hover:bg-slate-50"
          >
            üí¨ <span>Feedback</span>
          </button>
          <button
            data-section="settings"
            class="nav-tab inline-flex items-center gap-1 px-3 py-2 text-xs sm:text-sm rounded-md text-slate-600 hover:bg-slate-50"
          >
            ‚öôÔ∏è <span>Settings</span>
          </button>
        </div>
      </div>
    </nav>
  </header>

  <main class="max-w-[1100px] mx-auto px-4 py-5 space-y-5">

    <div id="notification-container" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md w-full px-4">
      <div id="notification-message" class="rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2">
        <span id="notification-icon"></span>
        <span id="notification-text"></span>
      </div>
    </div>

    <div id="sms-confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
      <div class="modal-backdrop absolute inset-0" id="modal-backdrop"></div>
      <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold text-slate-900 mb-4">Confirm SMS</h3>
        <div class="space-y-3 mb-6">
          <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
            <span class="text-2xl">üë§</span>
            <div>
              <div class="text-xs text-slate-500">Send to</div>
              <div class="font-semibold text-slate-900" id="modal-customer-name">-</div>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
            <span class="text-2xl">üì±</span>
            <div>
              <div class="text-xs text-slate-500">Phone number</div>
              <div class="font-semibold text-slate-900" id="modal-customer-phone">-</div>
            </div>
          </div>
          <div class="p-3 bg-slate-50 rounded-lg">
            <div class="text-xs text-slate-500 mb-2">Message preview</div>
            <div class="text-sm text-slate-700 leading-relaxed max-h-32 overflow-y-auto" id="modal-message-preview">-</div>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="modal-cancel-btn" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-4 rounded-lg transition-all">
            Cancel
          </button>
          <button id="modal-confirm-btn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-lg">
            ‚úì Confirm & Send
          </button>
        </div>
      </div>
    </div>

    <div id="camera-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 bg-black/80">
      <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-bold text-slate-900">Take Photo</h3>
          <button id="close-camera-btn" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
        </div>
        <video id="camera-video" autoplay playsinline class="w-full rounded-lg bg-slate-900"></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <p id="camera-error" class="hidden text-red-500 text-sm mt-2"></p>
        <button id="capture-photo-btn" class="mt-4 w-full inline-flex items-center justify-center gap-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-md px-3 py-2.5 shadow-sm hover:from-indigo-600 hover:to-indigo-700">
          üì∏ Capture Photo
        </button>
      </div>
    </div>

    <section id="send-sms" class="section">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-3">
        Send SMS
      </h1>

      <div class="grid gap-6 lg:grid-cols-3">
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
            <h2 class="text-sm font-medium text-slate-900 mb-1">
              Step 1 ‚Äì Get customer details
            </h2>
            <p class="text-xs text-slate-500 mb-3">
              Upload or take a photo of your repair order to auto-fill name & phone.
            </p>

            <div class="space-y-3">
              <label class="block">
                <span class="text-xs font-medium text-slate-700">Repair order photo</span>
                <div class="mt-1 flex flex-col items-center justify-center gap-2 border border-dashed border-slate-300 rounded-lg px-3 py-4 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/40 transition">
                  <span class="text-lg">üìÑ</span>
                  <span class="text-xs text-slate-600">
                    Click to upload repair order photo
                  </span>
                  <input type="file" id="ocr-upload" accept="image/*" class="hidden" />
                </div>
              </label>

              <button id="camera-btn" class="w-full inline-flex items-center justify-center gap-2 text-xs px-3 py-2 rounded-md border border-slate-200 text-slate-700 hover:bg-slate-50">
                üì∑ Take Photo
              </button>

              <div class="mt-3 rounded-md bg-slate-50 border border-slate-200 px-3 py-2 text-xs">
                <div class="font-medium mb-1 text-slate-700">
                  Detected from repair order
                </div>
                <div class="space-y-0.5 text-slate-600">
                  <p>Name: <span id="ocr-name" class="text-slate-400">-</span></p>
                  <p>Phone: <span id="ocr-phone" class="text-slate-400">-</span></p>
                  <p>Device: <span id="ocr-device" class="text-slate-400">-</span></p>
                  <p>Repair: <span id="ocr-repair" class="text-slate-400">-</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-4">
          <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4 space-y-4">
            <h2 class="text-sm font-medium text-slate-900">
              Step 2 ‚Äì Compose & send SMS
            </h2>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-3">
                <label class="block">
                  <span class="text-xs font-medium text-slate-700">
                    Message Type *
                  </span>
                  <select
                    id="message-type"
                    class="mt-1 block w-full text-sm rounded-md border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  >
                    <option value="review">‚≠ê Google Review Request</option>
                    <option value="ready">üîî Device Ready for Pickup</option>
                    <option value="follow_up">üîÅ Follow-Up / Check-In</option>
                    <option value="custom">üí¨ Custom Message</option>
                  </select>
                </label>

                <label class="block">
                  <span class="text-xs font-medium text-slate-700">
                    Recent Customers (Quick Select)
                  </span>
                  <input
                    type="text"
                    id="customer-search"
                    placeholder="Type to search recent customers"
                    class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  />
                  <p class="mt-1 text-[11px] text-slate-500">
                    Select a recent customer to auto-fill name and phone.
                  </p>
                </label>

                <label class="block">
                  <span class="text-xs font-medium text-slate-700">
                    Customer Name *
                  </span>
                  <input
                    type="text"
                    id="customer-name"
                    placeholder="John Doe"
                    class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  />
                </label>

                <label class="block">
                  <span class="text-xs font-medium text-slate-700">
                    Customer Phone Number *
                  </span>
                  <input
                    type="tel"
                    id="customer-phone"
                    placeholder="+1 305 555 1234"
                    class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  />
                  <p class="mt-1 text-[11px] text-slate-500">
                    Include country code (e.g., +1 for US). Spaces and dashes are OK.
                  </p>
                </label>

                <label class="block">
                  <span class="text-xs font-medium text-slate-700">Device</span>
                  <input
                    type="text"
                    id="device"
                    placeholder="iPhone 13 Pro"
                    class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  />
                </label>

                <label class="block">
                  <span class="text-xs font-medium text-slate-700">Repair Type</span>
                  <input
                    type="text"
                    id="repair"
                    placeholder="Screen replacement"
                    class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  />
                </label>

                <label class="block">
                  <span class="text-xs font-medium text-slate-700">
                    Custom Message (Optional)
                  </span>
                  <textarea
                    id="custom-message"
                    rows="3"
                    placeholder="Add any custom text here..."
                    class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  ></textarea>
                </label>
              </div>

              <div class="space-y-3">
                <div class="bg-slate-900 text-slate-50 rounded-lg p-4 text-sm shadow-sm">
                  <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">
                    Message preview
                  </div>
                  <div id="message-preview" class="bg-slate-800 rounded-md p-3 text-xs text-slate-300 min-h-[100px]">
                    Your message will appear here...
                  </div>
                  <p class="mt-3 text-[11px] text-slate-400">
                    Character count: <span id="char-count">0</span>/160
                  </p>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input
                      type="checkbox"
                      id="sms-consent-checkbox"
                      class="mt-0.5 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500"
                    />
                    <span class="text-xs text-slate-700">
                      <strong class="font-semibold text-amber-900">Required:</strong> 
                      I confirm this customer has consented to receive SMS updates from my business. 
                      <span class="text-slate-600">(TCPA Compliance)</span>
                    </span>
                  </label>
                </div>

                <button
                  id="send-sms-btn"
                  disabled
                  class="w-full inline-flex items-center justify-center gap-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-md px-3 py-2.5 shadow-sm hover:from-indigo-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  üì§ Send SMS
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="dashboard" class="section hidden">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-4">
        Dashboard
      </h1>

      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
          <p class="text-xs text-slate-500 mb-1">Total Messages</p>
          <p id="stat-total-messages" class="text-xl font-semibold text-slate-900">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
          <p class="text-xs text-slate-500 mb-1">Total Customers</p>
          <p id="stat-total-customers" class="text-xl font-semibold text-slate-900">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
          <p class="text-xs text-slate-500 mb-1">Last 24 Hours</p>
          <p id="stat-today" class="text-xl font-semibold text-slate-900">0</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
          <p class="text-xs text-slate-500 mb-1">This Week</p>
          <p id="stat-this-week" class="text-xl font-semibold text-slate-900">0</p>
        </div>
      </div>

      <div class="mt-5 bg-white rounded-lg shadow-sm border border-slate-100 p-4">
        <h2 class="text-sm font-medium text-slate-900 mb-3">Recent Activity</h2>
        <div id="recent-messages" class="divide-y divide-slate-100 text-sm">
          <p class="text-sm text-slate-500 text-center py-8">No messages yet</p>
        </div>
      </div>
    </section>

    <section id="history" class="section hidden">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-4">
        Message History
      </h1>

      <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
          <div class="text-sm text-slate-600 font-medium">
            Recent Messages
          </div>
          <div class="flex gap-2">
            <button class="text-xs px-3 py-1.5 rounded-md border border-slate-200 text-slate-700 hover:bg-slate-50">
              üì• Export to CSV
            </button>
            <input
              type="text"
              id="history-search"
              placeholder="Search by name or phone"
              class="text-xs rounded-md border border-slate-300 px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
        </div>

        <div class="mb-3">
          <label class="block text-xs font-medium text-slate-700 mb-1">Filter Messages</label>
          <select
            id="history-filter"
            class="block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option value="all">All Messages</option>
            <option value="clicked">Clicked Link</option>
            <option value="reviewed">Feedback Received</option>
            <option value="needs-followup">Needs Follow-up</option>
          </select>
        </div>

        <div id="history-list" class="divide-y divide-slate-100 text-sm">
          <p class="text-sm text-slate-500 text-center py-8">No messages in history</p>
        </div>
      </div>
    </section>

    <section id="customers" class="section hidden">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-4">
        Customer Database
      </h1>

      <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
          <div class="text-sm text-slate-600 font-medium">
            Click on a customer to auto-fill the send form
          </div>
          <div class="flex gap-2">
            <button class="text-xs px-3 py-1.5 rounded-md border border-slate-200 text-slate-700 hover:bg-slate-50">
              üì• Export to CSV
            </button>
            <input
              type="text"
              id="customers-search"
              placeholder="Search by name or phone"
              class="text-xs rounded-md border border-slate-300 px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
        </div>

        <div id="customers-list" class="divide-y divide-slate-100 text-sm">
          <p class="text-sm text-slate-500 text-center py-8">No customers yet</p>
        </div>
      </div>
    </section>

    <section id="reviews" class="section hidden">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-4">
        AI Review Reply Assistant
      </h1>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
          <h2 class="text-sm font-medium text-slate-900 mb-3">Enter Review Details</h2>
          <div class="space-y-3">
            <label class="block">
              <span class="text-xs font-medium text-slate-700">Customer Name</span>
              <input
                type="text"
                id="ai-customer-name"
                placeholder="e.g., John Smith"
                class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              />
            </label>

            <label class="block">
              <span class="text-xs font-medium text-slate-700">Star Rating</span>
              <select
                id="ai-star-rating"
                class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              >
                <option value="">Select rating...</option>
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars</option>
                <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars</option>
                <option value="2">‚≠ê‚≠ê 2 Stars</option>
                <option value="1">‚≠ê 1 Star</option>
              </select>
            </label>

            <label class="block">
              <span class="text-xs font-medium text-slate-700">Review Text</span>
              <textarea
                id="ai-review-text"
                rows="4"
                placeholder="Paste the customer's review here..."
                class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              ></textarea>
            </label>

            <button
              id="generate-reply-btn"
              onclick="generateAIReply()"
              class="w-full inline-flex items-center justify-center gap-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-md px-3 py-2.5 shadow-sm hover:from-indigo-600 hover:to-indigo-700"
            >
              ‚ú® Generate AI Reply
            </button>
          </div>
        </div>

        <div id="ai-reply-container" class="hidden bg-white rounded-lg shadow-sm border border-slate-100 p-4">
          <h2 class="text-sm font-medium text-slate-900 mb-3">Generated Reply</h2>
          <div class="bg-slate-50 rounded-lg p-4 text-sm text-slate-700">
            <p id="ai-reply-text"></p>
          </div>
          <button
            id="copy-reply-btn"
            class="mt-3 w-full inline-flex items-center justify-center gap-2 text-sm font-medium text-indigo-700 bg-indigo-50 rounded-md px-3 py-2 hover:bg-indigo-100"
          >
            üìã Copy to Clipboard
          </button>
        </div>
      </div>
    </section>

    <section id="billing" class="section hidden">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-4">
        Subscription & Billing
      </h1>

      <div class="grid gap-4 lg:grid-cols-3">
        <div class="lg:col-span-1 space-y-4">
          <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
            <h2 class="text-sm font-medium text-slate-900 mb-2">
              Current Plan & Usage
            </h2>
            <p id="billing-status" class="text-sm text-slate-600">
              Loading subscription status...
            </p>
          </div>
        </div>

        <div class="lg:col-span-2 grid gap-4 sm:grid-cols-2">
          <div id="starter-plan-card" class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
            <div class="text-xs font-semibold text-slate-500 uppercase mb-1">
              Starter
            </div>
            <div class="text-2xl font-semibold text-slate-900 mb-1">
              $49 <span class="text-sm text-slate-500">/ month</span>
            </div>
            <ul class="mt-3 space-y-1 text-xs text-slate-600">
              <li>‚úÖ 300 SMS per month</li>
              <li>‚úÖ Review tracking</li>
              <li>‚úÖ Automatic follow-ups</li>
              <li>‚úÖ Customer database</li>
              <li>‚úÖ OCR text extraction</li>
            </ul>
            <button id="subscribe-starter-btn" class="mt-4 w-full text-sm font-medium px-3 py-2 rounded-md border border-indigo-200 text-indigo-700 hover:bg-indigo-50">
              Subscribe to Starter
            </button>
          </div>

          <div id="pro-plan-card" class="bg-white rounded-lg shadow-sm border border-indigo-200 p-4 relative">
            <span class="absolute -top-2 right-3 text-[10px] font-semibold bg-indigo-600 text-white px-2 py-0.5 rounded-full">
              POPULAR
            </span>
            <div class="text-xs font-semibold text-slate-500 uppercase mb-1">
              Pro
            </div>
            <div class="text-2xl font-semibold text-slate-900 mb-1">
              $99 <span class="text-sm text-slate-500">/ month</span>
            </div>
            <ul class="mt-3 space-y-1 text-xs text-slate-600">
              <li>‚úÖ 1,000 SMS per month</li>
              <li>‚úÖ Review tracking</li>
              <li>‚úÖ Automatic follow-ups</li>
              <li>‚úÖ Customer database</li>
              <li>‚úÖ OCR text extraction</li>
              <li>‚úÖ Priority support</li>
            </ul>
            <button id="subscribe-pro-btn" class="mt-4 w-full text-sm font-medium px-3 py-2 rounded-md bg-gradient-to-r from-indigo-500 to-indigo-600 text-white hover:from-indigo-600 hover:to-indigo-700">
              Subscribe to Pro
            </button>
            <p class="mt-3 text-[11px] text-slate-500">
              Test mode: use card 4242 4242 4242 4242 with any future expiry & CVC.
            </p>
          </div>
        </div>
      </div>
    </section>

    <section id="feedback" class="section hidden">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-4">
        Customer Feedback Inbox
      </h1>

      <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4">
        <div id="feedback-list" class="divide-y divide-slate-100">
          <p class="text-sm text-slate-500 text-center py-8">No feedback received yet</p>
        </div>
      </div>
    </section>

    <section id="settings" class="section hidden">
      <h1 class="text-lg sm:text-xl font-semibold text-slate-900 mb-4">
        Settings
      </h1>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4 space-y-4">
          <h2 class="text-sm font-medium text-slate-900">Business Settings</h2>
          
          <label class="block">
            <span class="text-xs font-medium text-slate-700">Business Name</span>
            <input
              type="text"
              id="settings-business-name"
              placeholder="Your Business Name"
              class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </label>

          <label class="block">
            <span class="text-xs font-medium text-slate-700">Google Review Link</span>
            <input
              type="url"
              id="settings-review-link"
              placeholder="https://g.page/r/your-google-review-link"
              class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
            <p class="mt-1 text-[11px] text-slate-500">
              This link will be automatically added to all review requests.
            </p>
          </label>

          <label class="block">
            <span class="text-xs font-medium text-slate-700">SMS Template</span>
            <textarea
              id="settings-sms-template"
              rows="3"
              placeholder="Hi {name}, thanks for visiting {business}! Please review us here: {link}"
              class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            ></textarea>
          </label>

          <button
            id="save-settings-btn"
            class="inline-flex items-center gap-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-md px-4 py-2 shadow-sm hover:from-indigo-600 hover:to-indigo-700"
          >
            üíæ Save Settings
          </button>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-slate-100 p-4 space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-medium text-slate-900">Telegram Bot Integration</h2>
            <span id="telegram-status-badge" class="px-2 py-1 rounded-full text-[10px] font-medium bg-slate-100 text-slate-600">
              Not Configured
            </span>
          </div>

          <label class="block">
            <span class="text-xs font-medium text-slate-700">Bot Token</span>
            <input
              type="password"
              id="telegram-bot-token"
              placeholder="Enter your Telegram Bot Token from @BotFather"
              autocomplete="new-password"
              class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </label>

          <label class="block">
            <span class="text-xs font-medium text-slate-700">Chat ID</span>
            <input
              type="text"
              id="telegram-chat-id"
              placeholder="Your Telegram Chat ID"
              class="mt-1 block w-full text-sm rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </label>

          <div class="flex gap-2">
            <button
              id="save-telegram-btn"
              class="inline-flex items-center gap-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-md px-4 py-2 shadow-sm hover:from-indigo-600 hover:to-indigo-700"
            >
              üíæ Save Telegram Settings
            </button>
            <button
              id="test-telegram-btn"
              disabled
              class="inline-flex items-center gap-2 text-sm font-medium text-indigo-700 bg-indigo-50 rounded-md px-4 py-2 hover:bg-indigo-100 disabled:opacity-50"
            >
              üîî Send Test Message
            </button>
          </div>
          <button
            id="disconnect-telegram-btn"
            class="hidden text-sm text-red-600 hover:text-red-700"
          >
            Disconnect Telegram Bot
          </button>
        </div>
      </div>
    </section>

  </main>

  <script>
    const tabs = document.querySelectorAll('.nav-tab');
    const sections = document.querySelectorAll('.section');
    let businessName = 'Our Store';

    function showSection(id) {
      sections.forEach(sec => {
        sec.classList.toggle('hidden', sec.id !== id);
      });
      tabs.forEach(btn => {
        const isActive = btn.getAttribute('data-section') === id;
        btn.classList.toggle('bg-indigo-50', isActive);
        btn.classList.toggle('text-indigo-600', isActive);
        btn.classList.toggle('font-medium', isActive);
        btn.classList.toggle('text-slate-600', !isActive);
      });
      
      if (id === 'dashboard') loadDashboard();
      if (id === 'history') loadHistory();
      if (id === 'customers') loadCustomers();
      if (id === 'settings') { loadSettings(); loadTelegramConfig(); }
      if (id === 'billing') updateSubscriptionDisplay();
      if (id === 'feedback') loadFeedback();
      if (id === 'reviews') clearAIReviewForm();
    }

    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-section');
        showSection(id);
      });
    });

    let notificationTimeout;
    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      const messageDiv = document.getElementById('notification-message');
      const iconSpan = document.getElementById('notification-icon');
      const textSpan = document.getElementById('notification-text');
      
      if (notificationTimeout) clearTimeout(notificationTimeout);
      
      if (type === 'success') {
        iconSpan.textContent = '‚úì';
        messageDiv.className = 'rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2 bg-green-500';
      } else if (type === 'error') {
        iconSpan.textContent = '‚úï';
        messageDiv.className = 'rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2 bg-red-500';
      } else if (type === 'info') {
        iconSpan.textContent = '‚Ñπ';
        messageDiv.className = 'rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2 bg-blue-500';
      }
      
      textSpan.textContent = message;
      container.classList.remove('hidden');
      
      if (type === 'success') {
        notificationTimeout = setTimeout(() => {
          container.classList.add('hidden');
        }, 4000);
      }
    }

    async function loadDashboard() {
      try {
        const response = await fetch('/api/dashboard');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('stat-total-messages').textContent = data.stats.totalMessages || 0;
          document.getElementById('stat-total-customers').textContent = data.stats.totalCustomers || 0;
          document.getElementById('stat-today').textContent = data.stats.today || 0;
          document.getElementById('stat-this-week').textContent = data.stats.thisWeek || 0;
          
          const container = document.getElementById('recent-messages');
          if (data.recentMessages && data.recentMessages.length > 0) {
            container.innerHTML = data.recentMessages.map(msg => `
              <div class="py-3 flex items-start justify-between gap-3">
                <div>
                  <div class="font-medium text-slate-900">
                    ${msg.customer_name}
                    <span class="ml-1 text-xs rounded-full bg-indigo-50 text-indigo-700 px-2 py-0.5">${getMessageTypeLabel(msg.message_type)}</span>
                  </div>
                  <div class="text-xs text-slate-500">
                    üìû ${msg.customer_phone} ‚Ä¢ ${new Date(msg.sent_at).toLocaleString()}
                  </div>
                </div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<p class="text-sm text-slate-500 text-center py-8">No messages yet</p>';
          }
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    function getMessageTypeLabel(type) {
      const labels = {
        'review': '‚≠ê Review',
        'ready': 'üîî Pickup',
        'follow_up': 'üîÅ Follow-up',
        'custom': 'üí¨ Custom'
      };
      return labels[type] || type;
    }

    async function loadHistory() {
      try {
        const response = await fetch('/api/messages');
        const data = await response.json();
        
        const container = document.getElementById('history-list');
        const filterValue = document.getElementById('history-filter').value;
        
        let messages = data.success && data.messages ? data.messages : [];
        
        if (filterValue === 'clicked') {
          messages = messages.filter(m => m.review_link_clicked_at);
        } else if (filterValue === 'reviewed') {
          messages = messages.filter(m => m.feedback_rating);
        } else if (filterValue === 'needs-followup') {
          messages = messages.filter(m => m.review_link_clicked_at && !m.feedback_rating && !m.follow_up_sent_at);
        }
        
        if (messages.length > 0) {
          container.innerHTML = messages.map(msg => `
            <div class="py-3 flex items-start justify-between gap-3">
              <div>
                <div class="font-medium text-slate-900">
                  ${msg.customer_name}
                  <span class="ml-1 text-xs rounded-full bg-indigo-50 text-indigo-700 px-2 py-0.5">${getMessageTypeLabel(msg.message_type)}</span>
                  ${msg.review_link_clicked_at ? '<span class="ml-1 text-xs rounded-full bg-green-50 text-green-700 px-2 py-0.5">üëÜ Clicked</span>' : ''}
                  ${msg.feedback_rating ? `<span class="ml-1 text-xs rounded-full bg-amber-50 text-amber-700 px-2 py-0.5">${'‚≠ê'.repeat(msg.feedback_rating)}</span>` : ''}
                </div>
                <div class="text-xs text-slate-500">
                  üìû ${msg.customer_phone} ‚Ä¢ ${new Date(msg.sent_at).toLocaleString()}
                </div>
              </div>
              <div class="flex gap-2">
                ${msg.review_link_clicked_at && !msg.feedback_rating && !msg.follow_up_sent_at ? `
                  <button 
                    onclick="sendReminder(${msg.id}, '${msg.customer_name.replace(/'/g, "\\'")}', '${msg.customer_phone}', '${msg.review_link || ''}')"
                    class="px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700"
                  >
                    üîî Send Reminder
                  </button>
                ` : ''}
              </div>
            </div>
          `).join('');
        } else {
          const filterLabels = {
            all: 'No messages in history',
            clicked: 'No messages with clicked links',
            reviewed: 'No messages with feedback received',
            'needs-followup': 'No messages need follow-up at this time'
          };
          container.innerHTML = `<p class="text-sm text-slate-500 text-center py-8">${filterLabels[filterValue]}</p>`;
        }
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    function applyHistoryFilter() {
      loadHistory();
    }

    document.getElementById('history-filter').addEventListener('change', applyHistoryFilter);

    async function loadCustomers() {
      try {
        const response = await fetch('/api/customers');
        const data = await response.json();
        
        const container = document.getElementById('customers-list');
        if (data.success && data.customers && data.customers.length > 0) {
          container.innerHTML = data.customers.map(customer => `
            <div class="py-3 flex items-center justify-between gap-3">
              <div>
                <div class="font-medium text-slate-900">${customer.name}</div>
                <div class="text-xs text-slate-500">
                  üìû ${customer.phone} ‚Ä¢ üí¨ ${customer.message_count || 0} messages
                </div>
              </div>
              <button 
                onclick="loadCustomerData('${customer.name}', '${customer.phone}')"
                class="text-xs px-2.5 py-1 rounded-md border border-indigo-200 text-indigo-700 hover:bg-indigo-50"
              >
                Use in Send Form
              </button>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<p class="text-sm text-slate-500 text-center py-8">No customers yet</p>';
        }
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    function loadCustomerData(name, phone) {
      document.getElementById('customer-name').value = name;
      document.getElementById('customer-phone').value = phone;
      showSection('send-sms');
      showNotification('Customer data loaded!', 'success');
    }

    async function loadFeedback() {
      try {
        const response = await fetch('/api/feedback');
        const data = await response.json();
        
        const container = document.getElementById('feedback-list');
        if (data.success && data.feedback && data.feedback.length > 0) {
          container.innerHTML = data.feedback.map(fb => `
            <div class="py-3 ${fb.status === 'unread' ? 'border-l-4 border-l-amber-500 pl-3' : ''}">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-medium text-sm text-slate-900">${fb.customer_name}</span>
                    <span class="text-xs px-2 py-1 rounded-full ${fb.rating <= 3 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                      ${'‚≠ê'.repeat(fb.rating)} ${fb.rating} star${fb.rating !== 1 ? 's' : ''}
                    </span>
                    ${fb.status === 'unread' ? '<span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">New</span>' : ''}
                  </div>
                  <p class="text-xs text-slate-600">${fb.customer_phone}</p>
                  ${fb.feedback_text ? `<p class="text-sm text-slate-700 mt-2 p-3 bg-slate-50 rounded">"${fb.feedback_text}"</p>` : ''}
                  <p class="text-[11px] text-slate-500 mt-2">${new Date(fb.created_at).toLocaleString()}</p>
                </div>
                ${fb.status === 'unread' ? `
                  <button 
                    onclick="markFeedbackRead(${fb.id})"
                    class="px-3 py-1.5 text-xs bg-slate-600 text-white rounded hover:bg-slate-700"
                  >
                    Mark Read
                  </button>
                ` : ''}
              </div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<p class="text-sm text-slate-500 text-center py-8">No feedback received yet</p>';
        }
      } catch (error) {
        console.error('Error loading feedback:', error);
      }
    }

    async function markFeedbackRead(feedbackId) {
      try {
        const response = await fetch('/api/feedback/mark-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ feedbackId })
        });
        const data = await response.json();
        if (data.success) {
          loadFeedback();
          showNotification('Feedback marked as read', 'success');
        }
      } catch (error) {
        console.error('Error marking feedback as read:', error);
      }
    }

    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        const data = await response.json();
        
        if (data.success && data.settings) {
          document.getElementById('settings-business-name').value = data.settings.business_name || '';
          document.getElementById('settings-sms-template').value = data.settings.sms_template || 'Hi {name}, thanks for visiting {business}! Please review us here: {link}';
          document.getElementById('settings-review-link').value = data.settings.google_review_link || '';
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    async function saveSettings() {
      try {
        const businessNameVal = document.getElementById('settings-business-name').value;
        const smsTemplate = document.getElementById('settings-sms-template').value;
        const reviewLink = document.getElementById('settings-review-link').value;

        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            business_name: businessNameVal,
            sms_template: smsTemplate,
            google_review_link: reviewLink
          })
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Settings saved!', 'success');
          const headerBranding = document.getElementById('header-branding');
          if (headerBranding && businessNameVal) {
            headerBranding.textContent = `${businessNameVal} SMS Manager`;
          }
        } else {
          showNotification(data.error || 'Failed to save settings', 'error');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('Failed to save settings', 'error');
      }
    }

    async function loadTelegramConfig() {
      try {
        const response = await fetch('/api/settings/telegram');
        const data = await response.json();
        
        const statusBadge = document.getElementById('telegram-status-badge');
        const testBtn = document.getElementById('test-telegram-btn');
        const disconnectBtn = document.getElementById('disconnect-telegram-btn');
        const chatIdInput = document.getElementById('telegram-chat-id');
        const tokenInput = document.getElementById('telegram-bot-token');
        
        if (data.success && data.configured) {
          statusBadge.textContent = 'Connected';
          statusBadge.className = 'ml-auto px-2 py-1 rounded-full text-[10px] font-medium bg-green-100 text-green-700';
          testBtn.disabled = false;
          disconnectBtn.classList.remove('hidden');
          chatIdInput.value = data.config.chatId || '';
          tokenInput.placeholder = 'Bot token configured (hidden for security)';
        } else {
          statusBadge.textContent = 'Not Configured';
          statusBadge.className = 'ml-auto px-2 py-1 rounded-full text-[10px] font-medium bg-slate-100 text-slate-600';
          testBtn.disabled = true;
          disconnectBtn.classList.add('hidden');
          chatIdInput.value = '';
          tokenInput.placeholder = 'Enter your Telegram Bot Token from @BotFather';
        }
      } catch (error) {
        console.error('Error loading Telegram config:', error);
      }
    }

    async function saveTelegramConfig() {
      const botToken = document.getElementById('telegram-bot-token').value.trim();
      const chatId = document.getElementById('telegram-chat-id').value.trim();
      
      if (!botToken || !chatId) {
        showNotification('Please enter both Bot Token and Chat ID', 'error');
        return;
      }
      
      const saveBtn = document.getElementById('save-telegram-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        const response = await fetch('/api/settings/telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ botToken, chatId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Telegram connected successfully!', 'success');
          document.getElementById('telegram-bot-token').value = '';
          loadTelegramConfig();
        } else {
          showNotification(data.error || 'Failed to save Telegram settings', 'error');
        }
      } catch (error) {
        console.error('Error saving Telegram config:', error);
        showNotification('Failed to save Telegram settings', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Telegram Settings';
      }
    }

    async function testTelegramConnection() {
      const testBtn = document.getElementById('test-telegram-btn');
      testBtn.disabled = true;
      testBtn.textContent = 'Sending...';
      
      try {
        const response = await fetch('/api/settings/telegram/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Test message sent! Check your Telegram.', 'success');
        } else {
          showNotification(data.error || 'Failed to send test message', 'error');
        }
      } catch (error) {
        console.error('Error testing Telegram:', error);
        showNotification('Failed to send test message', 'error');
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'üîî Send Test Message';
      }
    }

    async function disconnectTelegram() {
      if (!confirm('Are you sure you want to disconnect your Telegram bot?')) return;
      
      try {
        const response = await fetch('/api/settings/telegram', { method: 'DELETE' });
        const data = await response.json();
        
        if (data.success) {
          showNotification('Telegram bot disconnected', 'success');
          loadTelegramConfig();
        } else {
          showNotification(data.error || 'Failed to disconnect Telegram', 'error');
        }
      } catch (error) {
        console.error('Error disconnecting Telegram:', error);
        showNotification('Failed to disconnect Telegram', 'error');
      }
    }

    async function sendReminder(messageId, customerName, customerPhone, reviewLink) {
      if (!confirm(`Send reminder to ${customerName}?`)) return;
      
      try {
        const response = await fetch('/api/send-reminder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messageId, customerName, customerPhone, reviewLink })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification(`Reminder sent to ${customerName}!`, 'success');
          loadHistory();
        } else {
          showNotification(data.error || 'Failed to send reminder', 'error');
        }
      } catch (error) {
        console.error('Error sending reminder:', error);
        showNotification('Failed to send reminder', 'error');
      }
    }

    function clearAIReviewForm() {
      document.getElementById('ai-customer-name').value = '';
      document.getElementById('ai-star-rating').value = '';
      document.getElementById('ai-review-text').value = '';
      document.getElementById('ai-reply-container').classList.add('hidden');
    }

    async function generateAIReply() {
      const customerName = document.getElementById('ai-customer-name').value.trim();
      const starRating = document.getElementById('ai-star-rating').value;
      const reviewText = document.getElementById('ai-review-text').value.trim();
      const generateBtn = document.getElementById('generate-reply-btn');

      if (!customerName || !starRating || !reviewText) {
        showNotification('Please fill in all fields', 'error');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.textContent = '‚è≥ Generating...';

      try {
        const response = await fetch('/api/generate-reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerName, starRating: parseInt(starRating), reviewText })
        });

        const data = await response.json();

        if (data.success && data.reply) {
          document.getElementById('ai-reply-text').textContent = data.reply;
          document.getElementById('ai-reply-container').classList.remove('hidden');
          showNotification('AI reply generated!', 'success');
        } else {
          showNotification(data.error || 'Failed to generate reply', 'error');
        }
      } catch (error) {
        console.error('Error generating AI reply:', error);
        showNotification('Failed to generate reply', 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '‚ú® Generate AI Reply';
      }
    }

    function copyReplyToClipboard() {
      const replyText = document.getElementById('ai-reply-text').textContent;
      navigator.clipboard.writeText(replyText).then(() => {
        showNotification('Copied to clipboard!', 'success');
      }).catch(() => {
        showNotification('Failed to copy', 'error');
      });
    }

    const messageTypeSelect = document.getElementById('message-type');
    const customerNameInput = document.getElementById('customer-name');
    const deviceInput = document.getElementById('device');
    const repairInput = document.getElementById('repair');
    const customMessageInput = document.getElementById('custom-message');
    const messagePreview = document.getElementById('message-preview');
    const charCount = document.getElementById('char-count');

    function updatePreview() {
      const type = messageTypeSelect.value;
      const name = customerNameInput.value || 'Customer';
      const device = deviceInput.value || 'device';
      const repair = repairInput.value || 'repair';
      const custom = customMessageInput.value;

      let message = '';

      if (type === 'review') {
        message = `Hi ${name}! Thank you for choosing ${businessName} for your ${device} ${repair}. How was your experience? Please rate us: [Feedback Link]`;
      } else if (type === 'ready') {
        message = `Hi ${name}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours. See you soon!`;
      } else if (type === 'follow_up') {
        message = `Hi ${name}! Just checking in on your ${device}. Is everything working well after the ${repair}? Let us know if you need anything!`;
      } else {
        message = custom || '';
      }

      if (custom && type !== 'custom') {
        message += '\n\n' + custom;
      }

      messagePreview.textContent = message || 'Your message will appear here...';
      charCount.textContent = message.length;
    }

    messageTypeSelect.addEventListener('change', updatePreview);
    customerNameInput.addEventListener('input', updatePreview);
    deviceInput.addEventListener('input', updatePreview);
    repairInput.addEventListener('input', updatePreview);
    customMessageInput.addEventListener('input', updatePreview);

    const smsConsentCheckbox = document.getElementById('sms-consent-checkbox');
    const sendSmsBtn = document.getElementById('send-sms-btn');

    smsConsentCheckbox.addEventListener('change', function() {
      sendSmsBtn.disabled = !this.checked;
    });

    sendSmsBtn.addEventListener('click', async () => {
      if (!smsConsentCheckbox.checked) {
        showNotification('Please confirm SMS consent before sending', 'error');
        return;
      }
      window.openSmsConfirmationModal();
    });

    async function sendSMS() {
      const customerName = customerNameInput.value;
      const customerPhone = document.getElementById('customer-phone').value;
      const messageType = messageTypeSelect.value;
      const device = deviceInput.value;
      const repair = repairInput.value;
      const customMessage = customMessageInput.value;

      if (!customerName || !customerPhone) {
        showNotification('Please enter customer name and phone number', 'error');
        return;
      }

      let additionalInfo = '';
      if (messageType === 'review') {
        additionalInfo = `Hi ${customerName}! Thank you for choosing ${businessName} for your ${device} ${repair}. How was your experience? Please rate us:`;
      } else if (messageType === 'ready') {
        additionalInfo = `Hi ${customerName}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours. See you soon!`;
      } else if (messageType === 'follow_up') {
        additionalInfo = `Hi ${customerName}! Just checking in on your ${device}. Is everything working well after the ${repair}? Let us know if you need anything!`;
      } else if (messageType === 'custom') {
        additionalInfo = customMessage;
      }

      if (customMessage && messageType !== 'custom') {
        additionalInfo += '\n\n' + customMessage;
      }

      sendSmsBtn.disabled = true;
      sendSmsBtn.textContent = 'üì§ Sending...';

      try {
        const formData = new FormData();
        formData.append('customerName', customerName);
        formData.append('customerPhone', customerPhone);
        formData.append('messageType', messageType);
        formData.append('additionalInfo', additionalInfo);
        formData.append('smsConsentConfirmed', 'true');

        const response = await fetch('/api/send-review-request', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          if (messageType === 'review') {
            showNotification('Feedback request sent! Customer will receive a link to rate their experience.', 'success');
          } else {
            showNotification('SMS sent successfully!', 'success');
          }
          
          customerNameInput.value = '';
          document.getElementById('customer-phone').value = '';
          deviceInput.value = '';
          repairInput.value = '';
          customMessageInput.value = '';
          smsConsentCheckbox.checked = false;
          sendSmsBtn.disabled = true;
          updatePreview();
        } else {
          showNotification('Error: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Error sending SMS:', error);
        showNotification('Failed to send SMS. Please try again.', 'error');
      } finally {
        sendSmsBtn.disabled = !smsConsentCheckbox.checked;
        sendSmsBtn.textContent = 'üì§ Send SMS';
      }
    }

    window.openSmsConfirmationModal = function() {
      const customerName = customerNameInput.value;
      const customerPhone = document.getElementById('customer-phone').value;
      const messageType = messageTypeSelect.value;
      const device = deviceInput.value;
      const repair = repairInput.value;
      const customMessage = customMessageInput.value;

      if (!customerName || !customerPhone) {
        showNotification('Please enter customer name and phone number', 'error');
        return;
      }

      let msgPreview = '';
      if (messageType === 'review') {
        msgPreview = `Hi ${customerName}! Thank you for choosing ${businessName} for your ${device} ${repair}. How was your experience? Please rate us:`;
      } else if (messageType === 'ready') {
        msgPreview = `Hi ${customerName}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours.`;
      } else if (messageType === 'follow_up') {
        msgPreview = `Hi ${customerName}! Just checking in on your ${device}. Is everything working well after the ${repair}?`;
      } else if (messageType === 'custom') {
        msgPreview = customMessage;
      }

      if (customMessage && messageType !== 'custom') {
        msgPreview += '\n\n' + customMessage;
      }

      document.getElementById('modal-customer-name').textContent = customerName;
      document.getElementById('modal-customer-phone').textContent = customerPhone;
      document.getElementById('modal-message-preview').textContent = msgPreview;

      document.getElementById('sms-confirmation-modal').classList.remove('hidden');
    };

    window.closeSmsConfirmationModal = function() {
      document.getElementById('sms-confirmation-modal').classList.add('hidden');
    };

    window.confirmAndSendSMS = async function() {
      window.closeSmsConfirmationModal();
      await sendSMS();
    };

    document.getElementById('modal-cancel-btn').addEventListener('click', window.closeSmsConfirmationModal);
    document.getElementById('modal-confirm-btn').addEventListener('click', window.confirmAndSendSMS);
    document.getElementById('modal-backdrop').addEventListener('click', window.closeSmsConfirmationModal);

    const ocrUploadInput = document.getElementById('ocr-upload');
    const ocrNameDisplay = document.getElementById('ocr-name');
    const ocrPhoneDisplay = document.getElementById('ocr-phone');
    const ocrDeviceDisplay = document.getElementById('ocr-device');
    const ocrRepairDisplay = document.getElementById('ocr-repair');

    ocrUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      ocrNameDisplay.textContent = 'Processing...';
      ocrPhoneDisplay.textContent = 'Processing...';
      ocrDeviceDisplay.textContent = 'Processing...';
      ocrRepairDisplay.textContent = 'Processing...';

      try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/ocr/process', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success && data.data) {
          ocrNameDisplay.textContent = data.data.customerName || '-';
          ocrPhoneDisplay.textContent = data.data.customerPhone || '-';
          ocrDeviceDisplay.textContent = data.data.device || '-';
          ocrRepairDisplay.textContent = data.data.repair || '-';

          if (data.data.customerName) customerNameInput.value = data.data.customerName;
          if (data.data.customerPhone) document.getElementById('customer-phone').value = data.data.customerPhone;
          if (data.data.device) deviceInput.value = data.data.device;
          if (data.data.repair) repairInput.value = data.data.repair;

          updatePreview();
          showNotification('Information extracted successfully!', 'success');
        } else {
          ocrNameDisplay.textContent = '-';
          ocrPhoneDisplay.textContent = '-';
          ocrDeviceDisplay.textContent = '-';
          ocrRepairDisplay.textContent = '-';
          showNotification('Error: ' + (data.error || 'Failed to process image'), 'error');
          ocrUploadInput.value = '';
        }
      } catch (error) {
        console.error('OCR upload error:', error);
        ocrNameDisplay.textContent = '-';
        ocrPhoneDisplay.textContent = '-';
        ocrDeviceDisplay.textContent = '-';
        ocrRepairDisplay.textContent = '-';
        showNotification('Failed to process image', 'error');
        ocrUploadInput.value = '';
      }
    });

    const cameraBtn = document.getElementById('camera-btn');
    const cameraModal = document.getElementById('camera-modal');
    const cameraVideo = document.getElementById('camera-video');
    const cameraCanvas = document.getElementById('camera-canvas');
    const capturePhotoBtn = document.getElementById('capture-photo-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');
    const cameraError = document.getElementById('camera-error');
    let cameraStream = null;

    cameraBtn.addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showNotification('Camera is not supported on this device', 'error');
          return;
        }

        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });

        cameraVideo.srcObject = cameraStream;
        cameraModal.classList.remove('hidden');
        cameraError.classList.add('hidden');
      } catch (error) {
        console.error('Camera access error:', error);
        showNotification('Failed to access camera. Please use the Upload button instead.', 'error');
      }
    });

    closeCameraBtn.addEventListener('click', () => {
      stopCamera();
      cameraModal.classList.add('hidden');
    });

    capturePhotoBtn.addEventListener('click', async () => {
      try {
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;

        const context = cameraCanvas.getContext('2d');
        context.drawImage(cameraVideo, 0, 0);

        cameraCanvas.toBlob(async (blob) => {
          if (!blob) {
            showNotification('Failed to capture photo', 'error');
            stopCamera();
            cameraModal.classList.add('hidden');
            return;
          }

          ocrNameDisplay.textContent = 'Processing...';
          ocrPhoneDisplay.textContent = 'Processing...';
          ocrDeviceDisplay.textContent = 'Processing...';
          ocrRepairDisplay.textContent = 'Processing...';

          try {
            const formData = new FormData();
            formData.append('image', blob, 'camera-photo.jpg');

            const response = await fetch('/api/ocr/process', {
              method: 'POST',
              body: formData
            });

            const data = await response.json();

            if (data.success && data.data) {
              ocrNameDisplay.textContent = data.data.customerName || '-';
              ocrPhoneDisplay.textContent = data.data.customerPhone || '-';
              ocrDeviceDisplay.textContent = data.data.device || '-';
              ocrRepairDisplay.textContent = data.data.repair || '-';

              if (data.data.customerName) customerNameInput.value = data.data.customerName;
              if (data.data.customerPhone) document.getElementById('customer-phone').value = data.data.customerPhone;
              if (data.data.device) deviceInput.value = data.data.device;
              if (data.data.repair) repairInput.value = data.data.repair;

              updatePreview();
              showNotification('Information extracted successfully!', 'success');
            } else {
              ocrNameDisplay.textContent = '-';
              ocrPhoneDisplay.textContent = '-';
              ocrDeviceDisplay.textContent = '-';
              ocrRepairDisplay.textContent = '-';
              showNotification('Error: ' + (data.error || 'Failed to process photo'), 'error');
            }
          } catch (error) {
            console.error('OCR processing error:', error);
            ocrNameDisplay.textContent = '-';
            ocrPhoneDisplay.textContent = '-';
            ocrDeviceDisplay.textContent = '-';
            ocrRepairDisplay.textContent = '-';
            showNotification('Failed to process photo', 'error');
          } finally {
            stopCamera();
            cameraModal.classList.add('hidden');
            cameraError.classList.add('hidden');
          }
        }, 'image/jpeg', 0.95);
      } catch (error) {
        console.error('Photo capture error:', error);
        showNotification('Failed to capture photo', 'error');
      }
    });

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        cameraVideo.srcObject = null;
      }
    }

    async function createCheckout(planId, button, originalText) {
      try {
        button.disabled = true;
        button.textContent = 'Creating checkout session...';

        const authResponse = await fetch('/api/auth/session');
        if (!authResponse.ok) {
          showNotification('Please log in to subscribe', 'error');
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        
        const authData = await authResponse.json();
        if (!authData.user?.email) {
          showNotification('Please log in to subscribe', 'error');
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: authData.user.email, planId: planId })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error(data.error || 'Failed to create checkout session');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        showNotification('Failed to start checkout', 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function updateSubscriptionDisplay() {
      try {
        const authResponse = await fetch('/api/auth/session');
        if (!authResponse.ok) return;
        
        const authData = await authResponse.json();
        if (!authData.user?.email) return;

        const response = await fetch(`/api/subscription-status?email=${encodeURIComponent(authData.user.email)}`);
        if (!response.ok) return;

        const data = await response.json();
        
        const starterCard = document.getElementById('starter-plan-card');
        const proCard = document.getElementById('pro-plan-card');
        const starterBtn = document.getElementById('subscribe-starter-btn');
        const proBtn = document.getElementById('subscribe-pro-btn');

        starterCard.classList.remove('border-green-500', 'border-2');
        proCard.classList.remove('border-green-500', 'border-2');
        starterCard.classList.add('border-slate-100');
        proCard.classList.add('border-indigo-200');

        if (data.subscription_status === 'active') {
          const planId = data.plan;
          
          if (planId === 'starter') {
            starterCard.classList.remove('border-slate-100');
            starterCard.classList.add('border-green-500', 'border-2');
            starterBtn.textContent = '‚úì Active Plan';
            starterBtn.disabled = true;
          } else if (planId === 'pro') {
            proCard.classList.remove('border-indigo-200');
            proCard.classList.add('border-green-500', 'border-2');
            proBtn.textContent = '‚úì Active Plan';
            proBtn.disabled = true;
          }
        }
      } catch (error) {
        console.error('Failed to fetch subscription status:', error);
      }
    }

    const subscribeStarterBtn = document.getElementById('subscribe-starter-btn');
    if (subscribeStarterBtn) {
      subscribeStarterBtn.addEventListener('click', function() {
        createCheckout('starter', this, 'Subscribe to Starter');
      });
    }

    const subscribeProBtn = document.getElementById('subscribe-pro-btn');
    if (subscribeProBtn) {
      subscribeProBtn.addEventListener('click', function() {
        createCheckout('pro', this, 'Subscribe to Pro');
      });
    }

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const data = await response.json();
          
          if (data.success) {
            window.location.href = '/login.html';
          } else {
            showNotification('Logout failed', 'error');
          }
        } catch (error) {
          console.error('Logout error:', error);
          showNotification('Logout failed', 'error');
        }
      });
    }

    const saveSettingsBtn = document.getElementById('save-settings-btn');
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', async function() {
        await saveSettings();
        loadUserOnPageLoad();
      });
    }

    const saveTelegramBtn = document.getElementById('save-telegram-btn');
    if (saveTelegramBtn) saveTelegramBtn.addEventListener('click', saveTelegramConfig);

    const testTelegramBtn = document.getElementById('test-telegram-btn');
    if (testTelegramBtn) testTelegramBtn.addEventListener('click', testTelegramConnection);

    const disconnectTelegramBtn = document.getElementById('disconnect-telegram-btn');
    if (disconnectTelegramBtn) disconnectTelegramBtn.addEventListener('click', disconnectTelegram);

    const copyReplyBtn = document.getElementById('copy-reply-btn');
    if (copyReplyBtn) copyReplyBtn.addEventListener('click', copyReplyToClipboard);

    async function loadUserOnPageLoad() {
      try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();
        
        if (data.success && data.user) {
          const user = data.user;
          
          const userDisplay = document.getElementById('user-display-name');
          if (userDisplay) userDisplay.textContent = user.first_name || 'User';
          
          businessName = user.business_name || 'Our Store';
          
          const headerBranding = document.getElementById('header-branding');
          if (headerBranding) {
            headerBranding.textContent = user.business_name ? `${user.business_name} SMS Manager` : 'SMS Manager';
          }
          
          updatePreview();
        }
      } catch (error) {
        console.error('Error loading user:', error);
        const headerBranding = document.getElementById('header-branding');
        if (headerBranding) headerBranding.textContent = 'SMS Manager';
      }
    }

    showSection('send-sms');
    loadUserOnPageLoad();
    updatePreview();
  </script>

</body>
</html>
