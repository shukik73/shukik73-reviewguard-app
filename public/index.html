<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ReviewGuard SMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="SMS Manager for repair shops - Turn paper receipts into 5-star Google Reviews" />
  <meta name="theme-color" content="#1e293b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ReviewGuard" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icons/icon-192x192.png" type="image/png" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sidebar: '#1e293b',
            'sidebar-hover': '#334155',
            'sidebar-active': '#6366f1',
            accent: '#6366f1',
          }
        }
      }
    }
  </script>
  <style>
    .modal-backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    .nav-item { transition: all 0.15s ease; }
    .nav-item:hover { background: #334155; }
    .nav-item.active { background: #6366f1; }
    .drag-area { transition: all 0.2s ease; }
    .drag-area.dragover { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
    .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <div class="flex min-h-screen">
    <aside class="w-56 bg-sidebar fixed h-screen flex flex-col z-40">
      <div class="p-5 border-b border-slate-700">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-accent flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <div>
            <div id="sidebar-brand" class="text-white font-semibold text-sm">ReviewGuard</div>
          </div>
        </div>
      </div>

      <nav class="flex-1 p-3 space-y-1">
        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider px-3 py-2">Main Menu</div>
        
        <button data-section="dashboard" class="nav-item active w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-white text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
          Dashboard
        </button>

        <button data-section="send-sms" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
          Send SMS
        </button>

        <button data-section="history" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          History
        </button>

        <button data-section="customers" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          Customers
        </button>

        <button data-section="reviews" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
          Reviews
        </button>

        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider px-3 py-2 mt-4">System</div>

        <button data-section="billing" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
          </svg>
          Billing
        </button>

        <button data-section="feedback" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          Feedback
        </button>

        <button data-section="settings" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Settings
        </button>
      </nav>

      <div class="p-4 border-t border-slate-700">
        <div class="flex items-center gap-3">
          <div id="user-avatar" class="w-9 h-9 rounded-full bg-accent flex items-center justify-center text-white text-sm font-semibold">
            U
          </div>
          <div class="flex-1 min-w-0">
            <div id="user-display-name" class="text-white text-sm font-medium truncate">Loading...</div>
            <div id="user-email" class="text-slate-400 text-xs truncate">user@example.com</div>
          </div>
          <button id="logout-btn" class="p-1.5 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition-colors" title="Sign Out">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
          </button>
        </div>
      </div>
    </aside>

    <main class="flex-1 ml-56">
      <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div class="flex items-center justify-between px-6 py-4">
          <div>
            <h1 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard</h1>
            <p id="page-subtitle" class="text-sm text-gray-500">Overview of your messaging and reviews.</p>
            <p id="header-branding" class="hidden"></p>
          </div>
          <button id="new-message-btn" class="inline-flex items-center gap-2 px-4 py-2.5 bg-accent hover:bg-indigo-600 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            New Message
          </button>
        </div>
      </header>

      <div id="notification-container" class="hidden fixed top-4 right-4 z-50 max-w-sm">
        <div id="notification-message" class="rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2">
          <span id="notification-icon"></span>
          <span id="notification-text"></span>
        </div>
      </div>

      <div id="sms-confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div class="modal-backdrop absolute inset-0" id="modal-backdrop"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Confirm SMS</h3>
          <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <span class="text-2xl">üë§</span>
              <div>
                <div class="text-xs text-gray-500">Send to</div>
                <div class="font-semibold text-gray-900" id="modal-customer-name">-</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <span class="text-2xl">üì±</span>
              <div>
                <div class="text-xs text-gray-500">Phone number</div>
                <div class="font-semibold text-gray-900" id="modal-customer-phone">-</div>
              </div>
            </div>
            <div class="p-3 bg-gray-50 rounded-lg">
              <div class="text-xs text-gray-500 mb-2">Message preview</div>
              <div class="text-sm text-gray-700 leading-relaxed max-h-32 overflow-y-auto" id="modal-message-preview">-</div>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="modal-cancel-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-all">
              Cancel
            </button>
            <button id="modal-confirm-btn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-lg">
              Confirm & Send
            </button>
          </div>
        </div>
      </div>

      <div id="camera-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 bg-black/80">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold text-gray-900">Take Photo</h3>
            <button id="close-camera-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          <video id="camera-video" autoplay playsinline class="w-full rounded-lg bg-gray-900"></video>
          <canvas id="camera-canvas" class="hidden"></canvas>
          <p id="camera-error" class="hidden text-red-500 text-sm mt-2"></p>
          <button id="capture-photo-btn" class="mt-4 w-full inline-flex items-center justify-center gap-2 text-sm font-medium text-white bg-accent rounded-lg px-4 py-3 hover:bg-indigo-600 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Capture Photo
          </button>
        </div>
      </div>

      <div class="p-6 space-y-6">

        <section id="dashboard" class="section">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                  </svg>
                </div>
              </div>
              <div id="stat-total-messages" class="text-3xl font-bold text-gray-900">0</div>
              <div class="text-sm text-gray-500">Total SMS Sent</div>
            </div>

            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                  </svg>
                </div>
              </div>
              <div id="stat-total-customers" class="text-3xl font-bold text-gray-900">0</div>
              <div class="text-sm text-gray-500">Total Customers</div>
            </div>

            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
              </div>
              <div id="stat-today" class="text-3xl font-bold text-gray-900">0</div>
              <div class="text-sm text-gray-500">Sent Today</div>
            </div>

            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                </div>
              </div>
              <div id="stat-this-week" class="text-3xl font-bold text-gray-900">0</div>
              <div class="text-sm text-gray-500">Sent This Week</div>
            </div>
          </div>

          <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white rounded-xl border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between p-5 border-b border-gray-100">
                <div>
                  <h3 class="font-semibold text-gray-900">Recent Activity</h3>
                  <p class="text-sm text-gray-500">Real-time updates from your shop</p>
                </div>
                <button onclick="loadDashboard()" class="text-sm text-accent hover:text-indigo-700 font-medium">View All</button>
              </div>
              <div id="recent-messages" class="divide-y divide-gray-50 p-2 max-h-80 overflow-y-auto">
                <div class="text-center py-12 text-gray-500">Loading...</div>
              </div>
            </div>

            <div class="rounded-xl p-6 text-white" style="background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 50%, #4F46E5 100%);">
              <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              </div>
              <h3 class="text-xl font-bold italic mb-1">Quick Send</h3>
              <p class="text-white/80 text-sm mb-5">Instantly reach a customer without leaving the dashboard.</p>
              
              <div class="space-y-4">
                <div>
                  <label class="text-xs font-semibold text-white/90 uppercase tracking-wide block mb-2">Phone Number</label>
                  <input type="tel" id="quick-phone" placeholder="+1 (555) 000-0000" class="w-full px-4 py-3 rounded-lg bg-white text-gray-900 placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-white/50" />
                </div>
                <div>
                  <label class="text-xs font-semibold text-white/90 uppercase tracking-wide block mb-2">Message</label>
                  <textarea id="quick-message" rows="3" placeholder="Your device is ready for pickup..." class="w-full px-4 py-3 rounded-lg bg-white text-gray-900 placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-white/50 resize-none"></textarea>
                </div>
                <button id="quick-send-btn" class="w-full py-2.5 bg-slate-900 hover:bg-slate-800 text-white font-medium rounded-full transition-colors text-sm flex items-center justify-center gap-2">
                  Send Notification
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="send-sms" class="section hidden">
          <div class="grid lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <div class="text-center mb-6">
                <div 
                  id="drop-zone"
                  class="drag-area border-2 border-dashed border-gray-300 rounded-xl p-10 cursor-pointer hover:border-accent transition-colors"
                >
                  <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                  </div>
                  <h3 class="font-semibold text-gray-900 mb-1">Drag & Drop Receipt</h3>
                  <p class="text-sm text-gray-500 mb-4">Supports JPG, HEIC, PNG</p>
                  <button id="browse-files-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    Browse Files
                  </button>
                  <input type="file" id="ocr-upload" accept="image/*" class="hidden" />
                </div>
              </div>

              <button id="camera-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors mb-4">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Take Photo with Camera
              </button>

              <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-blue-900">Privacy First</p>
                    <p class="text-xs text-blue-700">Receipts are processed securely by OpenAI and are discarded immediately after extraction.</p>
                  </div>
                </div>
              </div>

              <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Detected from Receipt</div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div><span class="text-gray-500">Name:</span> <span id="ocr-name" class="text-gray-900 font-medium">-</span></div>
                  <div><span class="text-gray-500">Phone:</span> <span id="ocr-phone" class="text-gray-900 font-medium">-</span></div>
                  <div><span class="text-gray-500">Device:</span> <span id="ocr-device" class="text-gray-900 font-medium">-</span></div>
                  <div><span class="text-gray-500">Repair:</span> <span id="ocr-repair" class="text-gray-900 font-medium">-</span></div>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <div class="flex items-center gap-2 mb-1">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <h3 class="font-semibold text-gray-900">Customer Profile</h3>
              </div>
              <p class="text-xs text-gray-500 mb-5">Editable ‚Ä¢ Review carefully</p>

              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Customer Name</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </span>
                    <input type="text" id="customer-name" placeholder="Identify from receipt..." class="w-full pl-9 pr-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Phone Number</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                    </span>
                    <input type="tel" id="customer-phone" placeholder="+1..." class="w-full pl-9 pr-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Device</label>
                    <input type="text" id="device" placeholder="Device Model" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                  <div>
                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Cost</label>
                    <input type="text" id="cost" placeholder="$0.00" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Repair Type</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      </svg>
                    </span>
                    <input type="text" id="repair" placeholder="Service description..." class="w-full pl-9 pr-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Message Type</label>
                  <select id="message-type" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent bg-white">
                    <option value="review">‚≠ê Google Review Request</option>
                    <option value="ready">üîî Device Ready for Pickup</option>
                    <option value="follow_up">üîÅ Follow-up Check-in</option>
                    <option value="custom">üí¨ Custom Message</option>
                  </select>
                </div>

                <div id="custom-message-container" class="hidden">
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Custom Message</label>
                  <textarea id="custom-message" rows="3" placeholder="Write your custom message..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent resize-none"></textarea>
                </div>

                <div class="bg-gray-50 rounded-lg p-3">
                  <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Message Preview</div>
                  <p id="message-preview" class="text-sm text-gray-700 leading-relaxed">Your message will appear here...</p>
                  <div class="text-xs text-gray-400 mt-2">Character count: <span id="char-count">0</span>/160</div>
                </div>

                <label class="flex items-start gap-3 p-3 bg-amber-50 border border-amber-200 rounded-lg cursor-pointer">
                  <input type="checkbox" id="sms-consent-checkbox" class="mt-0.5 rounded border-amber-300 text-amber-600 focus:ring-amber-500" />
                  <span class="text-xs text-amber-800">
                    <strong>Required:</strong> I confirm this customer has consented to receive SMS updates from my business. (TCPA Compliance)
                  </span>
                </label>

                <button id="send-sms-btn" disabled class="w-full py-3 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                  Save & Send Welcome SMS
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="history" class="section hidden">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between p-5 border-b border-gray-100">
              <div>
                <h3 class="font-semibold text-gray-900">Message History</h3>
                <p class="text-sm text-gray-500">Track all sent messages and follow-ups</p>
              </div>
              <select id="history-filter" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                <option value="all">All Messages</option>
                <option value="clicked">Clicked Links</option>
                <option value="reviewed">With Feedback</option>
                <option value="needs-followup">Needs Follow-up</option>
              </select>
            </div>
            <div id="history-list" class="divide-y divide-gray-50 max-h-[500px] overflow-y-auto p-2">
              <div class="text-center py-12 text-gray-500">Loading...</div>
            </div>
          </div>
        </section>

        <section id="customers" class="section hidden">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between p-5 border-b border-gray-100">
              <div>
                <h3 class="font-semibold text-gray-900">Customer Database</h3>
                <p class="text-sm text-gray-500">Manage your customer contacts</p>
              </div>
            </div>
            <div id="customers-list" class="divide-y divide-gray-50 max-h-[500px] overflow-y-auto p-2">
              <div class="text-center py-12 text-gray-500">Loading...</div>
            </div>
          </div>
        </section>

        <section id="reviews" class="section hidden">
          <div class="flex items-center justify-between mb-4">
            <div class="flex gap-2">
              <button class="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-lg">All</button>
              <button class="px-4 py-2 bg-white border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-50">Pending</button>
              <button class="px-4 py-2 bg-white border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-50">Intercepted</button>
            </div>
          </div>

          <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6 mb-6">
            <h3 class="font-semibold text-gray-900 mb-1">AI Review Reply Assistant</h3>
            <p class="text-sm text-gray-500 mb-4">Generate professional, SEO-optimized responses for Google Reviews</p>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Customer Name</label>
                  <input type="text" id="ai-customer-name" placeholder="Enter reviewer name..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Star Rating</label>
                  <select id="ai-star-rating" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent bg-white">
                    <option value="">Select rating...</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars</option>
                    <option value="2">‚≠ê‚≠ê 2 Stars</option>
                    <option value="1">‚≠ê 1 Star</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Review Text</label>
                  <textarea id="ai-review-text" rows="4" placeholder="Paste the customer's review text here..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent resize-none"></textarea>
                </div>
                <button id="generate-reply-btn" onclick="generateAIReply()" class="w-full py-3 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  Generate AI Reply
                </button>
              </div>

              <div id="ai-reply-container" class="hidden">
                <div class="bg-gray-900 rounded-xl p-5 h-full">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-green-400 uppercase tracking-wide">AI Drafted Response</span>
                    <div class="flex gap-2">
                      <button id="copy-reply-btn" class="p-1.5 rounded-lg bg-gray-700 text-gray-300 hover:text-white transition-colors" title="Copy to clipboard">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <p id="ai-reply-text" class="text-white text-sm leading-relaxed"></p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="billing" class="section hidden">
          <div class="grid md:grid-cols-2 gap-6">
            <div id="starter-plan-card" class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <h3 class="font-semibold text-gray-900 mb-1">Starter Plan</h3>
              <div class="flex items-baseline gap-1 mb-4">
                <span class="text-3xl font-bold text-gray-900">$29</span>
                <span class="text-gray-500">/month</span>
              </div>
              <ul class="space-y-2 mb-6 text-sm text-gray-600">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  500 SMS per month
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  OCR Receipt Scanning
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Review Link Tracking
                </li>
              </ul>
              <button id="subscribe-starter-btn" class="w-full py-2.5 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors">
                Subscribe to Starter
              </button>
            </div>

            <div id="pro-plan-card" class="bg-white rounded-xl border-2 border-accent shadow-sm p-6 relative">
              <span class="absolute -top-3 left-4 px-3 py-1 bg-accent text-white text-xs font-medium rounded-full">Popular</span>
              <h3 class="font-semibold text-gray-900 mb-1">Pro Plan</h3>
              <div class="flex items-baseline gap-1 mb-4">
                <span class="text-3xl font-bold text-gray-900">$79</span>
                <span class="text-gray-500">/month</span>
              </div>
              <ul class="space-y-2 mb-6 text-sm text-gray-600">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  2,000 SMS per month
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  AI Review Reply Assistant
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Telegram Bot Integration
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Priority Support
                </li>
              </ul>
              <button id="subscribe-pro-btn" class="w-full py-2.5 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors">
                Subscribe to Pro
              </button>
            </div>
          </div>
        </section>

        <section id="feedback" class="section hidden">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between p-5 border-b border-gray-100">
              <div>
                <h3 class="font-semibold text-gray-900">Feedback Inbox</h3>
                <p class="text-sm text-gray-500">Internal feedback from customers (1-3 star ratings)</p>
              </div>
            </div>
            <div id="feedback-list" class="divide-y divide-gray-50 max-h-[500px] overflow-y-auto p-2">
              <div class="text-center py-12 text-gray-500">Loading...</div>
            </div>
          </div>
        </section>

        <section id="settings" class="section hidden">
          <div class="grid lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <h3 class="font-semibold text-gray-900 mb-1">Business Settings</h3>
              <p class="text-sm text-gray-500 mb-5">Configure your business profile and SMS templates</p>

              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Business Name</label>
                  <input type="text" id="settings-business-name" placeholder="Your Business Name" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Google Review Link</label>
                  <input type="url" id="settings-review-link" placeholder="https://g.page/r/..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">SMS Template</label>
                  <textarea id="settings-sms-template" rows="3" placeholder="Hi {name}, thanks for visiting {business}! Please review us here: {link}" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent resize-none"></textarea>
                </div>
                <button id="save-settings-btn" class="w-full py-2.5 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors">
                  Save Settings
                </button>
              </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <div class="flex items-center justify-between mb-1">
                <h3 class="font-semibold text-gray-900">Telegram Bot</h3>
                <span id="telegram-status-badge" class="px-2 py-1 rounded-full text-[10px] font-medium bg-gray-100 text-gray-600">
                  Not Configured
                </span>
              </div>
              <p class="text-sm text-gray-500 mb-5">Connect your Telegram bot for review approval notifications</p>

              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Bot Token</label>
                  <input type="password" id="telegram-bot-token" placeholder="Enter your Telegram Bot Token from @BotFather" autocomplete="new-password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Chat ID</label>
                  <input type="text" id="telegram-chat-id" placeholder="Your Telegram Chat ID" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div class="flex gap-2">
                  <button id="save-telegram-btn" class="flex-1 py-2.5 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors">
                    Save Telegram Settings
                  </button>
                  <button id="test-telegram-btn" disabled class="px-4 py-2.5 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50">
                    Test
                  </button>
                </div>
                <button id="disconnect-telegram-btn" class="hidden w-full py-2 text-sm text-red-600 hover:text-red-700 font-medium">
                  Disconnect Telegram Bot
                </button>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <script>
    let businessName = 'Our Store';

    function showNotification(message, type = 'info') {
      const container = document.getElementById('notification-container');
      const messageEl = document.getElementById('notification-message');
      const textEl = document.getElementById('notification-text');
      const iconEl = document.getElementById('notification-icon');

      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-amber-500'
      };

      const icons = {
        success: '‚úì',
        error: '‚úï',
        info: '‚Ñπ',
        warning: '‚ö†'
      };

      messageEl.className = `rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2 ${colors[type] || colors.info}`;
      iconEl.textContent = icons[type] || icons.info;
      textEl.textContent = message;

      container.classList.remove('hidden');
      setTimeout(() => container.classList.add('hidden'), 4000);
    }

    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');
    const pageTitle = document.getElementById('page-title');
    const pageSubtitle = document.getElementById('page-subtitle');

    const pageTitles = {
      'dashboard': { title: 'Dashboard', subtitle: 'Overview of your messaging and reviews.' },
      'send-sms': { title: 'New Customer Onboarding', subtitle: 'Upload a receipt to auto-fill details. Review and correct AI data before saving.' },
      'history': { title: 'Message History', subtitle: 'Track all sent messages and customer interactions.' },
      'customers': { title: 'Customer Database', subtitle: 'Manage your customer contacts and profiles.' },
      'reviews': { title: 'Review Inbox', subtitle: 'Manage incoming reviews and approve AI responses.' },
      'billing': { title: 'Billing & Plans', subtitle: 'Manage your subscription and billing details.' },
      'feedback': { title: 'Feedback Inbox', subtitle: 'Internal feedback from customers requiring attention.' },
      'settings': { title: 'Settings', subtitle: 'Configure your business profile and integrations.' }
    };

    function showSection(sectionId) {
      sections.forEach(s => s.classList.add('hidden'));
      navItems.forEach(n => {
        n.classList.remove('active');
        n.classList.add('text-slate-300');
        n.classList.remove('text-white');
      });

      const targetSection = document.getElementById(sectionId);
      const targetNav = document.querySelector(`[data-section="${sectionId}"]`);

      if (targetSection) targetSection.classList.remove('hidden');
      if (targetNav) {
        targetNav.classList.add('active');
        targetNav.classList.remove('text-slate-300');
        targetNav.classList.add('text-white');
      }

      const pageInfo = pageTitles[sectionId] || { title: 'Page', subtitle: '' };
      pageTitle.textContent = pageInfo.title;
      pageSubtitle.textContent = pageInfo.subtitle;

      if (sectionId === 'dashboard') loadDashboard();
      if (sectionId === 'history') loadHistory();
      if (sectionId === 'customers') loadCustomers();
      if (sectionId === 'feedback') loadFeedback();
      if (sectionId === 'settings') { loadSettings(); loadTelegramConfig(); }
      if (sectionId === 'billing') updateSubscriptionDisplay();
    }

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const sectionId = item.dataset.section;
        showSection(sectionId);
      });
    });

    document.getElementById('new-message-btn').addEventListener('click', () => showSection('send-sms'));
    document.getElementById('quick-send-btn').addEventListener('click', async () => {
      const phone = document.getElementById('quick-phone').value.trim();
      const message = document.getElementById('quick-message').value.trim();
      
      if (!phone) {
        showNotification('Please enter a phone number', 'error');
        return;
      }
      if (!message) {
        showNotification('Please enter a message', 'error');
        return;
      }
      
      const btn = document.getElementById('quick-send-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...';
      btn.disabled = true;
      
      try {
        const response = await fetch('/api/send-sms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customerPhone: phone,
            customerName: 'Quick Send',
            messageType: 'ready',
            customMessage: message,
            smsConsentConfirmed: true
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Message sent successfully!', 'success');
          document.getElementById('quick-phone').value = '';
          document.getElementById('quick-message').value = '';
          loadDashboard();
        } else {
          showNotification(data.error || 'Failed to send message', 'error');
        }
      } catch (error) {
        console.error('Quick send error:', error);
        showNotification('Failed to send message', 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    });

    async function loadDashboard() {
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        if (data.success && data.stats) {
          document.getElementById('stat-total-messages').textContent = data.stats.totalMessages || 0;
          document.getElementById('stat-total-customers').textContent = data.stats.totalCustomers || 0;
          document.getElementById('stat-today').textContent = data.stats.todayMessages || 0;
          document.getElementById('stat-this-week').textContent = data.stats.weekMessages || 0;
          
          const container = document.getElementById('recent-messages');
          if (data.stats.recentMessages && data.stats.recentMessages.length > 0) {
            container.innerHTML = data.stats.recentMessages.map(msg => `
              <div class="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div class="w-10 h-10 rounded-full ${msg.message_type === 'review' ? 'bg-amber-100' : 'bg-green-100'} flex items-center justify-center flex-shrink-0">
                  ${msg.message_type === 'review' ? '<span class="text-amber-600">‚≠ê</span>' : '<span class="text-green-600">üì±</span>'}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-gray-900 truncate">${getMessageTypeTitle(msg.message_type)}</div>
                  <div class="text-sm text-gray-500 truncate">${msg.customer_name}</div>
                </div>
                <div class="text-xs text-gray-400">${getTimeAgo(msg.sent_at)}</div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No recent activity</p>';
          }
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('recent-messages').innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No recent activity</p>';
      }
    }

    function getMessageTypeTitle(type) {
      const titles = {
        'review': 'New Review Request',
        'ready': 'Pickup Notification',
        'follow_up': 'Follow-up Sent',
        'custom': 'Custom Message'
      };
      return titles[type] || 'SMS Sent';
    }

    function getTimeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return 'Just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    function getMessageTypeLabel(type) {
      const labels = {
        'review': '‚≠ê Review',
        'ready': 'üîî Pickup',
        'follow_up': 'üîÅ Follow-up',
        'custom': 'üí¨ Custom'
      };
      return labels[type] || type;
    }

    async function loadHistory() {
      try {
        const response = await fetch('/api/messages');
        const data = await response.json();
        
        const container = document.getElementById('history-list');
        const filterValue = document.getElementById('history-filter').value;
        
        let messages = data.success && data.messages ? data.messages : [];
        
        if (filterValue === 'clicked') {
          messages = messages.filter(m => m.review_link_clicked_at);
        } else if (filterValue === 'reviewed') {
          messages = messages.filter(m => m.feedback_rating);
        } else if (filterValue === 'needs-followup') {
          messages = messages.filter(m => m.review_link_clicked_at && !m.feedback_rating && !m.follow_up_sent_at);
        }
        
        if (messages.length > 0) {
          container.innerHTML = messages.map(msg => `
            <div class="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0">
                <span class="text-gray-600">${msg.customer_name.charAt(0).toUpperCase()}</span>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-gray-900">${msg.customer_name}</span>
                  <span class="text-xs rounded-full bg-indigo-50 text-indigo-700 px-2 py-0.5">${getMessageTypeLabel(msg.message_type)}</span>
                  ${msg.review_link_clicked_at ? '<span class="text-xs rounded-full bg-green-50 text-green-700 px-2 py-0.5">Clicked</span>' : ''}
                  ${msg.feedback_rating ? `<span class="text-xs rounded-full bg-amber-50 text-amber-700 px-2 py-0.5">${'‚≠ê'.repeat(msg.feedback_rating)}</span>` : ''}
                </div>
                <div class="text-sm text-gray-500">${msg.customer_phone} ‚Ä¢ ${new Date(msg.sent_at).toLocaleString()}</div>
              </div>
              ${msg.review_link_clicked_at && !msg.feedback_rating && !msg.follow_up_sent_at ? `
                <button onclick="sendReminder(${msg.id}, '${msg.customer_name.replace(/'/g, "\\'")}', '${msg.customer_phone}', '${msg.review_link || ''}')" class="px-3 py-1.5 text-xs bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">
                  Send Reminder
                </button>
              ` : ''}
            </div>
          `).join('');
        } else {
          const filterLabels = {
            all: 'No messages in history',
            clicked: 'No messages with clicked links',
            reviewed: 'No messages with feedback received',
            'needs-followup': 'No messages need follow-up'
          };
          container.innerHTML = `<p class="text-sm text-gray-500 text-center py-12">${filterLabels[filterValue]}</p>`;
        }
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    document.getElementById('history-filter').addEventListener('change', loadHistory);

    async function loadCustomers() {
      try {
        const response = await fetch('/api/customers');
        const data = await response.json();
        
        const container = document.getElementById('customers-list');
        if (data.success && data.customers && data.customers.length > 0) {
          container.innerHTML = data.customers.map(customer => `
            <div class="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center flex-shrink-0">
                <span class="text-white font-medium">${customer.name.charAt(0).toUpperCase()}</span>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-medium text-gray-900">${customer.name}</div>
                <div class="text-sm text-gray-500">${customer.phone} ‚Ä¢ ${customer.message_count || 0} messages</div>
              </div>
              <button onclick="loadCustomerData('${customer.name}', '${customer.phone}')" class="px-3 py-1.5 text-xs border border-accent text-accent rounded-lg hover:bg-indigo-50 transition-colors">
                Use in Form
              </button>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-12">No customers yet</p>';
        }
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    function loadCustomerData(name, phone) {
      document.getElementById('customer-name').value = name;
      document.getElementById('customer-phone').value = phone;
      showSection('send-sms');
      showNotification('Customer data loaded!', 'success');
    }

    async function loadFeedback() {
      try {
        const response = await fetch('/api/feedback');
        const data = await response.json();
        
        const container = document.getElementById('feedback-list');
        if (data.success && data.feedback && data.feedback.length > 0) {
          container.innerHTML = data.feedback.map(fb => `
            <div class="p-4 rounded-lg ${fb.status === 'unread' ? 'bg-amber-50 border-l-4 border-l-amber-500' : 'hover:bg-gray-50'}">
              <div class="flex items-start justify-between gap-4">
                <div class="flex gap-3">
                  <div class="w-10 h-10 rounded-full ${fb.rating <= 3 ? 'bg-red-100' : 'bg-green-100'} flex items-center justify-center flex-shrink-0">
                    <span class="${fb.rating <= 3 ? 'text-red-600' : 'text-green-600'}">${fb.rating <= 3 ? 'üòû' : 'üòä'}</span>
                  </div>
                  <div>
                    <div class="flex items-center gap-2 mb-1">
                      <span class="font-medium text-gray-900">${fb.customer_name}</span>
                      <span class="text-xs px-2 py-1 rounded-full ${fb.rating <= 3 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                        ${'‚≠ê'.repeat(fb.rating)}
                      </span>
                      ${fb.status === 'unread' ? '<span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">New</span>' : ''}
                    </div>
                    <div class="text-sm text-gray-500">${fb.customer_phone}</div>
                    ${fb.feedback_text ? `<div class="mt-2 p-3 bg-white rounded-lg border border-gray-100 text-sm text-gray-700">"${fb.feedback_text}"</div>` : ''}
                    <div class="text-xs text-gray-400 mt-2">${new Date(fb.created_at).toLocaleString()}</div>
                  </div>
                </div>
                ${fb.status === 'unread' ? `
                  <button onclick="markFeedbackRead(${fb.id})" class="px-3 py-1.5 text-xs bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    Mark Read
                  </button>
                ` : ''}
              </div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-12">No feedback received yet</p>';
        }
      } catch (error) {
        console.error('Error loading feedback:', error);
      }
    }

    async function markFeedbackRead(feedbackId) {
      try {
        const response = await fetch('/api/feedback/mark-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ feedbackId })
        });
        const data = await response.json();
        if (data.success) {
          loadFeedback();
          showNotification('Feedback marked as read', 'success');
        }
      } catch (error) {
        console.error('Error marking feedback as read:', error);
      }
    }

    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        const data = await response.json();
        
        if (data.success && data.settings) {
          document.getElementById('settings-business-name').value = data.settings.business_name || '';
          document.getElementById('settings-sms-template').value = data.settings.sms_template || 'Hi {name}, thanks for visiting {business}! Please review us here: {link}';
          document.getElementById('settings-review-link').value = data.settings.google_review_link || '';
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    async function saveSettings() {
      try {
        const businessNameVal = document.getElementById('settings-business-name').value;
        const smsTemplate = document.getElementById('settings-sms-template').value;
        const reviewLink = document.getElementById('settings-review-link').value;

        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            business_name: businessNameVal,
            sms_template: smsTemplate,
            google_review_link: reviewLink
          })
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Settings saved!', 'success');
          businessName = businessNameVal || 'Our Store';
          
          const sidebarBrand = document.getElementById('sidebar-brand');
          const headerBranding = document.getElementById('header-branding');
          
          if (sidebarBrand) sidebarBrand.textContent = businessNameVal || 'ReviewGuard';
          if (headerBranding) headerBranding.textContent = businessNameVal ? `${businessNameVal} SMS Manager` : 'SMS Manager';
          
          updatePreview();
        } else {
          showNotification(data.error || 'Failed to save settings', 'error');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('Failed to save settings', 'error');
      }
    }

    async function loadTelegramConfig() {
      try {
        const response = await fetch('/api/settings/telegram');
        const data = await response.json();
        
        const statusBadge = document.getElementById('telegram-status-badge');
        const testBtn = document.getElementById('test-telegram-btn');
        const disconnectBtn = document.getElementById('disconnect-telegram-btn');
        const chatIdInput = document.getElementById('telegram-chat-id');
        const tokenInput = document.getElementById('telegram-bot-token');
        
        if (data.success && data.configured) {
          statusBadge.textContent = 'Connected';
          statusBadge.className = 'px-2 py-1 rounded-full text-[10px] font-medium bg-green-100 text-green-700';
          testBtn.disabled = false;
          disconnectBtn.classList.remove('hidden');
          chatIdInput.value = data.config.chatId || '';
          tokenInput.placeholder = 'Bot token configured (hidden)';
        } else {
          statusBadge.textContent = 'Not Configured';
          statusBadge.className = 'px-2 py-1 rounded-full text-[10px] font-medium bg-gray-100 text-gray-600';
          testBtn.disabled = true;
          disconnectBtn.classList.add('hidden');
          chatIdInput.value = '';
          tokenInput.placeholder = 'Enter your Telegram Bot Token from @BotFather';
        }
      } catch (error) {
        console.error('Error loading Telegram config:', error);
      }
    }

    async function saveTelegramConfig() {
      const botToken = document.getElementById('telegram-bot-token').value.trim();
      const chatId = document.getElementById('telegram-chat-id').value.trim();
      
      if (!botToken || !chatId) {
        showNotification('Please enter both Bot Token and Chat ID', 'error');
        return;
      }
      
      const saveBtn = document.getElementById('save-telegram-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        const response = await fetch('/api/settings/telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ botToken, chatId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Telegram connected successfully!', 'success');
          document.getElementById('telegram-bot-token').value = '';
          loadTelegramConfig();
        } else {
          showNotification(data.error || 'Failed to save Telegram settings', 'error');
        }
      } catch (error) {
        console.error('Error saving Telegram config:', error);
        showNotification('Failed to save Telegram settings', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Telegram Settings';
      }
    }

    async function testTelegramConnection() {
      const testBtn = document.getElementById('test-telegram-btn');
      testBtn.disabled = true;
      testBtn.textContent = 'Testing...';
      
      try {
        const response = await fetch('/api/settings/telegram/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Test message sent! Check your Telegram.', 'success');
        } else {
          showNotification(data.error || 'Failed to send test message', 'error');
        }
      } catch (error) {
        console.error('Error testing Telegram:', error);
        showNotification('Failed to send test message', 'error');
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'Test';
      }
    }

    async function disconnectTelegram() {
      if (!confirm('Are you sure you want to disconnect your Telegram bot?')) return;
      
      try {
        const response = await fetch('/api/settings/telegram', { method: 'DELETE' });
        const data = await response.json();
        
        if (data.success) {
          showNotification('Telegram bot disconnected', 'success');
          loadTelegramConfig();
        } else {
          showNotification(data.error || 'Failed to disconnect Telegram', 'error');
        }
      } catch (error) {
        console.error('Error disconnecting Telegram:', error);
        showNotification('Failed to disconnect Telegram', 'error');
      }
    }

    async function sendReminder(messageId, customerName, customerPhone, reviewLink) {
      if (!confirm(`Send reminder to ${customerName}?`)) return;
      
      try {
        const response = await fetch('/api/send-reminder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messageId, customerName, customerPhone, reviewLink })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification(`Reminder sent to ${customerName}!`, 'success');
          loadHistory();
        } else {
          showNotification(data.error || 'Failed to send reminder', 'error');
        }
      } catch (error) {
        console.error('Error sending reminder:', error);
        showNotification('Failed to send reminder', 'error');
      }
    }

    function clearAIReviewForm() {
      document.getElementById('ai-customer-name').value = '';
      document.getElementById('ai-star-rating').value = '';
      document.getElementById('ai-review-text').value = '';
      document.getElementById('ai-reply-container').classList.add('hidden');
    }

    async function generateAIReply() {
      const customerName = document.getElementById('ai-customer-name').value.trim();
      const starRating = document.getElementById('ai-star-rating').value;
      const reviewText = document.getElementById('ai-review-text').value.trim();
      const generateBtn = document.getElementById('generate-reply-btn');

      if (!customerName || !starRating || !reviewText) {
        showNotification('Please fill in all fields', 'error');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';

      try {
        const response = await fetch('/api/generate-reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerName, starRating: parseInt(starRating), reviewText })
        });

        const data = await response.json();

        if (data.success && data.reply) {
          document.getElementById('ai-reply-text').textContent = data.reply;
          document.getElementById('ai-reply-container').classList.remove('hidden');
          showNotification('AI reply generated!', 'success');
        } else {
          showNotification(data.error || 'Failed to generate reply', 'error');
        }
      } catch (error) {
        console.error('Error generating AI reply:', error);
        showNotification('Failed to generate reply', 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Generate AI Reply';
      }
    }

    function copyReplyToClipboard() {
      const replyText = document.getElementById('ai-reply-text').textContent;
      navigator.clipboard.writeText(replyText).then(() => {
        showNotification('Copied to clipboard!', 'success');
      }).catch(() => {
        showNotification('Failed to copy', 'error');
      });
    }

    const messageTypeSelect = document.getElementById('message-type');
    const customerNameInput = document.getElementById('customer-name');
    const deviceInput = document.getElementById('device');
    const repairInput = document.getElementById('repair');
    const customMessageInput = document.getElementById('custom-message');
    const customMessageContainer = document.getElementById('custom-message-container');
    const messagePreview = document.getElementById('message-preview');
    const charCount = document.getElementById('char-count');

    messageTypeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customMessageContainer.classList.remove('hidden');
      } else {
        customMessageContainer.classList.add('hidden');
      }
      updatePreview();
    });

    function updatePreview() {
      const type = messageTypeSelect.value;
      const name = customerNameInput.value || 'Customer';
      const device = deviceInput.value || 'device';
      const repair = repairInput.value || 'repair';
      const custom = customMessageInput.value;

      let message = '';

      if (type === 'review') {
        message = `Hi ${name}! Thank you for choosing ${businessName} for your ${device} ${repair}. How was your experience? Please rate us: [Feedback Link]`;
      } else if (type === 'ready') {
        message = `Hi ${name}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours. See you soon!`;
      } else if (type === 'follow_up') {
        message = `Hi ${name}! Just checking in on your ${device}. Is everything working well after the ${repair}? Let us know if you need anything!`;
      } else {
        message = custom || '';
      }

      if (custom && type !== 'custom') {
        message += '\n\n' + custom;
      }

      messagePreview.textContent = message || 'Your message will appear here...';
      charCount.textContent = message.length;
    }

    customerNameInput.addEventListener('input', updatePreview);
    deviceInput.addEventListener('input', updatePreview);
    repairInput.addEventListener('input', updatePreview);
    customMessageInput.addEventListener('input', updatePreview);

    const smsConsentCheckbox = document.getElementById('sms-consent-checkbox');
    const sendSmsBtn = document.getElementById('send-sms-btn');

    smsConsentCheckbox.addEventListener('change', function() {
      sendSmsBtn.disabled = !this.checked;
    });

    sendSmsBtn.addEventListener('click', async () => {
      if (!smsConsentCheckbox.checked) {
        showNotification('Please confirm SMS consent before sending', 'error');
        return;
      }
      window.openSmsConfirmationModal();
    });

    async function sendSMS() {
      const customerName = customerNameInput.value;
      const customerPhone = document.getElementById('customer-phone').value;
      const messageType = messageTypeSelect.value;
      const device = deviceInput.value;
      const repair = repairInput.value;
      const customMessage = customMessageInput.value;

      if (!customerName || !customerPhone) {
        showNotification('Please enter customer name and phone number', 'error');
        return;
      }

      let additionalInfo = '';
      if (messageType === 'review') {
        additionalInfo = `Hi ${customerName}! Thank you for choosing ${businessName} for your ${device} ${repair}. How was your experience? Please rate us:`;
      } else if (messageType === 'ready') {
        additionalInfo = `Hi ${customerName}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours. See you soon!`;
      } else if (messageType === 'follow_up') {
        additionalInfo = `Hi ${customerName}! Just checking in on your ${device}. Is everything working well after the ${repair}? Let us know if you need anything!`;
      } else if (messageType === 'custom') {
        additionalInfo = customMessage;
      }

      if (customMessage && messageType !== 'custom') {
        additionalInfo += '\n\n' + customMessage;
      }

      sendSmsBtn.disabled = true;
      sendSmsBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...';

      try {
        const formData = new FormData();
        formData.append('customerName', customerName);
        formData.append('customerPhone', customerPhone);
        formData.append('messageType', messageType);
        formData.append('additionalInfo', additionalInfo);
        formData.append('smsConsentConfirmed', 'true');

        const response = await fetch('/api/send-review-request', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          if (messageType === 'review') {
            showNotification('Feedback request sent! Customer will receive a link to rate their experience.', 'success');
          } else {
            showNotification('SMS sent successfully!', 'success');
          }
          
          customerNameInput.value = '';
          document.getElementById('customer-phone').value = '';
          deviceInput.value = '';
          repairInput.value = '';
          customMessageInput.value = '';
          smsConsentCheckbox.checked = false;
          sendSmsBtn.disabled = true;
          updatePreview();
        } else {
          showNotification('Error: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Error sending SMS:', error);
        showNotification('Failed to send SMS. Please try again.', 'error');
      } finally {
        sendSmsBtn.disabled = !smsConsentCheckbox.checked;
        sendSmsBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg> Save & Send Welcome SMS';
      }
    }

    window.openSmsConfirmationModal = function() {
      const customerName = customerNameInput.value;
      const customerPhone = document.getElementById('customer-phone').value;
      const messageType = messageTypeSelect.value;
      const device = deviceInput.value;
      const repair = repairInput.value;
      const customMessage = customMessageInput.value;

      if (!customerName || !customerPhone) {
        showNotification('Please enter customer name and phone number', 'error');
        return;
      }

      let msgPreview = '';
      if (messageType === 'review') {
        msgPreview = `Hi ${customerName}! Thank you for choosing ${businessName} for your ${device} ${repair}. How was your experience? Please rate us:`;
      } else if (messageType === 'ready') {
        msgPreview = `Hi ${customerName}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours.`;
      } else if (messageType === 'follow_up') {
        msgPreview = `Hi ${customerName}! Just checking in on your ${device}. Is everything working well after the ${repair}?`;
      } else if (messageType === 'custom') {
        msgPreview = customMessage;
      }

      if (customMessage && messageType !== 'custom') {
        msgPreview += '\n\n' + customMessage;
      }

      document.getElementById('modal-customer-name').textContent = customerName;
      document.getElementById('modal-customer-phone').textContent = customerPhone;
      document.getElementById('modal-message-preview').textContent = msgPreview;

      document.getElementById('sms-confirmation-modal').classList.remove('hidden');
    };

    window.closeSmsConfirmationModal = function() {
      document.getElementById('sms-confirmation-modal').classList.add('hidden');
    };

    window.confirmAndSendSMS = async function() {
      window.closeSmsConfirmationModal();
      await sendSMS();
    };

    document.getElementById('modal-cancel-btn').addEventListener('click', window.closeSmsConfirmationModal);
    document.getElementById('modal-confirm-btn').addEventListener('click', window.confirmAndSendSMS);
    document.getElementById('modal-backdrop').addEventListener('click', window.closeSmsConfirmationModal);

    const ocrUploadInput = document.getElementById('ocr-upload');
    const dropZone = document.getElementById('drop-zone');
    const browseFilesBtn = document.getElementById('browse-files-btn');
    const ocrNameDisplay = document.getElementById('ocr-name');
    const ocrPhoneDisplay = document.getElementById('ocr-phone');
    const ocrDeviceDisplay = document.getElementById('ocr-device');
    const ocrRepairDisplay = document.getElementById('ocr-repair');

    browseFilesBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      ocrUploadInput.click();
    });

    dropZone.addEventListener('click', () => ocrUploadInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        processOCRFile(files[0]);
      }
    });

    ocrUploadInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) processOCRFile(file);
    });

    async function processOCRFile(file) {
      ocrNameDisplay.textContent = 'Processing...';
      ocrPhoneDisplay.textContent = 'Processing...';
      ocrDeviceDisplay.textContent = 'Processing...';
      ocrRepairDisplay.textContent = 'Processing...';

      try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/ocr/process', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success && data.data) {
          ocrNameDisplay.textContent = data.data.customerName || '-';
          ocrPhoneDisplay.textContent = data.data.customerPhone || '-';
          ocrDeviceDisplay.textContent = data.data.device || '-';
          ocrRepairDisplay.textContent = data.data.repair || '-';

          if (data.data.customerName) customerNameInput.value = data.data.customerName;
          if (data.data.customerPhone) document.getElementById('customer-phone').value = data.data.customerPhone;
          if (data.data.device) deviceInput.value = data.data.device;
          if (data.data.repair) repairInput.value = data.data.repair;

          updatePreview();
          showNotification('Information extracted successfully!', 'success');
        } else {
          ocrNameDisplay.textContent = '-';
          ocrPhoneDisplay.textContent = '-';
          ocrDeviceDisplay.textContent = '-';
          ocrRepairDisplay.textContent = '-';
          showNotification('Error: ' + (data.error || 'Failed to process image'), 'error');
          ocrUploadInput.value = '';
        }
      } catch (error) {
        console.error('OCR upload error:', error);
        ocrNameDisplay.textContent = '-';
        ocrPhoneDisplay.textContent = '-';
        ocrDeviceDisplay.textContent = '-';
        ocrRepairDisplay.textContent = '-';
        showNotification('Failed to process image', 'error');
        ocrUploadInput.value = '';
      }
    }

    const cameraBtn = document.getElementById('camera-btn');
    const cameraModal = document.getElementById('camera-modal');
    const cameraVideo = document.getElementById('camera-video');
    const cameraCanvas = document.getElementById('camera-canvas');
    const capturePhotoBtn = document.getElementById('capture-photo-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');
    const cameraError = document.getElementById('camera-error');
    let cameraStream = null;

    cameraBtn.addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showNotification('Camera is not supported on this device', 'error');
          return;
        }

        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });

        cameraVideo.srcObject = cameraStream;
        cameraModal.classList.remove('hidden');
        cameraError.classList.add('hidden');
      } catch (error) {
        console.error('Camera access error:', error);
        showNotification('Failed to access camera. Please use the Upload button instead.', 'error');
      }
    });

    closeCameraBtn.addEventListener('click', () => {
      stopCamera();
      cameraModal.classList.add('hidden');
    });

    capturePhotoBtn.addEventListener('click', async () => {
      try {
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;

        const context = cameraCanvas.getContext('2d');
        context.drawImage(cameraVideo, 0, 0);

        cameraCanvas.toBlob(async (blob) => {
          if (!blob) {
            showNotification('Failed to capture photo', 'error');
            stopCamera();
            cameraModal.classList.add('hidden');
            return;
          }

          stopCamera();
          cameraModal.classList.add('hidden');
          
          const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
          processOCRFile(file);
        }, 'image/jpeg', 0.95);
      } catch (error) {
        console.error('Photo capture error:', error);
        showNotification('Failed to capture photo', 'error');
      }
    });

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        cameraVideo.srcObject = null;
      }
    }

    async function createCheckout(planId, button, originalText) {
      try {
        button.disabled = true;
        button.textContent = 'Creating checkout...';

        const authResponse = await fetch('/api/auth/session');
        if (!authResponse.ok) {
          showNotification('Please log in to subscribe', 'error');
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        
        const authData = await authResponse.json();
        if (!authData.user?.email) {
          showNotification('Please log in to subscribe', 'error');
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: authData.user.email, planId: planId })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error(data.error || 'Failed to create checkout session');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        showNotification('Failed to start checkout', 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function updateSubscriptionDisplay() {
      try {
        const authResponse = await fetch('/api/auth/session');
        if (!authResponse.ok) return;
        
        const authData = await authResponse.json();
        if (!authData.user?.email) return;

        const response = await fetch(`/api/subscription-status?email=${encodeURIComponent(authData.user.email)}`);
        if (!response.ok) return;

        const data = await response.json();
        
        const starterCard = document.getElementById('starter-plan-card');
        const proCard = document.getElementById('pro-plan-card');
        const starterBtn = document.getElementById('subscribe-starter-btn');
        const proBtn = document.getElementById('subscribe-pro-btn');

        starterCard.classList.remove('border-green-500', 'border-2');
        proCard.classList.remove('border-green-500', 'border-2');
        starterCard.classList.add('border-gray-100');
        proCard.classList.add('border-accent');

        if (data.subscription_status === 'active') {
          const planId = data.plan;
          
          if (planId === 'starter') {
            starterCard.classList.remove('border-gray-100');
            starterCard.classList.add('border-green-500', 'border-2');
            starterBtn.textContent = '‚úì Active Plan';
            starterBtn.disabled = true;
          } else if (planId === 'pro') {
            proCard.classList.remove('border-accent');
            proCard.classList.add('border-green-500', 'border-2');
            proBtn.textContent = '‚úì Active Plan';
            proBtn.disabled = true;
          }
        }
      } catch (error) {
        console.error('Failed to fetch subscription status:', error);
      }
    }

    const subscribeStarterBtn = document.getElementById('subscribe-starter-btn');
    if (subscribeStarterBtn) {
      subscribeStarterBtn.addEventListener('click', function() {
        createCheckout('starter', this, 'Subscribe to Starter');
      });
    }

    const subscribeProBtn = document.getElementById('subscribe-pro-btn');
    if (subscribeProBtn) {
      subscribeProBtn.addEventListener('click', function() {
        createCheckout('pro', this, 'Subscribe to Pro');
      });
    }

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const data = await response.json();
          
          if (data.success) {
            window.location.href = '/login.html';
          } else {
            showNotification('Logout failed', 'error');
          }
        } catch (error) {
          console.error('Logout error:', error);
          showNotification('Logout failed', 'error');
        }
      });
    }

    const saveSettingsBtn = document.getElementById('save-settings-btn');
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', async function() {
        await saveSettings();
        loadUserOnPageLoad();
      });
    }

    const saveTelegramBtn = document.getElementById('save-telegram-btn');
    if (saveTelegramBtn) saveTelegramBtn.addEventListener('click', saveTelegramConfig);

    const testTelegramBtn = document.getElementById('test-telegram-btn');
    if (testTelegramBtn) testTelegramBtn.addEventListener('click', testTelegramConnection);

    const disconnectTelegramBtn = document.getElementById('disconnect-telegram-btn');
    if (disconnectTelegramBtn) disconnectTelegramBtn.addEventListener('click', disconnectTelegram);

    const copyReplyBtn = document.getElementById('copy-reply-btn');
    if (copyReplyBtn) copyReplyBtn.addEventListener('click', copyReplyToClipboard);

    async function loadUserOnPageLoad() {
      try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();
        
        if (data.success && data.user) {
          const user = data.user;
          
          const userDisplay = document.getElementById('user-display-name');
          const userEmail = document.getElementById('user-email');
          const userAvatar = document.getElementById('user-avatar');
          const sidebarBrand = document.getElementById('sidebar-brand');
          const headerBranding = document.getElementById('header-branding');
          
          if (userDisplay) userDisplay.textContent = user.first_name || 'User';
          if (userEmail) userEmail.textContent = user.email || 'user@example.com';
          if (userAvatar && user.first_name) userAvatar.textContent = user.first_name.charAt(0).toUpperCase();
          
          businessName = user.business_name || 'Our Store';
          
          if (sidebarBrand) {
            sidebarBrand.textContent = user.business_name || 'ReviewGuard';
          }
          if (headerBranding) {
            headerBranding.textContent = user.business_name ? `${user.business_name} SMS Manager` : 'SMS Manager';
          }
          
          updatePreview();
        }
      } catch (error) {
        console.error('Error loading user:', error);
      }
    }

    showSection('dashboard');
    loadUserOnPageLoad();
    updatePreview();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // CLEANUP MODE: Unregister ALL service workers and clear ALL caches
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            console.log('Unregistering service worker:', registration.scope);
            await registration.unregister();
          }
          
          // Clear ALL caches
          const cacheNames = await caches.keys();
          await Promise.all(
            cacheNames.map(name => {
              console.log('Deleting cache:', name);
              return caches.delete(name);
            })
          );
          
          console.log('All service workers and caches cleared');
        } catch (error) {
          console.log('Cleanup error:', error);
        }
      });
    }
  </script>

</body>
</html>
