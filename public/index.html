<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ReviewGuard SMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="SMS Manager for repair shops - Turn paper receipts into 5-star Google Reviews" />
  <meta name="theme-color" content="#1e293b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ReviewGuard" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icons/icon-192x192.png" type="image/png" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root {
      --sidebar: #1e293b;
      --sidebar-hover: #334155;
      --sidebar-active: #6366f1;
      --accent: #6366f1;
    }
    .bg-sidebar { background-color: var(--sidebar); }
    .bg-sidebar-hover { background-color: var(--sidebar-hover); }
    .bg-sidebar-active, .bg-accent { background-color: var(--accent); }
    .text-accent { color: var(--accent); }
    .border-accent { border-color: var(--accent); }
    .modal-backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    .nav-item { transition: all 0.15s ease; }
    .nav-item:hover { background: #334155; }
    .nav-item.active { background: #6366f1; }
    .drag-area { transition: all 0.2s ease; }
    .drag-area.dragover { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
    .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1); }
    
    /* Mobile sidebar */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 35; }
      .sidebar.open ~ .sidebar-overlay { display: block; }
      .main-content { margin-left: 0 !important; padding-top: 56px !important; }
      .mobile-header { display: flex !important; }
    }
    @media (min-width: 769px) {
      .mobile-header { display: none !important; }
      .sidebar-overlay { display: none !important; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" id="login-modal-backdrop"></div>
    <div class="relative flex items-start justify-center pt-16 px-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative animate-fade-in">
        <div class="text-center mb-6">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mx-auto mb-4">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900">Welcome Back</h2>
          <p class="text-gray-500 text-sm mt-1">Sign in to your account</p>
        </div>
        
        <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
        
        <form id="login-modal-form">
          <div class="mb-4">
            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
            <input type="email" id="login-email" required placeholder="you@company.com" autocomplete="email"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
          </div>
          
          <div class="mb-4">
            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input type="password" id="login-password" required autocomplete="current-password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
          </div>
          
          <div class="flex justify-end mb-4">
            <a href="/forgot-password.html" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">Forgot Password?</a>
          </div>
          
          <button type="submit" id="login-modal-btn"
            class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg shadow-indigo-500/30">
            Sign In
          </button>
        </form>
        
        <div class="mt-6 text-center text-sm text-gray-600">
          New here? <a href="/signup.html" class="text-indigo-600 font-semibold hover:text-indigo-700">Create an Account</a>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out; }
  </style>

  <div class="flex min-h-screen">
    <!-- Mobile Header -->
    <div class="mobile-header hidden fixed top-0 left-0 right-0 h-14 bg-sidebar z-30 items-center px-4 gap-3">
      <button id="mobile-menu-btn" class="p-2 text-white hover:bg-slate-700 rounded-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-accent flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
        </div>
        <span id="mobile-brand" class="text-white font-semibold text-sm">ReviewGuard</span>
      </div>
    </div>
    
    <aside id="sidebar" class="sidebar w-56 bg-sidebar fixed h-screen flex flex-col z-40">
      <div class="p-5 border-b border-slate-700">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-accent flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <div>
            <div id="sidebar-brand" class="text-white font-semibold text-sm">ReviewGuard</div>
          </div>
        </div>
      </div>

      <nav class="flex-1 p-3 space-y-1">
        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider px-3 py-2">Main Menu</div>
        
        <button data-section="dashboard" class="nav-item active w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-white text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
          Dashboard
        </button>

        <button data-section="send-sms" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
          Send SMS
        </button>

        <button data-section="bulk-sms" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
          Campaigns
        </button>

        <button data-section="history" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          History
        </button>

        <button data-section="customers" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          Customers
        </button>

        <button data-section="reviews" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
          Reviews
        </button>

        <button data-section="feedback" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          Feedback
        </button>

        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider px-3 py-2 mt-4">System</div>

        <button data-section="billing" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
          </svg>
          Billing
        </button>

        <button data-section="settings" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Settings
        </button>
      </nav>

      <div class="p-4 border-t border-slate-700">
        <div class="flex items-center gap-3">
          <div id="user-avatar" class="w-9 h-9 rounded-full bg-accent flex items-center justify-center text-white text-sm font-semibold">
            U
          </div>
          <div class="flex-1 min-w-0">
            <div id="user-display-name" class="text-white text-sm font-medium truncate">Loading...</div>
            <div id="user-email" class="text-slate-400 text-xs truncate">user@example.com</div>
          </div>
          <button id="logout-btn" class="p-1.5 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition-colors" title="Sign Out">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
          </button>
        </div>
      </div>
    </aside>
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <main class="main-content flex-1 ml-56 pt-0 md:pt-0" style="padding-top: 0;">
      <!-- Mobile top padding handled by CSS media query -->
      <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div class="flex items-center justify-between px-6 py-4">
          <div>
            <h1 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard</h1>
            <p id="page-subtitle" class="text-sm text-gray-500">Overview of your messaging and reviews.</p>
            <p id="header-branding" class="hidden"></p>
          </div>
          <button id="new-message-btn" class="inline-flex items-center gap-2 px-4 py-2.5 bg-accent hover:bg-indigo-600 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            New Message
          </button>
        </div>
      </header>

      <div id="notification-container" class="hidden fixed top-4 right-4 z-50 max-w-sm">
        <div id="notification-message" class="rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2">
          <span id="notification-icon"></span>
          <span id="notification-text"></span>
        </div>
      </div>

      <div id="sms-confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div class="modal-backdrop absolute inset-0" id="modal-backdrop"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Confirm SMS</h3>
          <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <span class="text-2xl">üë§</span>
              <div>
                <div class="text-xs text-gray-500">Send to</div>
                <div class="font-semibold text-gray-900" id="modal-customer-name">-</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <span class="text-2xl">üì±</span>
              <div>
                <div class="text-xs text-gray-500">Phone number</div>
                <div class="font-semibold text-gray-900" id="modal-customer-phone">-</div>
              </div>
            </div>
            <div class="p-3 bg-gray-50 rounded-lg">
              <div class="text-xs text-gray-500 mb-2">Message preview</div>
              <div class="text-sm text-gray-700 leading-relaxed max-h-32 overflow-y-auto" id="modal-message-preview">-</div>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="modal-cancel-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-all">
              Cancel
            </button>
            <button id="modal-confirm-btn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-lg">
              Confirm & Send
            </button>
          </div>
        </div>
      </div>

      <div id="camera-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 bg-black/80">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold text-gray-900">Take Photo</h3>
            <button id="close-camera-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          <video id="camera-video" autoplay playsinline class="w-full rounded-lg bg-gray-900"></video>
          <canvas id="camera-canvas" class="hidden"></canvas>
          <p id="camera-error" class="hidden text-red-500 text-sm mt-2"></p>
          <button id="capture-photo-btn" class="mt-4 w-full inline-flex items-center justify-center gap-2 text-sm font-medium text-white bg-accent rounded-lg px-4 py-3 hover:bg-indigo-600 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Capture Photo
          </button>
        </div>
      </div>

      <div id="repairdesk-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div id="repairdesk-modal-backdrop" class="absolute inset-0 bg-black/50"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col">
          <div class="flex justify-between items-center p-4 border-b border-gray-100">
            <div>
              <h3 class="text-lg font-bold text-gray-900">Import from RepairDesk</h3>
              <p class="text-sm text-gray-500">Select a ticket to auto-fill customer details</p>
            </div>
            <button id="close-repairdesk-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          <div id="repairdesk-tickets-container" class="flex-1 overflow-y-auto p-4">
            <div id="repairdesk-loading" class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
              <p class="mt-2 text-gray-500">Loading tickets...</p>
            </div>
            <div id="repairdesk-error" class="hidden text-center py-8">
              <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-red-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <p class="text-red-600 font-medium">Failed to load tickets</p>
              <p id="repairdesk-error-msg" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <div id="repairdesk-tickets" class="hidden space-y-2"></div>
            <div id="repairdesk-empty" class="hidden text-center py-8">
              <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-gray-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <p class="text-gray-500">No tickets in the last 7 days</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Big Centered Error Modal (impossible to miss) -->
      <div id="error-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center px-4">
        <div id="error-modal-backdrop" class="absolute inset-0 bg-black/70"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 animate-bounce-in">
          <div class="flex flex-col items-center text-center">
            <div class="w-20 h-20 rounded-full bg-red-100 flex items-center justify-center mb-4">
              <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Something Went Wrong</h3>
            <p id="error-modal-message" class="text-gray-600 mb-6">An error occurred. Please try again.</p>
            <button id="error-modal-close-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all text-lg">
              OK, Got It
            </button>
          </div>
        </div>
      </div>
      
      <style>
        @keyframes bounceIn {
          0% { transform: scale(0.3); opacity: 0; }
          50% { transform: scale(1.05); }
          70% { transform: scale(0.9); }
          100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in {
          animation: bounceIn 0.4s ease-out;
        }
      </style>

      <!-- SMS Apology Modal -->
      <div id="sms-apology-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div id="sms-apology-backdrop" class="absolute inset-0 bg-black/50"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900">Send Apology SMS</h3>
            <button id="close-apology-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">To:</label>
            <div id="apology-customer-info" class="text-sm text-gray-600 bg-gray-50 p-2 rounded-lg"></div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Message:</label>
            <textarea id="apology-message" rows="4" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"></textarea>
          </div>
          <div class="flex gap-3">
            <button id="cancel-apology-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-all">
              Cancel
            </button>
            <button id="send-apology-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-all">
              Send Apology
            </button>
          </div>
        </div>
      </div>

      <div class="p-6 space-y-6">

        <section id="dashboard" class="section">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                </div>
              </div>
              <div id="stat-reputation" class="text-3xl font-bold text-amber-600 flex items-center gap-1">
                4.8 <span class="text-lg">‚òÖ</span>
              </div>
              <div class="text-sm text-gray-500">Reputation Score</div>
            </div>

            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </div>
              </div>
              <div id="stat-total-customers" class="text-3xl font-bold text-gray-900">0</div>
              <div class="text-sm text-gray-500">Marketing List</div>
              <div id="trend-customers" class="text-xs text-green-600 mt-1">+5 this week</div>
            </div>

            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
              </div>
              <div id="stat-today" class="text-3xl font-bold text-gray-900">0</div>
              <div class="text-sm text-gray-500">Sent Today</div>
              <div id="trend-today" class="text-xs text-gray-500 mt-1">vs yesterday</div>
            </div>

            <div class="stat-card bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                </div>
              </div>
              <div id="stat-this-week" class="text-3xl font-bold text-gray-900">0</div>
              <div class="text-sm text-gray-500">Sent This Week</div>
              <div id="trend-week" class="text-xs text-green-600 mt-1">+12% vs last week</div>
            </div>
          </div>

          <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white rounded-xl border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between p-5 border-b border-gray-100">
                <div>
                  <h3 class="font-semibold text-gray-900">Recent Activity</h3>
                  <p class="text-sm text-gray-500">Real-time updates from your shop</p>
                </div>
                <button onclick="loadDashboard()" class="text-sm text-accent hover:text-indigo-700 font-medium">View All</button>
              </div>
              <div id="recent-messages" class="divide-y divide-gray-50 p-2 max-h-80 overflow-y-auto">
                <div class="text-center py-12 text-gray-500">Loading...</div>
              </div>
            </div>

            <div class="rounded-xl p-6 text-white" style="background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 50%, #4F46E5 100%);">
              <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              </div>
              <h3 class="text-xl font-bold italic mb-1">Quick Send</h3>
              <p class="text-white/80 text-sm mb-5">Instantly reach a customer without leaving the dashboard.</p>
              
              <div class="space-y-4">
                <div>
                  <label class="text-xs font-semibold text-white/90 uppercase tracking-wide block mb-2">Phone Number</label>
                  <input type="tel" id="quick-phone" placeholder="+1 (555) 000-0000" class="w-full px-4 py-3 rounded-lg bg-white text-gray-900 placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-white/50" />
                </div>
                <div>
                  <label class="text-xs font-semibold text-white/90 uppercase tracking-wide block mb-2">Message</label>
                  <select id="quick-template" class="w-full mb-2 px-4 py-2.5 rounded-lg bg-white text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-white/50">
                    <option value="">Select a template...</option>
                    <option value="pickup">üì¶ Device ready for pickup</option>
                    <option value="delayed">‚è≥ Repair delayed - will update soon</option>
                    <option value="review">‚≠ê Please leave us a review</option>
                    <option value="custom">‚úèÔ∏è Custom message</option>
                  </select>
                  <textarea id="quick-message" rows="3" placeholder="Your device is ready for pickup..." class="w-full px-4 py-3 rounded-lg bg-white text-gray-900 placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-white/50 resize-none"></textarea>
                </div>
                <button id="quick-send-btn" class="w-full py-2.5 bg-slate-900 hover:bg-slate-800 text-white font-medium rounded-full transition-colors text-sm flex items-center justify-center gap-2">
                  Send Notification
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="send-sms" class="section hidden">
          <div class="flex justify-center gap-8 mb-6">
            <div class="flex items-center gap-2">
              <span class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center text-sm font-bold">1</span>
              <span class="text-sm font-medium text-gray-900">Upload Receipt</span>
            </div>
            <div class="hidden sm:flex items-center">
              <div class="w-12 h-0.5 bg-gray-300"></div>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-bold" id="step-2-circle">2</span>
              <span class="text-sm text-gray-500" id="step-2-text">Review Customer</span>
            </div>
            <div class="hidden sm:flex items-center">
              <div class="w-12 h-0.5 bg-gray-300"></div>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-bold" id="step-3-circle">3</span>
              <span class="text-sm text-gray-500" id="step-3-text">Send Message</span>
            </div>
          </div>
          
          <div class="grid lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <div class="text-center mb-6">
                <div 
                  id="drop-zone"
                  class="drag-area border-2 border-dashed border-gray-300 rounded-xl p-10 cursor-pointer hover:border-accent transition-colors"
                >
                  <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                  </div>
                  <h3 class="font-semibold text-gray-900 mb-1">Drag & Drop Receipt</h3>
                  <p class="text-sm text-gray-500 mb-4">Supports JPG, HEIC, PNG</p>
                  <button id="browse-files-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    Browse Files
                  </button>
                  <input type="file" id="ocr-upload" accept="image/*" class="hidden" />
                </div>
              </div>

              <div class="flex gap-2 mb-4">
                <button id="camera-btn" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  Camera
                </button>
                <button id="repairdesk-import-btn" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium text-white transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                  </svg>
                  Import from POS
                </button>
              </div>

              <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-blue-900">Privacy First</p>
                    <p class="text-xs text-blue-700">Receipts are processed securely by OpenAI and are discarded immediately after extraction.</p>
                  </div>
                </div>
              </div>

              <div id="ocr-detected-section" class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleOcrSection()">
                  <div class="flex items-center gap-2">
                    <div class="text-xs font-medium text-amber-700 uppercase tracking-wide">Detected from Receipt</div>
                    <span id="ocr-confirmed-badge" class="hidden text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-medium">‚úì Confirmed</span>
                  </div>
                  <svg id="ocr-chevron" class="w-4 h-4 text-amber-600 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
                <div id="ocr-details" class="grid grid-cols-2 gap-2 text-sm mt-3">
                  <div><span class="text-amber-700">Name:</span> <span id="ocr-name" class="text-gray-900 font-medium">-</span></div>
                  <div><span class="text-amber-700">Phone:</span> <span id="ocr-phone" class="text-gray-900 font-medium">-</span></div>
                  <div><span class="text-amber-700">Device:</span> <span id="ocr-device" class="text-gray-900 font-medium">-</span></div>
                  <div><span class="text-amber-700">Repair:</span> <span id="ocr-repair" class="text-gray-900 font-medium">-</span></div>
                </div>
                <p id="ocr-empty-state" class="text-sm text-amber-600 mt-2 hidden">No receipt detected yet. Upload or take a photo to auto-fill customer details.</p>
              </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <div class="flex items-center gap-2 mb-1">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <h3 class="font-semibold text-gray-900">Customer Profile</h3>
              </div>
              <p class="text-xs text-gray-500 mb-5">Editable ‚Ä¢ Review carefully</p>

              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Customer Name</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </span>
                    <input type="text" id="customer-name" placeholder="Identify from receipt..." class="w-full pl-9 pr-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Phone Number</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                    </span>
                    <input type="tel" id="customer-phone" placeholder="+1..." class="w-full pl-9 pr-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Device</label>
                    <input type="text" id="device" placeholder="Device Model" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                  <div>
                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Cost</label>
                    <input type="text" id="cost" placeholder="$0.00" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Repair Type</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      </svg>
                    </span>
                    <input type="text" id="repair" placeholder="Service description..." class="w-full pl-9 pr-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent" />
                  </div>
                </div>

                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Message Type</label>
                  <select id="message-type" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent bg-white">
                    <option value="review">‚≠ê Google Review Request</option>
                    <option value="ready">üîî Device Ready for Pickup</option>
                    <option value="follow_up">üîÅ Follow-up Check-in</option>
                    <option value="custom">üí¨ Custom Message</option>
                  </select>
                </div>

                <div id="custom-message-container" class="hidden">
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Custom Message</label>
                  <textarea id="custom-message" rows="3" placeholder="Write your custom message..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent resize-none"></textarea>
                </div>

                <div class="bg-gray-50 rounded-lg p-3">
                  <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Message Preview</div>
                  <p id="message-preview" class="text-sm text-gray-700 leading-relaxed">Your message will appear here...</p>
                  <div class="text-xs text-gray-400 mt-2">Character count: <span id="char-count">0</span>/160</div>
                </div>

                <label class="flex items-start gap-3 p-3 bg-green-50 border border-green-200 rounded-lg cursor-pointer">
                  <input type="checkbox" id="sms-consent-checkbox" class="mt-0.5 rounded border-green-300 text-green-600 focus:ring-green-500" />
                  <span class="text-xs text-green-800 flex items-center gap-1.5">
                    Standard Repair Consent Verified
                    <span class="relative group">
                      <svg class="w-3.5 h-3.5 text-green-500 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                      <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">Covers standard repair intake consent forms.</span>
                    </span>
                  </span>
                </label>

                <button id="send-sms-btn" disabled class="w-full py-3 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2">
                  üì§ Send Welcome SMS
                </button>
                <p class="text-xs text-gray-500 mt-1 text-center">This will send an SMS immediately</p>
              </div>
            </div>
          </div>
        </section>

        <section id="history" class="section hidden">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between p-5 border-b border-gray-100">
              <div>
                <h3 class="font-semibold text-gray-900">Message History</h3>
                <p class="text-sm text-gray-500">Track all sent messages and follow-ups</p>
              </div>
              <div class="flex items-center gap-3">
                <button id="clear-history-filters" class="hidden px-3 py-2 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                  ‚úï Clear Filters
                </button>
                <select id="history-filter" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                  <option value="all">All Messages</option>
                  <option value="clicked">Clicked Links</option>
                  <option value="reviewed">With Feedback</option>
                  <option value="needs-followup">Needs Follow-up</option>
                </select>
              </div>
            </div>
            <div class="px-5 py-3 bg-gradient-to-r from-gray-50 to-slate-50 border-b border-gray-100">
              <div class="flex flex-wrap items-center gap-3">
                <span class="text-xs text-gray-500 font-semibold uppercase tracking-wide">Legend:</span>
                <div class="flex flex-wrap gap-2">
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                    <span class="w-1.5 h-1.5 bg-purple-500 rounded-full"></span> Review
                  </span>
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Clicked
                  </span>
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">
                    <span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span> Review Posted
                  </span>
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span> Sent
                  </span>
                </div>
              </div>
            </div>
            <div id="history-list" class="max-h-[500px] overflow-y-auto p-2">
              <div class="text-center py-12 text-gray-500">Loading...</div>
            </div>
          </div>
        </section>

        <section id="customers" class="section hidden">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between p-5 border-b border-gray-100">
              <div>
                <h3 class="font-semibold text-gray-900">Customer Database</h3>
                <p class="text-sm text-gray-500">Manage your customer contacts</p>
              </div>
            </div>
            <div id="customers-list" class="divide-y divide-gray-50 max-h-[500px] overflow-y-auto p-2">
              <div class="text-center py-12 text-gray-500">Loading...</div>
            </div>
          </div>
        </section>

        <section id="reviews" class="section hidden">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
              <div class="text-2xl font-bold text-amber-600" id="reviews-pending-count">0</div>
              <div class="text-sm text-gray-500">Pending Reviews</div>
            </div>
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
              <div class="text-2xl font-bold text-green-600" id="reviews-posted-count">0</div>
              <div class="text-sm text-gray-500">Posted Replies</div>
            </div>
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
              <div class="text-2xl font-bold text-gray-600" id="reviews-ignored-count">0</div>
              <div class="text-sm text-gray-500">Ignored</div>
            </div>
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
              <div class="text-2xl font-bold text-yellow-500" id="reviews-avg-rating">-</div>
              <div class="text-sm text-gray-500">Avg Rating</div>
            </div>
          </div>

          <div class="flex items-center justify-between mb-4">
            <div class="flex gap-2">
              <button data-action="filterReviews" data-status="pending" class="reviews-filter-btn px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-lg">Pending</button>
              <button data-action="filterReviews" data-status="posted" class="reviews-filter-btn px-4 py-2 bg-white border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-50">Posted</button>
              <button data-action="filterReviews" data-status="ignored" class="reviews-filter-btn px-4 py-2 bg-white border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-50">Ignored</button>
              <button data-action="filterReviews" data-status="all" class="reviews-filter-btn px-4 py-2 bg-white border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-50">All</button>
            </div>
            <div class="flex items-center gap-2">
              <button id="manual-ai-reply-btn" class="px-4 py-2.5 bg-accent hover:bg-indigo-600 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                Draft Manual Reply
              </button>
              <button onclick="loadGoogleReviews()" class="px-3 py-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="Refresh">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>
            </div>
          </div>

          <div id="google-reviews-list" class="space-y-4">
            <div class="text-center py-12 text-gray-500">Loading reviews...</div>
          </div>

          <div id="ai-reply-assistant-panel" class="bg-white rounded-xl border border-gray-100 shadow-sm p-6 mt-6 hidden">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="font-semibold text-gray-900 mb-1">AI Review Reply Assistant</h3>
                <p class="text-sm text-gray-500">Generate professional, SEO-optimized responses for Google Reviews</p>
              </div>
              <button onclick="hideAIReplyPanel()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" title="Close">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Customer Name</label>
                  <input type="text" id="ai-customer-name" placeholder="Enter reviewer name..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Star Rating</label>
                  <select id="ai-star-rating" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-accent bg-white">
                    <option value="">Select rating...</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars</option>
                    <option value="2">‚≠ê‚≠ê 2 Stars</option>
                    <option value="1">‚≠ê 1 Star</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Review Text</label>
                  <textarea id="ai-review-text" rows="4" placeholder="Paste the customer's review text here..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-accent resize-none"></textarea>
                </div>
                <button id="generate-reply-btn" class="w-full py-3 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  Generate AI Reply
                </button>
              </div>

              <div id="ai-reply-container" class="hidden">
                <div class="bg-gray-900 rounded-xl p-5 h-full">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-green-400 uppercase tracking-wide">AI Drafted Response</span>
                    <div class="flex gap-2">
                      <button id="copy-reply-btn" class="p-1.5 rounded-lg bg-gray-700 text-gray-300 hover:text-white transition-colors" title="Copy to clipboard">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <p id="ai-reply-text" class="text-white text-sm leading-relaxed"></p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="bulk-sms" class="section hidden">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="font-semibold text-gray-900">Bulk Review Sender</h3>
                <p class="text-sm text-gray-500">Send review requests to multiple customers</p>
              </div>
            </div>

            <div class="flex border-b border-gray-200 mb-4">
              <button id="bulk-tab-tickets" class="px-4 py-2 text-sm font-medium text-purple-600 border-b-2 border-purple-600 -mb-px" onclick="switchBulkTab('tickets')">
                RepairDesk Tickets
              </button>
              <button id="bulk-tab-followup" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchBulkTab('followup')">
                Needs Follow-up
                <span id="followup-count-badge" class="ml-1 px-2 py-0.5 text-xs bg-amber-100 text-amber-700 rounded-full hidden">0</span>
              </button>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
              <span class="text-xs font-medium text-gray-500 self-center mr-1">Quick Filters:</span>
              <button id="filter-high-value" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-purple-200 bg-purple-50 text-purple-700 hover:bg-purple-100 transition-colors flex items-center gap-1.5" data-filter="high-value">
                <span>&#128142;</span> High Value Repairs
              </button>
              <button id="filter-iphone" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-green-200 bg-green-50 text-green-700 hover:bg-green-100 transition-colors flex items-center gap-1.5" data-filter="iphone">
                <span>&#127823;</span> iPhone Users
              </button>
              <button id="filter-last30" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors flex items-center gap-1.5" data-filter="last30">
                <span>&#128197;</span> Last 30 Days
              </button>
              <button id="filter-clear" class="quick-filter-btn px-3 py-1.5 text-xs font-medium rounded-full border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 transition-colors hidden" data-filter="clear">
                &#10005; Clear Filter
              </button>
            </div>

            <div id="bulk-tickets-panel">
              <div class="flex items-center gap-3 mb-4 flex-wrap">
                <div class="relative flex-1 min-w-[200px]">
                  <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <input type="text" id="bulk-search-input" placeholder="Search device or name..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" />
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="bulk-completed-toggle" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                  <span class="ml-2 text-sm font-medium text-gray-700">Completed Only</span>
                </label>
                <button id="bulk-refresh-btn" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="Refresh tickets">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
              </div>

            <div id="bulk-tickets-loading" class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
              <p class="mt-2 text-gray-500">Loading tickets from RepairDesk...</p>
            </div>

            <div id="bulk-tickets-error" class="hidden text-center py-8">
              <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-red-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <p class="text-red-600 font-medium">Failed to load tickets</p>
              <p id="bulk-tickets-error-msg" class="text-sm text-gray-500 mt-1"></p>
            </div>

            <div id="bulk-tickets-list" class="hidden space-y-2 max-h-[800px] overflow-y-auto">
            </div>

            <div id="bulk-selection-bar" class="hidden mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
              <div class="mb-3">
                <label class="block text-sm font-medium text-purple-800 mb-1">Campaign Message:</label>
                <textarea id="campaign-message" rows="3" class="w-full px-3 py-2 border border-purple-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Hi {name}! Thank you for choosing us. We'd love to hear about your experience..."></textarea>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-purple-700 font-medium"><span id="bulk-selected-count">0</span>/5 selected</span>
                </div>
                <button id="bulk-send-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                  Launch Reactivation Campaign
                </button>
              </div>
            </div>
            </div>

            <div id="bulk-followup-panel" class="hidden">
              <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <p class="text-sm text-amber-800">
                  <span class="font-medium">Smart Follow-up:</span> Customers who received SMS 24+ hours ago but haven't clicked the review link.
                </p>
              </div>

              <div id="followup-loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600"></div>
                <p class="mt-2 text-gray-500">Loading customers needing follow-up...</p>
              </div>

              <div id="followup-empty" class="hidden text-center py-8">
                <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-green-100 flex items-center justify-center">
                  <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
                <p class="text-gray-600 font-medium">All caught up!</p>
                <p class="text-sm text-gray-500 mt-1">No customers need follow-up right now.</p>
              </div>

              <div id="followup-list" class="hidden space-y-2 max-h-[600px] overflow-y-auto">
              </div>

              <div id="followup-selection-bar" class="hidden mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-amber-700 font-medium"><span id="followup-selected-count">0</span>/5 selected</span>
                </div>
                <button id="followup-send-btn" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                  Send Reminders
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="billing" class="section hidden">
          <div class="grid md:grid-cols-2 gap-6">
            <div id="starter-plan-card" class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <h3 class="font-semibold text-gray-900 mb-1">Starter Plan</h3>
              <div class="flex items-baseline gap-1 mb-4">
                <span class="text-3xl font-bold text-gray-900">$29</span>
                <span class="text-gray-500">/month</span>
              </div>
              <ul class="space-y-2 mb-6 text-sm text-gray-600">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  500 SMS per month
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  OCR Receipt Scanning
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Review Link Tracking
                </li>
              </ul>
              <button id="subscribe-starter-btn" class="w-full py-2.5 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors">
                Subscribe to Starter
              </button>
            </div>

            <div id="pro-plan-card" class="bg-white rounded-xl border-2 border-accent shadow-sm p-6 relative">
              <span class="absolute -top-3 left-4 px-3 py-1 bg-accent text-white text-xs font-medium rounded-full">Popular</span>
              <h3 class="font-semibold text-gray-900 mb-1">Pro Plan</h3>
              <div class="flex items-baseline gap-1 mb-4">
                <span class="text-3xl font-bold text-gray-900">$79</span>
                <span class="text-gray-500">/month</span>
              </div>
              <ul class="space-y-2 mb-6 text-sm text-gray-600">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  2,000 SMS per month
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  AI Review Reply Assistant
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Telegram Bot Integration
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Priority Support
                </li>
              </ul>
              <button id="subscribe-pro-btn" class="w-full py-2.5 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors">
                Subscribe to Pro
              </button>
            </div>
          </div>
        </section>

        <section id="feedback" class="section hidden">
          <div class="flex gap-4">
            <div class="w-[60%] bg-white rounded-xl border border-gray-100 shadow-sm">
              <div class="p-5 border-b border-gray-100">
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <h3 class="font-semibold text-gray-900">Feedback Inbox</h3>
                    <p class="text-sm text-gray-500">Internal feedback from customers (1-3 star ratings)</p>
                  </div>
                </div>
                <div class="flex gap-4 mb-4">
                  <span class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm" id="feedback-unread-count">0 Unread</span>
                  <span class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm" id="feedback-avg-rating">Avg. Rating: 0 ‚≠ê</span>
                  <select id="feedback-sort" class="border rounded px-2 py-1 text-sm ml-auto">
                    <option value="newest">Newest</option>
                    <option value="oldest">Oldest</option>
                    <option value="rating">Rating</option>
                  </select>
                </div>
                <div class="flex gap-2 border-b -mx-5 px-5">
                  <button data-filter="all" class="feedback-tab px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium">All</button>
                  <button data-filter="unread" class="feedback-tab px-4 py-2 text-gray-500 hover:text-gray-700 border-b-2 border-transparent">Unread</button>
                  <button data-filter="in_progress" class="feedback-tab px-4 py-2 text-gray-500 hover:text-gray-700 border-b-2 border-transparent">In Progress</button>
                  <button data-filter="resolved" class="feedback-tab px-4 py-2 text-gray-500 hover:text-gray-700 border-b-2 border-transparent">Resolved</button>
                </div>
              </div>
              <div id="feedback-list" class="divide-y divide-gray-50 max-h-[500px] overflow-y-auto p-2">
                <div class="text-center py-12 text-gray-500">Loading...</div>
              </div>
            </div>
          </div>
          
          <!-- Feedback Response Panel (hidden by default, slides in from right) -->
          <div id="feedback-panel" class="hidden fixed top-0 right-0 w-96 h-full bg-white shadow-xl border-l z-50 overflow-y-auto transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
              <h3 class="font-bold text-lg">Respond to Feedback</h3>
              <button class="close-feedback-panel-btn text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <div id="feedback-panel-content" class="p-4">
              <!-- Content will be populated by openFeedbackPanel() -->
            </div>
          </div>
          <!-- Overlay for slide-in panel -->
          <div id="feedback-panel-overlay" class="hidden fixed inset-0 bg-black bg-opacity-30 z-40" onclick="closeFeedbackPanel()"></div>
        </section>

        <section id="settings" class="section hidden">
          <div class="grid lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <h3 class="font-semibold text-gray-900 mb-1">Business Settings</h3>
              <p class="text-sm text-gray-500 mb-5">Configure your business profile and SMS templates</p>

              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Business Name</label>
                  <input type="text" id="settings-business-name" placeholder="Your Business Name" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Google Review Link</label>
                  <input type="url" id="settings-review-link" placeholder="https://g.page/r/..." class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">SMS Template</label>
                  <textarea id="settings-sms-template" rows="3" placeholder="Hi {name}, thanks for visiting {business}! Please review us here: {link}" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent resize-none"></textarea>
                </div>
                <div class="flex items-center justify-between py-3 px-4 bg-gray-50 rounded-lg border border-gray-200">
                  <div>
                    <label class="text-sm font-medium text-gray-900 block">Admin Password Protection</label>
                    <p class="text-xs text-gray-500 mt-0.5">Require admin password for sensitive data access</p>
                  </div>
                  <button type="button" id="admin-auth-toggle" role="switch" aria-checked="false" class="relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-gray-300" onclick="toggleAdminAuth()">
                    <span id="admin-auth-toggle-dot" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                  </button>
                </div>
                <button id="save-settings-btn" class="w-full py-2.5 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors">
                  Save Settings
                </button>
              </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
              <div class="flex items-center justify-between mb-1">
                <h3 class="font-semibold text-gray-900">Telegram Bot</h3>
                <span id="telegram-status-badge" class="px-2 py-1 rounded-full text-[10px] font-medium bg-gray-100 text-gray-600">
                  Not Configured
                </span>
              </div>
              <p class="text-sm text-gray-500 mb-5">Connect your Telegram bot for review approval notifications</p>

              <div class="space-y-4">
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Bot Token</label>
                  <input type="password" id="telegram-bot-token" placeholder="Enter your Telegram Bot Token from @BotFather" autocomplete="new-password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div>
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">Chat ID</label>
                  <input type="text" id="telegram-chat-id" placeholder="Your Telegram Chat ID" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent" />
                </div>
                <div class="flex gap-2">
                  <button id="save-telegram-btn" class="flex-1 py-2.5 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors">
                    Save Telegram Settings
                  </button>
                  <button id="test-telegram-btn" disabled class="px-4 py-2.5 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50">
                    Test
                  </button>
                </div>
                <button id="disconnect-telegram-btn" class="hidden w-full py-2 text-sm text-red-600 hover:text-red-700 font-medium">
                  Disconnect Telegram Bot
                </button>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <script>
    let businessName = 'Our Store';
    
    // Forward declarations for onclick handlers - these get defined later but need to be callable
    window.sendReminder = async function() { console.error('sendReminder not yet loaded'); };
    window.loadCustomerData = function() { console.error('loadCustomerData not yet loaded'); };
    window.markFeedbackRead = async function() { console.error('markFeedbackRead not yet loaded'); };
    
    // Tab switching for Bulk SMS - defined early for onclick handlers
    let currentBulkTab = 'tickets';
    window.switchBulkTab = function(tab) {
      console.log('[DEBUG] switchBulkTab called with:', tab);
      currentBulkTab = tab;
      const ticketsTab = document.getElementById('bulk-tab-tickets');
      const followupTab = document.getElementById('bulk-tab-followup');
      const ticketsPanel = document.getElementById('bulk-tickets-panel');
      const followupPanel = document.getElementById('bulk-followup-panel');
      
      if (!ticketsTab || !followupTab || !ticketsPanel || !followupPanel) {
        console.error('[ERROR] Tab elements not found');
        return;
      }

      if (tab === 'tickets') {
        ticketsTab.className = 'px-4 py-2 text-sm font-medium text-purple-600 border-b-2 border-purple-600 -mb-px';
        followupTab.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        ticketsPanel.classList.remove('hidden');
        followupPanel.classList.add('hidden');
      } else {
        ticketsTab.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        followupTab.className = 'px-4 py-2 text-sm font-medium text-amber-600 border-b-2 border-amber-600 -mb-px';
        ticketsPanel.classList.add('hidden');
        followupPanel.classList.remove('hidden');
        if (typeof loadFollowupCustomers === 'function') {
          loadFollowupCustomers();
        }
      }
    };

    function showNotification(message, type = 'info') {
      const container = document.getElementById('notification-container');
      const messageEl = document.getElementById('notification-message');
      const textEl = document.getElementById('notification-text');
      const iconEl = document.getElementById('notification-icon');

      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-amber-500'
      };

      const icons = {
        success: '‚úì',
        error: '‚úï',
        info: '‚Ñπ',
        warning: '‚ö†'
      };

      messageEl.className = `rounded-lg shadow-lg px-4 py-3 text-sm font-medium text-white flex items-center gap-2 ${colors[type] || colors.info}`;
      iconEl.textContent = icons[type] || icons.info;
      textEl.textContent = message;

      container.classList.remove('hidden');
      setTimeout(() => container.classList.add('hidden'), 4000);
    }
    
    // Big centered error modal - impossible to miss!
    function showErrorModal(message) {
      const modal = document.getElementById('error-modal');
      const messageEl = document.getElementById('error-modal-message');
      messageEl.textContent = message || 'An error occurred. Please try again.';
      modal.classList.remove('hidden');
    }
    
    function closeErrorModal() {
      document.getElementById('error-modal').classList.add('hidden');
    }
    
    // Set up error modal close handlers
    document.getElementById('error-modal-close-btn')?.addEventListener('click', closeErrorModal);
    document.getElementById('error-modal-backdrop')?.addEventListener('click', closeErrorModal);

    // Mobile sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    function openSidebar() {
      sidebar.classList.add('open');
    }
    
    window.closeSidebar = function() {
      sidebar.classList.remove('open');
    }
    
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', openSidebar);
    }

    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');
    const pageTitle = document.getElementById('page-title');
    const pageSubtitle = document.getElementById('page-subtitle');

    const pageTitles = {
      'dashboard': { title: 'Dashboard', subtitle: 'Overview of your messaging and reviews.' },
      'send-sms': { title: 'New Customer Onboarding', subtitle: 'Upload a receipt to auto-fill details. Review and correct AI data before saving.' },
      'bulk-sms': { title: 'Campaigns', subtitle: 'Launch targeted reactivation campaigns for your customers.' },
      'history': { title: 'Message History', subtitle: 'Track all sent messages and customer interactions.' },
      'customers': { title: 'Customer Database', subtitle: 'Manage your customer contacts and profiles.' },
      'reviews': { title: 'Review Inbox', subtitle: 'Manage incoming reviews and approve AI responses.' },
      'billing': { title: 'Billing & Plans', subtitle: 'Manage your subscription and billing details.' },
      'feedback': { title: 'Feedback Inbox', subtitle: 'Internal feedback from customers requiring attention.' },
      'settings': { title: 'Settings', subtitle: 'Configure your business profile and integrations.' }
    };

    function showSection(sectionId) {
      sections.forEach(s => s.classList.add('hidden'));
      navItems.forEach(n => {
        n.classList.remove('active');
        n.classList.add('text-slate-300');
        n.classList.remove('text-white');
      });

      const targetSection = document.getElementById(sectionId);
      const targetNav = document.querySelector(`[data-section="${sectionId}"]`);

      if (targetSection) targetSection.classList.remove('hidden');
      if (targetNav) {
        targetNav.classList.add('active');
        targetNav.classList.remove('text-slate-300');
        targetNav.classList.add('text-white');
      }

      const pageInfo = pageTitles[sectionId] || { title: 'Page', subtitle: '' };
      pageTitle.textContent = pageInfo.title;
      pageSubtitle.textContent = pageInfo.subtitle;

      if (sectionId === 'dashboard') loadDashboard();
      if (sectionId === 'history') loadHistory();
      if (sectionId === 'customers') loadCustomers();
      if (sectionId === 'feedback') loadFeedback();
      if (sectionId === 'reviews') loadGoogleReviews();
      if (sectionId === 'settings') { loadSettings(); loadTelegramConfig(); }
      if (sectionId === 'billing') updateSubscriptionDisplay();
    }

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const sectionId = item.dataset.section;
        showSection(sectionId);
        closeSidebar(); // Close sidebar on mobile after selection
      });
    });

    document.getElementById('new-message-btn').addEventListener('click', () => showSection('send-sms'));
    
    document.getElementById('quick-template')?.addEventListener('change', (e) => {
      const templates = {
        'pickup': 'Hi! Your device is ready for pickup at Techy Miramar. See you soon!',
        'delayed': "Hi, we wanted to let you know your repair is taking a bit longer than expected. We'll update you as soon as it's ready.",
        'review': 'Thanks for choosing Techy Miramar! If you were happy with our service, we\'d love a Google review: [Link]',
        'custom': ''
      };
      const message = templates[e.target.value] || '';
      document.getElementById('quick-message').value = message;
    });
    
    document.getElementById('quick-send-btn').addEventListener('click', async () => {
      const phone = document.getElementById('quick-phone').value.trim();
      const message = document.getElementById('quick-message').value.trim();
      
      if (!phone) {
        showNotification('Please enter a phone number', 'error');
        return;
      }
      if (!message) {
        showNotification('Please enter a message', 'error');
        return;
      }
      
      const btn = document.getElementById('quick-send-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...';
      btn.disabled = true;
      
      try {
        const response = await fetch('/api/send-sms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customerPhone: phone,
            customerName: 'Quick Send',
            messageType: 'ready',
            customMessage: message,
            smsConsentConfirmed: true
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Message sent successfully!', 'success');
          document.getElementById('quick-phone').value = '';
          document.getElementById('quick-message').value = '';
          loadDashboard();
        } else {
          showNotification(data.error || 'Failed to send message', 'error');
        }
      } catch (error) {
        console.error('Quick send error:', error);
        showNotification('Failed to send message', 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    });

    async function loadDashboard() {
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        if (data.success && data.stats) {
          document.getElementById('stat-total-customers').textContent = data.stats.totalCustomers || 0;
          document.getElementById('stat-today').textContent = data.stats.todayMessages || 0;
          document.getElementById('stat-this-week').textContent = data.stats.weekMessages || 0;
          
          const container = document.getElementById('recent-messages');
          if (data.stats.recentMessages && data.stats.recentMessages.length > 0) {
            container.innerHTML = data.stats.recentMessages.map(msg => `
              <div class="group flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div class="w-10 h-10 rounded-full ${msg.message_type === 'review' ? 'bg-amber-100' : 'bg-green-100'} flex items-center justify-center flex-shrink-0">
                  ${msg.message_type === 'review' ? '<span class="text-amber-600">‚≠ê</span>' : '<span class="text-green-600">üì±</span>'}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-gray-900 truncate">${getMessageTypeTitle(msg.message_type)}</div>
                  <div class="text-sm text-gray-500 truncate">${msg.customer_name}</div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                    ${msg.message_type === 'review' 
                      ? `<button onclick="showSection('customers')" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="View Customer">üë§</button>
                         <button onclick="showSection('reviews')" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="Reply">‚Ü©Ô∏è</button>`
                      : `<button class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="Resend">üì§</button>
                         <button onclick="showSection('customers')" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="View Customer">üë§</button>`
                    }
                  </div>
                  <div class="text-xs text-gray-400">${getTimeAgo(msg.sent_at)}</div>
                </div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<div class="text-center py-8"><p class="text-sm text-gray-500">No recent activity</p><p class="text-xs text-gray-400 mt-1">Send your first message to get started!</p></div>';
          }
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('recent-messages').innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No recent activity</p>';
      }
    }

    function getMessageTypeTitle(type) {
      const titles = {
        'review': 'New Review Request',
        'ready': 'Pickup Notification',
        'follow_up': 'Follow-up Sent',
        'custom': 'Custom Message'
      };
      return titles[type] || 'SMS Sent';
    }

    function getTimeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return 'Just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    function getMessageTypeLabel(type) {
      const labels = {
        'review': '‚≠ê Review',
        'ready': 'üîî Pickup',
        'follow_up': 'üîÅ Follow-up',
        'custom': 'üí¨ Custom'
      };
      return labels[type] || type;
    }

    function getDateGroup(dateStr) {
      const date = new Date(dateStr);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      const isToday = date.toDateString() === today.toDateString();
      const isYesterday = date.toDateString() === yesterday.toDateString();
      
      if (isToday) return 'Today';
      if (isYesterday) return 'Yesterday';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function groupMessagesByDate(messages) {
      const groups = {};
      messages.forEach(msg => {
        const group = getDateGroup(msg.sent_at);
        if (!groups[group]) groups[group] = [];
        groups[group].push(msg);
      });
      
      // Sort groups chronologically (newest first)
      const sortedGroups = {};
      const sortedKeys = Object.keys(groups).sort((a, b) => {
        if (a === 'Today') return -1;
        if (b === 'Today') return 1;
        if (a === 'Yesterday') return -1;
        if (b === 'Yesterday') return 1;
        return new Date(b) - new Date(a);
      });
      sortedKeys.forEach(key => { sortedGroups[key] = groups[key]; });
      return sortedGroups;
    }

    async function loadHistory() {
      try {
        const response = await fetch('/api/messages');
        const data = await response.json();
        
        const container = document.getElementById('history-list');
        const filterValue = document.getElementById('history-filter').value;
        const clearBtn = document.getElementById('clear-history-filters');
        
        // Show/hide clear filters button
        if (filterValue !== 'all') {
          clearBtn.classList.remove('hidden');
        } else {
          clearBtn.classList.add('hidden');
        }
        
        let messages = data.success && data.messages ? data.messages : [];
        const totalMessages = messages.length;
        
        if (filterValue === 'clicked') {
          messages = messages.filter(m => m.review_link_clicked_at);
        } else if (filterValue === 'reviewed') {
          messages = messages.filter(m => m.feedback_rating);
        } else if (filterValue === 'needs-followup') {
          messages = messages.filter(m => m.review_link_clicked_at && !m.feedback_rating && !m.follow_up_sent_at);
        }
        
        if (messages.length > 0) {
          const groupedMessages = groupMessagesByDate(messages);
          let html = '';
          
          for (const [dateLabel, msgs] of Object.entries(groupedMessages)) {
            html += `<div class="text-sm font-medium text-gray-500 py-2 px-3 border-b border-gray-100 bg-gray-50 sticky top-0">${dateLabel}</div>`;
            html += '<div class="divide-y divide-gray-50">';
            
            msgs.forEach(msg => {
              const deviceDisplay = msg.customer_device ? `<span class="text-xs rounded-full bg-slate-100 text-slate-600 px-2 py-0.5">${msg.customer_device}</span>` : '';
              
              // Status badge logic: Review Posted > Clicked > Sent
              let statusBadge = '<span class="text-xs rounded-full bg-gray-100 text-gray-600 px-2 py-0.5">Sent</span>';
              if (msg.review_received_at || msg.feedback_rating) {
                statusBadge = '<span class="text-xs rounded-full bg-amber-100 text-amber-700 px-2 py-0.5 font-medium">Review Posted</span>';
              } else if (msg.review_link_clicked_at) {
                statusBadge = '<span class="text-xs rounded-full bg-green-100 text-green-700 px-2 py-0.5 font-medium">Clicked</span>';
              }
              
              // Determine hover action based on message state
              let hoverAction = '';
              if (msg.message_type === 'apology') {
                // Apology message - show View Feedback button
                hoverAction = `
                  <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                    <button data-action="viewFeedback" data-id="${msg.id}" class="text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 transition-colors">
                      üìã View Feedback
                    </button>
                  </div>`;
              } else if (msg.review_link_clicked_at && !msg.feedback_rating && !msg.follow_up_sent_at) {
                // Clicked but no review - show Send Reminder
                hoverAction = `
                  <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                    <button data-action="sendReminder" data-id="${msg.id}" data-name="${msg.customer_name.replace(/"/g, '&quot;')}" data-phone="${msg.customer_phone}" data-link="${msg.review_link || ''}" class="text-xs px-2 py-1 bg-purple-100 text-purple-600 rounded hover:bg-purple-200 transition-colors">
                      üì© Send Reminder
                    </button>
                  </div>`;
              } else if (!msg.review_link_clicked_at && msg.message_type !== 'apology') {
                // Not clicked - show Resend button
                hoverAction = `
                  <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                    <button data-action="resendMessage" data-id="${msg.id}" data-name="${msg.customer_name.replace(/"/g, '&quot;')}" data-phone="${msg.customer_phone}" class="text-xs px-2 py-1 bg-purple-100 text-purple-600 rounded hover:bg-purple-200 transition-colors">
                      üîÑ Resend
                    </button>
                  </div>`;
              }
              
              html += `
              <div class="group flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0">
                  <span class="text-gray-600">${msg.customer_name.charAt(0).toUpperCase()}</span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="font-medium text-gray-900">${msg.customer_name}</span>
                    ${deviceDisplay}
                    <span class="text-xs rounded-full bg-indigo-50 text-indigo-700 px-2 py-0.5">${getMessageTypeLabel(msg.message_type)}</span>
                    ${statusBadge}
                  </div>
                  <div class="text-sm text-gray-500">${msg.customer_phone} ‚Ä¢ ${getTimeAgo(msg.sent_at)}</div>
                </div>
                ${hoverAction}
              </div>`;
            });
            html += '</div>';
          }
          
          container.innerHTML = html;
        } else {
          // Empty states with helpful messages
          let emptyState = '';
          if (totalMessages === 0) {
            emptyState = `
              <div class="text-center py-16 px-4">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                </div>
                <h4 class="font-medium text-gray-900 mb-1">No messages sent yet</h4>
                <p class="text-sm text-gray-500">Send your first review request to get started!</p>
              </div>`;
          } else if (filterValue === 'needs-followup') {
            emptyState = `
              <div class="text-center py-16 px-4">
                <div class="text-4xl mb-3">üéâ</div>
                <h4 class="font-medium text-gray-900 mb-1">All caught up!</h4>
                <p class="text-sm text-gray-500">No follow-ups needed right now.</p>
              </div>`;
          } else {
            emptyState = `
              <div class="text-center py-16 px-4">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                  </svg>
                </div>
                <h4 class="font-medium text-gray-900 mb-1">No messages match these filters</h4>
                <p class="text-sm text-gray-500 mb-3">Try adjusting your selection or clear filters to see all messages.</p>
                <button onclick="document.getElementById('history-filter').value='all'; loadHistory();" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                  Clear Filters
                </button>
              </div>`;
          }
          container.innerHTML = emptyState;
        }
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    // Clear filters button handler
    document.getElementById('clear-history-filters').addEventListener('click', function() {
      document.getElementById('history-filter').value = 'all';
      loadHistory();
    });

    document.getElementById('history-filter').addEventListener('change', loadHistory);

    function generateMockLastVisit() {
      const daysAgo = Math.floor(Math.random() * 30) + 1;
      const date = new Date();
      date.setDate(date.getDate() - daysAgo);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    async function loadCustomers() {
      try {
        const response = await fetch('/api/customers');
        const data = await response.json();
        
        const container = document.getElementById('customers-list');
        if (data.success && data.customers && data.customers.length > 0) {
          container.innerHTML = data.customers.map(customer => {
            const lastVisit = customer.last_visit ? new Date(customer.last_visit).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : generateMockLastVisit();
            return `
            <div class="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center flex-shrink-0">
                <span class="text-white font-medium">${customer.name.charAt(0).toUpperCase()}</span>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-medium text-gray-900">${customer.name}</div>
                <div class="text-sm text-gray-500">${customer.phone} ‚Ä¢ ${customer.message_count || 0} messages</div>
              </div>
              <div class="text-center px-3">
                <div class="text-xs text-gray-400 uppercase">Last Visit</div>
                <div class="text-sm font-medium text-gray-600">${lastVisit}</div>
              </div>
              <div class="flex gap-2">
                <button data-action="loadCustomerData" data-name="${customer.name.replace(/"/g, '&quot;')}" data-phone="${customer.phone}" class="px-3 py-1.5 text-xs border border-accent text-accent rounded-lg hover:bg-indigo-50 transition-colors">
                  Use in Form
                </button>
                <button data-action="reactivateCustomer" data-name="${customer.name.replace(/"/g, '&quot;')}" data-phone="${customer.phone}" class="px-3 py-1.5 text-xs bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">
                  Reactivate
                </button>
              </div>
            </div>
          `;}).join('');
        } else {
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-12">No customers yet</p>';
        }
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    window.loadCustomerData = function loadCustomerData(name, phone) {
      document.getElementById('customer-name').value = name;
      document.getElementById('customer-phone').value = phone;
      showSection('send-sms');
      showNotification('Customer data loaded!', 'success');
    }

    let allFeedback = [];
    let currentFeedbackFilter = 'all';
    let currentFeedbackSort = 'newest';
    
    async function loadFeedback() {
      try {
        const response = await fetch('/api/feedback');
        const data = await response.json();
        
        if (data.success && data.feedback) {
          allFeedback = data.feedback;
          updateFeedbackStats();
          renderFeedbackList();
        } else {
          allFeedback = [];
          updateFeedbackStats();
          renderFeedbackList();
        }
      } catch (error) {
        console.error('Error loading feedback:', error);
      }
    }
    
    function updateFeedbackStats() {
      const unreadCount = allFeedback.filter(fb => fb.status === 'unread' || (!fb.is_read && fb.status !== 'read')).length;
      const avgRating = allFeedback.length > 0 
        ? (allFeedback.reduce((sum, fb) => sum + fb.rating, 0) / allFeedback.length).toFixed(1) 
        : 0;
      
      document.getElementById('feedback-unread-count').textContent = `${unreadCount} Unread`;
      document.getElementById('feedback-avg-rating').textContent = `Avg. Rating: ${avgRating} ‚≠ê`;
    }
    
    function getRelativeTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      const diffWeeks = Math.floor(diffDays / 7);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hr ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      if (diffWeeks < 4) return `${diffWeeks} week${diffWeeks > 1 ? 's' : ''} ago`;
      return date.toLocaleDateString();
    }
    
    function groupFeedbackByCustomer(feedbackList) {
      const grouped = {};
      feedbackList.forEach(fb => {
        const key = fb.customer_phone;
        if (!grouped[key]) {
          grouped[key] = [];
        }
        grouped[key].push(fb);
      });
      return grouped;
    }
    
    function toggleCustomerHistory(phone) {
      const historyEl = document.getElementById(`history-${phone.replace(/[^a-zA-Z0-9]/g, '')}`);
      if (historyEl) {
        historyEl.classList.toggle('hidden');
      }
    }
    window.toggleCustomerHistory = toggleCustomerHistory;
    
    function toggleOcrSection() {
      const details = document.getElementById('ocr-details');
      const chevron = document.getElementById('ocr-chevron');
      if (details && chevron) {
        details.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
      }
    }
    window.toggleOcrSection = toggleOcrSection;
    
    function confirmOcrFields() {
      const badge = document.getElementById('ocr-confirmed-badge');
      if (badge) badge.classList.remove('hidden');
      const step2Circle = document.getElementById('step-2-circle');
      const step2Text = document.getElementById('step-2-text');
      if (step2Circle) {
        step2Circle.classList.remove('bg-gray-300', 'text-gray-600');
        step2Circle.classList.add('bg-purple-500', 'text-white');
      }
      if (step2Text) {
        step2Text.classList.remove('text-gray-500');
        step2Text.classList.add('text-gray-900', 'font-medium');
      }
    }
    window.confirmOcrFields = confirmOcrFields;
    
    let openMenuId = null;
    
    function toggleFeedbackMenu(feedbackId, event) {
      event.stopPropagation();
      const menu = document.getElementById(`feedback-menu-${feedbackId}`);
      
      // Close any other open menus
      if (openMenuId && openMenuId !== feedbackId) {
        const prevMenu = document.getElementById(`feedback-menu-${openMenuId}`);
        if (prevMenu) prevMenu.classList.add('hidden');
      }
      
      if (menu) {
        menu.classList.toggle('hidden');
        openMenuId = menu.classList.contains('hidden') ? null : feedbackId;
      }
    }
    window.toggleFeedbackMenu = toggleFeedbackMenu;
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (openMenuId && !e.target.closest(`#feedback-menu-${openMenuId}`) && !e.target.closest(`[onclick*="toggleFeedbackMenu"]`)) {
        const menu = document.getElementById(`feedback-menu-${openMenuId}`);
        if (menu) menu.classList.add('hidden');
        openMenuId = null;
      }
    });
    
    let selectedFeedbackCustomer = null;
    
    function openFeedbackPanel(phone) {
      const panel = document.getElementById('feedback-panel');
      const contentDiv = document.getElementById('feedback-panel-content');
      
      if (!panel || !contentDiv) {
        showNotification('Error: Panel not found', 'error');
        return;
      }
      
      const grouped = groupFeedbackByCustomer(allFeedback);
      const customerFeedback = grouped[phone] || [];
      
      if (customerFeedback.length === 0) {
        showNotification('No feedback found for this customer', 'error');
        return;
      }
      
      selectedFeedbackCustomer = { phone, feedback: customerFeedback };
      const latest = customerFeedback[0];
      const avgRating = (customerFeedback.reduce((sum, f) => sum + f.rating, 0) / customerFeedback.length).toFixed(1);
      
      let sentimentEmoji = 'üò†', sentimentText = 'Very unhappy', avatarBg = 'bg-red-100', textColor = 'text-red-600';
      if (avgRating > 2.5) {
        sentimentEmoji = 'üòê'; sentimentText = 'Neutral'; avatarBg = 'bg-yellow-100'; textColor = 'text-yellow-600';
      } else if (avgRating > 1.5) {
        sentimentEmoji = 'üòü'; sentimentText = 'Unhappy'; avatarBg = 'bg-orange-100'; textColor = 'text-orange-600';
      }
      
      contentDiv.innerHTML = `
        <div class="text-center mb-6">
          <div class="w-16 h-16 rounded-full ${avatarBg} flex items-center justify-center mx-auto mb-2">
            <span class="text-2xl">${sentimentEmoji}</span>
          </div>
          <h4 class="font-bold text-gray-900 text-lg">${latest.customer_name}</h4>
          <p class="text-sm text-gray-500">${phone}</p>
          <div class="flex items-center justify-center gap-2 mt-2">
            <span class="px-3 py-1 rounded-full text-sm font-medium ${avatarBg} ${textColor}">${sentimentEmoji} ${sentimentText}</span>
            <span class="text-lg font-bold ${textColor}">‚≠ê ${avgRating}</span>
          </div>
        </div>
        <div class="mb-6">
          <h5 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Original Feedback</h5>
          <div class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700">${latest.feedback_text ? `"${latest.feedback_text}"` : 'No feedback text provided'}</div>
        </div>
        <div class="mb-6">
          <h5 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Compose Response</h5>
          <select id="fp-template-select" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-2" onchange="applyFpTemplate()">
            <option value="">Select Template...</option>
            <option value="apologetic">üôè Apologetic</option>
            <option value="friendly">üòä Friendly</option>
            <option value="professional">üíº Professional</option>
          </select>
          <textarea id="fp-response-text" rows="4" placeholder="Type your response message..." class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm resize-none" oninput="updateFpCharCount()"></textarea>
          <div class="flex justify-between items-center mt-1">
            <span class="text-xs text-gray-400"><span id="fp-char-count">0</span>/160</span>
          </div>
        </div>
        <div class="space-y-2">
          <button id="fp-send-btn" class="w-full py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
            <span>üí¨</span> Send SMS Response
          </button>
          <div class="grid grid-cols-2 gap-2">
            <button id="fp-call-btn" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 flex items-center justify-center gap-1">
              <span>üìû</span> Call
            </button>
            <button id="fp-resolve-btn" class="px-3 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700 flex items-center justify-center gap-1">
              <span>‚úì</span> Mark Resolved
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('fp-call-btn').onclick = () => {
        window.location.href = `tel:${phone}`;
        trackFeedbackCall(latest.id);
      };
      
      document.getElementById('fp-send-btn').onclick = async () => {
        const message = document.getElementById('fp-response-text').value.trim();
        if (!message) {
          showNotification('Please enter a message', 'error');
          return;
        }
        try {
          const response = await fetch('/api/send-sms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              customerName: latest.customer_name, 
              customerPhone: phone, 
              message,
              tcpaConsent: true
            })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('SMS sent successfully!', 'success');
            trackFeedbackSms(latest.id);
            closeFeedbackPanel();
            loadFeedback();
          } else {
            showNotification(data.error || 'Failed to send SMS', 'error');
          }
        } catch (e) {
          showNotification('Failed to send SMS', 'error');
        }
      };
      
      document.getElementById('fp-resolve-btn').onclick = () => {
        markFeedbackRead(latest.id);
        closeFeedbackPanel();
      };
      
      // Reset form
      document.getElementById('fp-response-text').value = '';
      document.getElementById('fp-template-select').value = '';
      updateFpCharCount();
      
      // Show panel with slide-in animation
      const overlay = document.getElementById('feedback-panel-overlay');
      if (overlay) overlay.classList.remove('hidden');
      
      // Remove hidden and translate-x-full, add translate-x-0 for slide-in
      panel.classList.remove('hidden', 'translate-x-full');
      panel.classList.add('translate-x-0');
    }
    window.openFeedbackPanel = openFeedbackPanel;
    
    // Event delegation for Respond buttons (more reliable than inline onclick)
    document.addEventListener('click', function(e) {
      const respondBtn = e.target.closest('.respond-btn');
      if (respondBtn) {
        e.stopPropagation();
        const phone = respondBtn.getAttribute('data-phone');
        if (phone) {
          openFeedbackPanel(phone);
        }
      }
      
      // Close button for feedback panel
      const closeBtn = e.target.closest('.close-feedback-panel-btn');
      if (closeBtn) {
        e.stopPropagation();
        closeFeedbackPanel();
      }
    });
    
    function closeFeedbackPanel() {
      const panel = document.getElementById('feedback-panel');
      const overlay = document.getElementById('feedback-panel-overlay');
      
      if (panel) {
        // Slide out animation
        panel.classList.remove('translate-x-0');
        panel.classList.add('translate-x-full');
        
        // Hide after animation completes
        setTimeout(() => {
          panel.classList.add('hidden');
        }, 300);
      }
      
      if (overlay) {
        overlay.classList.add('hidden');
      }
      
      selectedFeedbackCustomer = null;
    }
    window.closeFeedbackPanel = closeFeedbackPanel;
    
    // Template functions for slide-in panel
    const fpTemplates = {
      apologetic: "Hi {name}, we're truly sorry about your recent experience. We take all feedback seriously and would love the chance to make it right. Please call us at your convenience.",
      friendly: "Hi {name}! Thanks so much for your feedback. We really appreciate you taking the time to let us know. Is there anything we can do to help?",
      professional: "Dear {name}, thank you for your feedback. We value your input and are committed to improving our service. Please contact us if you have any further concerns."
    };
    
    function applyFpTemplate() {
      const select = document.getElementById('fp-template-select');
      const textarea = document.getElementById('fp-response-text');
      const template = fpTemplates[select.value];
      if (template && selectedFeedbackCustomer) {
        const name = selectedFeedbackCustomer.feedback[0]?.customer_name || 'there';
        textarea.value = template.replace('{name}', name);
        updateFpCharCount();
      }
    }
    window.applyFpTemplate = applyFpTemplate;
    
    function updateFpCharCount() {
      const textarea = document.getElementById('fp-response-text');
      const countEl = document.getElementById('fp-char-count');
      if (textarea && countEl) {
        countEl.textContent = textarea.value.length;
      }
    }
    window.updateFpCharCount = updateFpCharCount;
    
    function togglePanelHistory() {
      const historyEl = document.getElementById('panel-feedback-history');
      const btn = event.target;
      if (historyEl.classList.contains('hidden')) {
        historyEl.classList.remove('hidden');
        btn.textContent = 'History ‚ñº';
      } else {
        historyEl.classList.add('hidden');
        btn.textContent = 'History ‚ñ∂';
      }
    }
    window.togglePanelHistory = togglePanelHistory;
    
    const panelTemplates = {
      apologetic: "Hi {name}, we're truly sorry about your recent experience. We take all feedback seriously and would love the chance to make it right. Please call us at your convenience.",
      followup: "Hi {name}, thank you for your feedback. We wanted to follow up and see if there's anything we can do to improve your experience with us.",
      resolution: "Hi {name}, we've reviewed your feedback and would like to offer a solution. Please contact us so we can discuss how to resolve this for you."
    };
    
    function applyPanelTemplate() {
      const select = document.getElementById('panel-template-select');
      const textarea = document.getElementById('panel-response-text');
      const template = panelTemplates[select.value];
      if (template && selectedFeedbackCustomer) {
        const name = selectedFeedbackCustomer.feedback[0]?.customer_name || 'there';
        textarea.value = template.replace('{name}', name);
        updatePanelCharCount();
      }
    }
    window.applyPanelTemplate = applyPanelTemplate;
    
    function updatePanelCharCount() {
      const textarea = document.getElementById('panel-response-text');
      const countEl = document.getElementById('panel-char-count');
      countEl.textContent = textarea.value.length;
      countEl.className = textarea.value.length > 160 ? 'text-red-600 font-bold' : '';
    }
    window.updatePanelCharCount = updatePanelCharCount;
    
    const aiSuggestions = {
      apology: "Hi {name}, we're truly sorry about your experience. We take all feedback seriously and would love the opportunity to make things right. Please call us at your convenience.",
      discount: "Hi {name}, we apologize for falling short of your expectations. As a gesture of goodwill, we'd like to offer you 20% off your next service. Please mention this text when you visit.",
      callback: "Hi {name}, we're sorry to hear about your experience. Our manager would like to personally discuss this with you. Would you be available for a brief call today?",
      freeservice: "Hi {name}, we sincerely apologize for your experience. We'd like to offer you a complimentary service to make it right. Please reply to schedule at your convenience."
    };
    
    function applySuggestion(type) {
      const textarea = document.getElementById('panel-response-text');
      const suggestion = aiSuggestions[type];
      if (suggestion && selectedFeedbackCustomer) {
        const name = selectedFeedbackCustomer.feedback[0]?.customer_name || 'there';
        textarea.value = suggestion.replace('{name}', name);
        updatePanelCharCount();
      }
    }
    window.applySuggestion = applySuggestion;
    
    function updateDeliveryStatus(status, timestamp) {
      const iconEl = document.getElementById('delivery-status-icon');
      const textEl = document.getElementById('delivery-status-text');
      const badgeEl = document.getElementById('delivery-status-badge');
      const timestampEl = document.getElementById('delivery-timestamp');
      const timeEl = document.getElementById('delivery-time');
      
      const statusConfig = {
        pending: { icon: 'üì§', text: 'No SMS sent yet', badge: 'Pending', badgeClass: 'bg-gray-100 text-gray-500' },
        sending: { icon: '‚è≥', text: 'Sending...', badge: 'Sending', badgeClass: 'bg-yellow-100 text-yellow-700' },
        sent: { icon: '‚úì', text: 'SMS sent', badge: '‚úì Sent', badgeClass: 'bg-green-100 text-green-700' },
        delivered: { icon: '‚úì', text: 'Message delivered', badge: '‚úì Delivered', badgeClass: 'bg-blue-100 text-blue-700' },
        opened: { icon: 'üëÅ', text: 'Message opened', badge: '‚úì Opened', badgeClass: 'bg-indigo-100 text-indigo-700' },
        failed: { icon: '‚ùå', text: 'Failed to send', badge: 'Failed', badgeClass: 'bg-red-100 text-red-700' }
      };
      
      const config = statusConfig[status] || statusConfig.pending;
      iconEl.textContent = config.icon;
      textEl.textContent = config.text;
      badgeEl.textContent = config.badge;
      badgeEl.className = `px-2 py-0.5 rounded-full text-xs font-medium ${config.badgeClass}`;
      
      if (timestamp) {
        timestampEl.classList.remove('hidden');
        timeEl.textContent = new Date(timestamp).toLocaleString();
      } else {
        timestampEl.classList.add('hidden');
      }
    }
    window.updateDeliveryStatus = updateDeliveryStatus;
    
    async function trackFeedbackCall(id) {
      try {
        await fetch(`/api/feedback/${id}/called`, { method: 'POST' });
      } catch (e) { console.error(e); }
    }
    
    async function trackFeedbackSms(id) {
      try {
        await fetch(`/api/feedback/${id}/sms-sent`, { method: 'POST' });
      } catch (e) { console.error(e); }
    }
    
    function renderFeedbackList() {
      const container = document.getElementById('feedback-list');
      
      let filtered = [...allFeedback];
      if (currentFeedbackFilter === 'unread') {
        filtered = filtered.filter(fb => fb.status === 'unread' || (!fb.is_read && fb.status !== 'read'));
      } else if (currentFeedbackFilter === 'in_progress') {
        filtered = filtered.filter(fb => fb.feedback_status === 'in_progress' || (fb.sms_sent_at || fb.called_at) && !fb.is_read);
      } else if (currentFeedbackFilter === 'resolved') {
        filtered = filtered.filter(fb => fb.feedback_status === 'resolved' || fb.is_read);
      }
      
      if (currentFeedbackSort === 'newest') {
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      } else if (currentFeedbackSort === 'oldest') {
        filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      } else if (currentFeedbackSort === 'rating') {
        filtered.sort((a, b) => a.rating - b.rating);
      }
      
      if (filtered.length > 0) {
        const grouped = groupFeedbackByCustomer(filtered);
        const processedPhones = new Set();
        
        container.innerHTML = filtered.map(fb => {
          const smsSentDate = fb.sms_sent_at ? new Date(fb.sms_sent_at).toLocaleDateString() : null;
          const calledDate = fb.called_at ? new Date(fb.called_at).toLocaleDateString() : null;
          const relativeTime = getRelativeTime(fb.created_at);
          const feedbackDate = new Date(fb.created_at).toLocaleDateString();
          const isUnread = fb.status === 'unread' && !fb.is_read;
          const isUnanswered = !fb.sms_sent_at && !fb.called_at && !fb.is_read;
          const feedbackStatus = fb.feedback_status || 'unread';
          const statusBadge = (feedbackStatus === 'unread' || feedbackStatus === 'new')
            ? '<span class="text-xs px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 font-medium">NEW</span>'
            : feedbackStatus === 'in_progress'
            ? '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 font-medium">üîß In Progress</span>'
            : '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-medium">‚úì Resolved</span>';
          
          const customerMessages = grouped[fb.customer_phone] || [];
          const otherMessages = customerMessages.filter(m => m.id !== fb.id);
          const hasHistory = otherMessages.length > 0;
          const phoneKey = fb.customer_phone.replace(/[^a-zA-Z0-9]/g, '');
          const isFirstForPhone = !processedPhones.has(fb.customer_phone);
          if (isFirstForPhone) processedPhones.add(fb.customer_phone);
          
          const customerAvgRating = customerMessages.length > 1 
            ? (customerMessages.reduce((sum, m) => sum + m.rating, 0) / customerMessages.length).toFixed(1)
            : null;
          
          const historyHtml = hasHistory && isFirstForPhone ? `
            <div class="mt-2 pt-2 border-t border-gray-100">
              <button onclick="toggleCustomerHistory('${fb.customer_phone}')" class="flex items-center gap-2 text-xs text-gray-500 hover:text-gray-700">
                <span>‚è±</span>
                <span>${customerMessages.length} messages from this customer</span>
                <span>‚ñº</span>
              </button>
              <div id="history-${phoneKey}" class="hidden mt-2 pl-4 border-l-2 border-gray-200">
                ${otherMessages.map((h, idx) => {
                  const hDate = new Date(h.created_at).toLocaleDateString();
                  const hUnanswered = !h.sms_sent_at && !h.called_at && !h.is_read;
                  const feedbackPreview = h.feedback_text ? h.feedback_text.substring(0, 30) + (h.feedback_text.length > 30 ? '...' : '') : 'No comment';
                  return `
                    <div class="text-xs text-gray-600 py-1.5 ${idx > 0 ? 'border-t border-gray-100' : ''}">
                      <div class="flex items-center gap-2">
                        <span class="text-gray-400">‚îî‚îÄ</span>
                        <span class="text-gray-700">"${feedbackPreview}"</span>
                        ${hUnanswered ? '<span class="text-orange-500 font-medium">[Unanswered]</span>' : '<span class="text-green-600 font-medium">[Handled]</span>'}
                      </div>
                      <div class="pl-6 text-gray-400 mt-0.5">üîß ${hDate}${h.assigned_to ? ` ¬∑ Tech - ${h.assigned_to}` : ''}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          ` : '';
          
          const borderColor = fb.rating === 1 ? 'border-l-4 border-l-red-500' : (fb.rating <= 3 ? 'border-l-4 border-l-amber-500' : 'border-l-4 border-l-green-500');
          
          return `
          <div class="p-3 rounded-lg border ${borderColor} ${isUnread ? 'bg-amber-50' : 'bg-white hover:bg-gray-50'} mb-2 cursor-pointer" id="feedback-item-${fb.id}" onclick="openFeedbackPanel('${fb.customer_phone}')">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="${isUnread ? 'font-bold' : 'font-semibold'} text-gray-900">${fb.customer_name}</span>
                  <span class="text-sm ${fb.rating <= 2 ? 'text-red-600' : 'text-gray-600'}">‚≠ê ${customerAvgRating || fb.rating}</span>
                  <span class="text-xs text-gray-400">${relativeTime}</span>
                  ${statusBadge}
                  ${isUnanswered && feedbackStatus !== 'resolved' ? '<span class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-700">Unanswered</span>' : ''}
                </div>
                ${fb.feedback_text ? `<div class="text-sm text-gray-700 mt-1">"${fb.feedback_text}"</div>` : ''}
                <div class="flex items-center gap-2 mt-2 text-xs text-gray-500 flex-wrap">
                  <span class="${fb.rating <= 2 ? 'text-red-500' : 'text-yellow-500'}">‚óè</span>
                  <span>${fb.rating <= 2 ? 'Needs attention' : 'Moderate'}</span>
                  <span class="text-gray-300">¬∑</span>
                  <span>üîß ${feedbackDate}</span>
                  ${fb.assigned_to ? `<span class="text-gray-300">¬∑</span><span>Tech - ${fb.assigned_to}</span>` : ''}
                  ${calledDate ? `<span class="text-green-600">üìû ${calledDate}</span>` : ''}
                  ${smsSentDate ? `<span class="text-blue-600">üí¨ ${smsSentDate}</span>` : ''}
                </div>
                <div class="text-xs text-gray-400 mt-1">${fb.customer_phone}</div>
                ${historyHtml}
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <button class="respond-btn px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors" data-phone="${fb.customer_phone}">
                  Respond
                </button>
                <div class="relative">
                  <button onclick="toggleFeedbackMenu(${fb.id}, event)" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors" title="Actions">
                    <span class="text-lg font-bold">‚ãÆ</span>
                  </button>
                  <div id="feedback-menu-${fb.id}" class="hidden absolute right-0 top-full mt-1 w-40 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                    <a href="tel:${fb.customer_phone}" data-action="callCustomer" data-id="${fb.id}" data-phone="${fb.customer_phone}" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                      <span>üìû</span> Call
                    </a>
                    <button data-action="smsApology" data-id="${fb.id}" data-name="${fb.customer_name.replace(/"/g, '&quot;')}" data-phone="${fb.customer_phone}" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left">
                      <span>üí¨</span> Send SMS
                    </button>
                    <button data-action="blockFeedback" data-id="${fb.id}" class="flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 w-full text-left">
                      <span>üö´</span> Block
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `}).join('');
      } else {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-12">No feedback received yet</p>';
      }
    }
    
    document.querySelectorAll('.feedback-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.feedback-tab').forEach(t => {
          t.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
          t.classList.add('text-gray-500', 'border-transparent');
        });
        tab.classList.add('border-blue-500', 'text-blue-600', 'font-medium');
        tab.classList.remove('text-gray-500', 'border-transparent');
        currentFeedbackFilter = tab.dataset.filter;
        renderFeedbackList();
      });
    });
    
    document.getElementById('feedback-sort')?.addEventListener('change', (e) => {
      currentFeedbackSort = e.target.value;
      renderFeedbackList();
    });

    window.markFeedbackRead = async function markFeedbackRead(feedbackId) {
      try {
        const response = await fetch('/api/feedback/mark-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ feedbackId })
        });
        const data = await response.json();
        if (data.success) {
          loadFeedback();
          showNotification('Feedback marked as read', 'success');
        }
      } catch (error) {
        console.error('Error marking feedback as read:', error);
      }
    }

    let adminAuthEnabled = false;
    
    function toggleAdminAuth() {
      adminAuthEnabled = !adminAuthEnabled;
      updateAdminAuthToggleUI();
    }
    
    function updateAdminAuthToggleUI() {
      const toggle = document.getElementById('admin-auth-toggle');
      const dot = document.getElementById('admin-auth-toggle-dot');
      if (adminAuthEnabled) {
        toggle.classList.remove('bg-gray-300');
        toggle.classList.add('bg-accent');
        toggle.setAttribute('aria-checked', 'true');
        dot.classList.remove('translate-x-0');
        dot.classList.add('translate-x-5');
      } else {
        toggle.classList.remove('bg-accent');
        toggle.classList.add('bg-gray-300');
        toggle.setAttribute('aria-checked', 'false');
        dot.classList.remove('translate-x-5');
        dot.classList.add('translate-x-0');
      }
    }

    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        const data = await response.json();
        
        if (data.success && data.settings) {
          document.getElementById('settings-business-name').value = data.settings.business_name || '';
          document.getElementById('settings-sms-template').value = data.settings.sms_template || 'Hi {name}, thanks for visiting {business}! Please review us here: {link}';
          document.getElementById('settings-review-link').value = data.settings.google_review_link || '';
          adminAuthEnabled = data.settings.admin_auth_enabled === true;
          updateAdminAuthToggleUI();
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    async function saveSettings() {
      try {
        const businessNameVal = document.getElementById('settings-business-name').value;
        const smsTemplate = document.getElementById('settings-sms-template').value;
        const reviewLink = document.getElementById('settings-review-link').value;

        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            business_name: businessNameVal,
            sms_template: smsTemplate,
            google_review_link: reviewLink,
            admin_auth_enabled: adminAuthEnabled
          })
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Settings saved!', 'success');
          businessName = businessNameVal || 'Our Store';
          
          const sidebarBrand = document.getElementById('sidebar-brand');
          const headerBranding = document.getElementById('header-branding');
          
          if (sidebarBrand) sidebarBrand.textContent = businessNameVal || 'ReviewGuard';
          if (headerBranding) headerBranding.textContent = businessNameVal ? `${businessNameVal} SMS Manager` : 'SMS Manager';
          
          updatePreview();
        } else {
          showNotification(data.error || 'Failed to save settings', 'error');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('Failed to save settings', 'error');
      }
    }

    async function loadTelegramConfig() {
      try {
        const response = await fetch('/api/settings/telegram');
        const data = await response.json();
        
        const statusBadge = document.getElementById('telegram-status-badge');
        const testBtn = document.getElementById('test-telegram-btn');
        const disconnectBtn = document.getElementById('disconnect-telegram-btn');
        const chatIdInput = document.getElementById('telegram-chat-id');
        const tokenInput = document.getElementById('telegram-bot-token');
        
        if (data.success && data.configured) {
          statusBadge.textContent = 'Connected';
          statusBadge.className = 'px-2 py-1 rounded-full text-[10px] font-medium bg-green-100 text-green-700';
          testBtn.disabled = false;
          disconnectBtn.classList.remove('hidden');
          chatIdInput.value = data.config.chatId || '';
          tokenInput.placeholder = 'Bot token configured (hidden)';
        } else {
          statusBadge.textContent = 'Not Configured';
          statusBadge.className = 'px-2 py-1 rounded-full text-[10px] font-medium bg-gray-100 text-gray-600';
          testBtn.disabled = true;
          disconnectBtn.classList.add('hidden');
          chatIdInput.value = '';
          tokenInput.placeholder = 'Enter your Telegram Bot Token from @BotFather';
        }
      } catch (error) {
        console.error('Error loading Telegram config:', error);
      }
    }

    async function saveTelegramConfig() {
      const botToken = document.getElementById('telegram-bot-token').value.trim();
      const chatId = document.getElementById('telegram-chat-id').value.trim();
      
      if (!botToken || !chatId) {
        showNotification('Please enter both Bot Token and Chat ID', 'error');
        return;
      }
      
      const saveBtn = document.getElementById('save-telegram-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        const response = await fetch('/api/settings/telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ botToken, chatId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Telegram connected successfully!', 'success');
          document.getElementById('telegram-bot-token').value = '';
          loadTelegramConfig();
        } else {
          showNotification(data.error || 'Failed to save Telegram settings', 'error');
        }
      } catch (error) {
        console.error('Error saving Telegram config:', error);
        showNotification('Failed to save Telegram settings', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Telegram Settings';
      }
    }

    async function testTelegramConnection() {
      const testBtn = document.getElementById('test-telegram-btn');
      testBtn.disabled = true;
      testBtn.textContent = 'Testing...';
      
      try {
        const response = await fetch('/api/settings/telegram/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Test message sent! Check your Telegram.', 'success');
        } else {
          showNotification(data.error || 'Failed to send test message', 'error');
        }
      } catch (error) {
        console.error('Error testing Telegram:', error);
        showNotification('Failed to send test message', 'error');
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'Test';
      }
    }

    async function disconnectTelegram() {
      if (!confirm('Are you sure you want to disconnect your Telegram bot?')) return;
      
      try {
        const response = await fetch('/api/settings/telegram', { method: 'DELETE' });
        const data = await response.json();
        
        if (data.success) {
          showNotification('Telegram bot disconnected', 'success');
          loadTelegramConfig();
        } else {
          showNotification(data.error || 'Failed to disconnect Telegram', 'error');
        }
      } catch (error) {
        console.error('Error disconnecting Telegram:', error);
        showNotification('Failed to disconnect Telegram', 'error');
      }
    }

    window.sendReminder = async function sendReminder(messageId, customerName, customerPhone, reviewLink) {
      if (!confirm(`Send reminder to ${customerName}?`)) return;
      
      try {
        const response = await fetch('/api/send-reminder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messageId, customerName, customerPhone, reviewLink })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification(`Reminder sent to ${customerName}!`, 'success');
          loadHistory();
        } else {
          showNotification(data.error || 'Failed to send reminder', 'error');
        }
      } catch (error) {
        console.error('Error sending reminder:', error);
        showNotification('Failed to send reminder', 'error');
      }
    }

    function clearAIReviewForm() {
      document.getElementById('ai-customer-name').value = '';
      document.getElementById('ai-star-rating').value = '';
      document.getElementById('ai-review-text').value = '';
      document.getElementById('ai-reply-container').classList.add('hidden');
    }

    function showAIReplyPanel(customerName, starRating, reviewText) {
      const panel = document.getElementById('ai-reply-assistant-panel');
      document.getElementById('ai-customer-name').value = customerName || '';
      document.getElementById('ai-star-rating').value = starRating || '';
      document.getElementById('ai-review-text').value = reviewText || '';
      document.getElementById('ai-reply-container').classList.add('hidden');
      panel.classList.remove('hidden');
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function hideAIReplyPanel() {
      document.getElementById('ai-reply-assistant-panel').classList.add('hidden');
      clearAIReviewForm();
    }

    async function generateAIReply() {
      const customerName = document.getElementById('ai-customer-name').value.trim();
      const starRating = document.getElementById('ai-star-rating').value;
      const reviewText = document.getElementById('ai-review-text').value.trim();
      const generateBtn = document.getElementById('generate-reply-btn');

      if (!customerName || !starRating || !reviewText) {
        showNotification('Please fill in all fields', 'error');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';

      try {
        const response = await fetch('/api/generate-reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ customerName, starRating: parseInt(starRating), reviewText })
        });

        const data = await response.json();

        if (data.success && data.reply) {
          document.getElementById('ai-reply-text').textContent = data.reply;
          document.getElementById('ai-reply-container').classList.remove('hidden');
          showNotification('AI reply generated!', 'success');
        } else {
          showNotification(data.error || 'Failed to generate reply', 'error');
        }
      } catch (error) {
        console.error('Error generating AI reply:', error);
        showNotification('Failed to generate reply', 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Generate AI Reply';
      }
    }

    function copyReplyToClipboard() {
      const replyText = document.getElementById('ai-reply-text').textContent;
      navigator.clipboard.writeText(replyText).then(() => {
        showNotification('Copied to clipboard!', 'success');
      }).catch(() => {
        showNotification('Failed to copy', 'error');
      });
    }

    const messageTypeSelect = document.getElementById('message-type');
    const customerNameInput = document.getElementById('customer-name');
    const deviceInput = document.getElementById('device');
    const repairInput = document.getElementById('repair');
    const customMessageInput = document.getElementById('custom-message');
    const customMessageContainer = document.getElementById('custom-message-container');
    const messagePreview = document.getElementById('message-preview');
    const charCount = document.getElementById('char-count');

    messageTypeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customMessageContainer.classList.remove('hidden');
      } else {
        customMessageContainer.classList.add('hidden');
      }
      updatePreview();
    });

    function updatePreview() {
      const type = messageTypeSelect.value;
      const name = customerNameInput.value || 'Customer';
      const device = deviceInput.value || 'device';
      const repair = repairInput.value || 'repair';
      const custom = customMessageInput.value;

      let message = '';

      if (type === 'review') {
        const serviceDesc = device && repair ? `${device} ${repair}` : device || repair || 'service';
        message = `Hi ${name}! Thank you for choosing ${businessName} for your ${serviceDesc}. How was your experience? Please rate us: [Feedback Link]`;
      } else if (type === 'ready') {
        message = repair 
          ? `Hi ${name}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours. See you soon!`
          : `Hi ${name}! Great news - your ${device} is ready for pickup! Stop by anytime during business hours. See you soon!`;
      } else if (type === 'follow_up') {
        message = device 
          ? (repair 
            ? `Hi ${name}! Just checking in on your ${device}. Is everything working well after the ${repair}? Let us know if you need anything!`
            : `Hi ${name}! Just checking in on your ${device}. Is everything working well? Let us know if you need anything!`)
          : `Hi ${name}! Just checking in. Is everything working well? Let us know if you need anything!`;
      } else {
        message = custom || '';
      }

      if (custom && type !== 'custom') {
        message += '\n\n' + custom;
      }

      messagePreview.textContent = message || 'Your message will appear here...';
      charCount.textContent = message.length;
    }

    customerNameInput.addEventListener('input', updatePreview);
    deviceInput.addEventListener('input', updatePreview);
    repairInput.addEventListener('input', updatePreview);
    customMessageInput.addEventListener('input', updatePreview);

    const smsConsentCheckbox = document.getElementById('sms-consent-checkbox');
    const sendSmsBtn = document.getElementById('send-sms-btn');

    smsConsentCheckbox.addEventListener('change', function() {
      sendSmsBtn.disabled = !this.checked;
    });

    sendSmsBtn.addEventListener('click', async () => {
      if (!smsConsentCheckbox.checked) {
        showNotification('Please confirm SMS consent before sending', 'error');
        return;
      }
      window.openSmsConfirmationModal();
    });

    async function sendSMS() {
      const customerName = customerNameInput.value;
      const customerPhone = document.getElementById('customer-phone').value;
      const messageType = messageTypeSelect.value;
      const device = deviceInput.value;
      const repair = repairInput.value;
      const customMessage = customMessageInput.value;

      if (!customerName || !customerPhone) {
        showNotification('Please enter customer name and phone number', 'error');
        return;
      }

      let additionalInfo = '';
      if (messageType === 'review') {
        const serviceDesc = device && repair ? `${device} ${repair}` : device || repair || 'service';
        additionalInfo = `Hi ${customerName}! Thank you for choosing ${businessName} for your ${serviceDesc}. How was your experience? Please rate us:`;
      } else if (messageType === 'ready') {
        additionalInfo = repair 
          ? `Hi ${customerName}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours. See you soon!`
          : `Hi ${customerName}! Great news - your ${device} is ready for pickup! Stop by anytime during business hours. See you soon!`;
      } else if (messageType === 'follow_up') {
        additionalInfo = device 
          ? (repair 
            ? `Hi ${customerName}! Just checking in on your ${device}. Is everything working well after the ${repair}? Let us know if you need anything!`
            : `Hi ${customerName}! Just checking in on your ${device}. Is everything working well? Let us know if you need anything!`)
          : `Hi ${customerName}! Just checking in. Is everything working well? Let us know if you need anything!`;
      } else if (messageType === 'custom') {
        additionalInfo = customMessage;
      }

      if (customMessage && messageType !== 'custom') {
        additionalInfo += '\n\n' + customMessage;
      }

      sendSmsBtn.disabled = true;
      sendSmsBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...';

      try {
        const formData = new FormData();
        formData.append('customerName', customerName);
        formData.append('customerPhone', customerPhone);
        formData.append('device', device || '');
        formData.append('messageType', messageType);
        formData.append('additionalInfo', additionalInfo);
        formData.append('smsConsentConfirmed', 'true');

        const response = await fetch('/api/send-review-request', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          if (messageType === 'review') {
            showNotification('Feedback request sent! Customer will receive a link to rate their experience.', 'success');
          } else {
            showNotification('SMS sent successfully!', 'success');
          }
          
          customerNameInput.value = '';
          document.getElementById('customer-phone').value = '';
          deviceInput.value = '';
          repairInput.value = '';
          customMessageInput.value = '';
          smsConsentCheckbox.checked = false;
          sendSmsBtn.disabled = true;
          updatePreview();
        } else {
          showNotification('Error: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Error sending SMS:', error);
        showNotification('Failed to send SMS. Please try again.', 'error');
      } finally {
        sendSmsBtn.disabled = !smsConsentCheckbox.checked;
        sendSmsBtn.innerHTML = 'üì§ Send Welcome SMS';
      }
    }

    window.openSmsConfirmationModal = function() {
      const customerName = customerNameInput.value;
      const customerPhone = document.getElementById('customer-phone').value;
      const messageType = messageTypeSelect.value;
      const device = deviceInput.value;
      const repair = repairInput.value;
      const customMessage = customMessageInput.value;

      if (!customerName || !customerPhone) {
        showNotification('Please enter customer name and phone number', 'error');
        return;
      }

      let msgPreview = '';
      if (messageType === 'review') {
        const serviceDesc = device && repair ? `${device} ${repair}` : device || repair || 'service';
        msgPreview = `Hi ${customerName}! Thank you for choosing ${businessName} for your ${serviceDesc}. How was your experience? Please rate us:`;
      } else if (messageType === 'ready') {
        msgPreview = repair 
          ? `Hi ${customerName}! Great news - your ${device} is ready for pickup! We've completed the ${repair}. Stop by anytime during business hours.`
          : `Hi ${customerName}! Great news - your ${device} is ready for pickup! Stop by anytime during business hours.`;
      } else if (messageType === 'follow_up') {
        msgPreview = device 
          ? (repair 
            ? `Hi ${customerName}! Just checking in on your ${device}. Is everything working well after the ${repair}?`
            : `Hi ${customerName}! Just checking in on your ${device}. Is everything working well?`)
          : `Hi ${customerName}! Just checking in. Is everything working well?`;
      } else if (messageType === 'custom') {
        msgPreview = customMessage;
      }

      if (customMessage && messageType !== 'custom') {
        msgPreview += '\n\n' + customMessage;
      }

      document.getElementById('modal-customer-name').textContent = customerName;
      document.getElementById('modal-customer-phone').textContent = customerPhone;
      document.getElementById('modal-message-preview').textContent = msgPreview;

      document.getElementById('sms-confirmation-modal').classList.remove('hidden');
    };

    window.closeSmsConfirmationModal = function() {
      document.getElementById('sms-confirmation-modal').classList.add('hidden');
    };

    window.confirmAndSendSMS = async function() {
      window.closeSmsConfirmationModal();
      await sendSMS();
    };

    document.getElementById('modal-cancel-btn').addEventListener('click', window.closeSmsConfirmationModal);
    document.getElementById('modal-confirm-btn').addEventListener('click', window.confirmAndSendSMS);
    document.getElementById('modal-backdrop').addEventListener('click', window.closeSmsConfirmationModal);

    // SMS Apology Modal Functions
    let apologyCustomerPhone = '';
    
    let apologyFeedbackId = null;
    
    window.openApologyModal = function(name, phone, feedbackId) {
      apologyCustomerPhone = phone;
      apologyFeedbackId = feedbackId || null;
      document.getElementById('apology-customer-info').textContent = `${name} (${phone})`;
      document.getElementById('apology-message').value = `Hi ${name}, this is Shuki the owner. I saw your feedback about the repair. I am so sorry. I want to make it right. Can we chat?`;
      document.getElementById('sms-apology-modal').classList.remove('hidden');
    };
    
    window.closeApologyModal = function() {
      document.getElementById('sms-apology-modal').classList.add('hidden');
      apologyCustomerPhone = '';
      apologyFeedbackId = null;
    };
    
    window.sendApologySMS = async function() {
      const message = document.getElementById('apology-message').value.trim();
      if (!message) {
        showErrorModal('Please enter a message before sending.');
        return;
      }
      
      const sendBtn = document.getElementById('send-apology-btn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      try {
        const response = await fetch('/api/send-review-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customerPhone: apologyCustomerPhone,
            customerName: document.getElementById('apology-customer-info').textContent.split(' (')[0] || 'Customer',
            messageType: 'apology',
            additionalInfo: message,
            smsConsentConfirmed: true
          })
        });
        
        if (!response.ok) {
          window.closeApologyModal();
          showErrorModal('SMS failed to send. Please check your connection and try again.');
          return;
        }
        
        const data = await response.json();
        if (data.success) {
          if (apologyFeedbackId) {
            try {
              await fetch(`/api/feedback/${apologyFeedbackId}/sms-sent`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
            } catch (e) {
              console.error('Error tracking SMS sent:', e);
            }
          }
          window.closeApologyModal();
          loadFeedback();
          showNotification('Apology SMS sent successfully!', 'success');
        } else {
          window.closeApologyModal();
          showErrorModal(data.error || 'SMS failed to send. Please try again.');
        }
      } catch (error) {
        console.error('Error sending apology SMS:', error);
        window.closeApologyModal();
        showErrorModal('SMS failed to send. Network error - please check your connection.');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Apology';
      }
    };
    
    document.getElementById('close-apology-btn').addEventListener('click', window.closeApologyModal);
    document.getElementById('cancel-apology-btn').addEventListener('click', window.closeApologyModal);
    document.getElementById('send-apology-btn').addEventListener('click', window.sendApologySMS);
    document.getElementById('sms-apology-backdrop').addEventListener('click', window.closeApologyModal);

    const ocrUploadInput = document.getElementById('ocr-upload');
    const dropZone = document.getElementById('drop-zone');
    const browseFilesBtn = document.getElementById('browse-files-btn');
    const ocrNameDisplay = document.getElementById('ocr-name');
    const ocrPhoneDisplay = document.getElementById('ocr-phone');
    const ocrDeviceDisplay = document.getElementById('ocr-device');
    const ocrRepairDisplay = document.getElementById('ocr-repair');

    browseFilesBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      ocrUploadInput.click();
    });

    dropZone.addEventListener('click', () => ocrUploadInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        processOCRFile(files[0]);
      }
    });

    ocrUploadInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) processOCRFile(file);
    });

    async function processOCRFile(file) {
      ocrNameDisplay.textContent = 'Processing...';
      ocrPhoneDisplay.textContent = 'Processing...';
      ocrDeviceDisplay.textContent = 'Processing...';
      ocrRepairDisplay.textContent = 'Processing...';

      try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/ocr/process', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success && data.data) {
          ocrNameDisplay.textContent = data.data.customerName || '-';
          ocrPhoneDisplay.textContent = data.data.customerPhone || '-';
          ocrDeviceDisplay.textContent = data.data.device || '-';
          ocrRepairDisplay.textContent = data.data.repair || '-';

          if (data.data.customerName) customerNameInput.value = data.data.customerName;
          if (data.data.customerPhone) document.getElementById('customer-phone').value = data.data.customerPhone;
          if (data.data.device) deviceInput.value = data.data.device;
          if (data.data.repair) repairInput.value = data.data.repair;

          updatePreview();
          showNotification('Information extracted successfully!', 'success');
        } else {
          ocrNameDisplay.textContent = '-';
          ocrPhoneDisplay.textContent = '-';
          ocrDeviceDisplay.textContent = '-';
          ocrRepairDisplay.textContent = '-';
          showNotification('Error: ' + (data.error || 'Failed to process image'), 'error');
          ocrUploadInput.value = '';
        }
      } catch (error) {
        console.error('OCR upload error:', error);
        ocrNameDisplay.textContent = '-';
        ocrPhoneDisplay.textContent = '-';
        ocrDeviceDisplay.textContent = '-';
        ocrRepairDisplay.textContent = '-';
        showNotification('Failed to process image', 'error');
        ocrUploadInput.value = '';
      }
    }

    const cameraBtn = document.getElementById('camera-btn');
    const cameraModal = document.getElementById('camera-modal');
    const cameraVideo = document.getElementById('camera-video');
    const cameraCanvas = document.getElementById('camera-canvas');
    const capturePhotoBtn = document.getElementById('capture-photo-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');
    const cameraError = document.getElementById('camera-error');
    let cameraStream = null;

    cameraBtn.addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showNotification('Camera is not supported on this device', 'error');
          return;
        }

        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });

        cameraVideo.srcObject = cameraStream;
        cameraModal.classList.remove('hidden');
        cameraError.classList.add('hidden');
      } catch (error) {
        console.error('Camera access error:', error);
        showNotification('Failed to access camera. Please use the Upload button instead.', 'error');
      }
    });

    closeCameraBtn.addEventListener('click', () => {
      stopCamera();
      cameraModal.classList.add('hidden');
    });

    capturePhotoBtn.addEventListener('click', async () => {
      try {
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;

        const context = cameraCanvas.getContext('2d');
        context.drawImage(cameraVideo, 0, 0);

        cameraCanvas.toBlob(async (blob) => {
          if (!blob) {
            showNotification('Failed to capture photo', 'error');
            stopCamera();
            cameraModal.classList.add('hidden');
            return;
          }

          stopCamera();
          cameraModal.classList.add('hidden');
          
          const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
          processOCRFile(file);
        }, 'image/jpeg', 0.95);
      } catch (error) {
        console.error('Photo capture error:', error);
        showNotification('Failed to capture photo', 'error');
      }
    });

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        cameraVideo.srcObject = null;
      }
    }

    const repairDeskBtn = document.getElementById('repairdesk-import-btn');
    const repairDeskModal = document.getElementById('repairdesk-modal');
    const repairDeskBackdrop = document.getElementById('repairdesk-modal-backdrop');
    const closeRepairDeskBtn = document.getElementById('close-repairdesk-btn');
    const repairDeskLoading = document.getElementById('repairdesk-loading');
    const repairDeskError = document.getElementById('repairdesk-error');
    const repairDeskErrorMsg = document.getElementById('repairdesk-error-msg');
    const repairDeskTickets = document.getElementById('repairdesk-tickets');
    const repairDeskEmpty = document.getElementById('repairdesk-empty');

    function closeRepairDeskModal() {
      repairDeskModal.classList.add('hidden');
    }

    repairDeskBtn.addEventListener('click', async () => {
      repairDeskModal.classList.remove('hidden');
      repairDeskLoading.classList.remove('hidden');
      repairDeskError.classList.add('hidden');
      repairDeskTickets.classList.add('hidden');
      repairDeskEmpty.classList.add('hidden');

      try {
        const response = await fetch('/api/repairdesk/tickets');
        const data = await response.json();

        repairDeskLoading.classList.add('hidden');

        if (!data.success) {
          repairDeskError.classList.remove('hidden');
          repairDeskErrorMsg.textContent = data.error || 'Unknown error';
          return;
        }

        if (data.tickets.length === 0) {
          repairDeskEmpty.classList.remove('hidden');
          return;
        }

        repairDeskTickets.innerHTML = data.tickets.map(ticket => {
          let statusClass = 'bg-amber-100 text-amber-700';
          if (ticket.status === 'Collected' || ticket.status === 'Repaired & Collected') {
            statusClass = 'bg-green-100 text-green-700';
          } else if (ticket.status === 'In Progress') {
            statusClass = 'bg-blue-100 text-blue-700';
          }
          return `
          <div class="ticket-row p-3 border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 cursor-pointer transition-colors" 
               data-name="${ticket.customer_name}" 
               data-phone="${ticket.customer_phone}" 
               data-device="${ticket.device_name}">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-mono text-gray-500">#${ticket.id}</span>
                  <span class="text-xs px-2 py-0.5 rounded-full ${statusClass}">${ticket.status}</span>
                </div>
                <div class="font-medium text-gray-900">${ticket.customer_name}</div>
                <div class="text-sm text-gray-500">${ticket.device_name}</div>
              </div>
              <div class="text-right text-sm text-gray-500">
                ${ticket.customer_phone}
              </div>
            </div>
          </div>
        `}).join('');

        repairDeskTickets.classList.remove('hidden');

        document.querySelectorAll('.ticket-row').forEach(row => {
          row.addEventListener('click', () => {
            const name = row.dataset.name;
            const phone = row.dataset.phone;
            const device = row.dataset.device;

            document.getElementById('customer-name').value = name || '';
            document.getElementById('customer-phone').value = phone || '';
            document.getElementById('device').value = device || '';

            document.getElementById('ocr-name').textContent = name || '-';
            document.getElementById('ocr-phone').textContent = phone || '-';
            document.getElementById('ocr-device').textContent = device || '-';

            updatePreview();
            closeRepairDeskModal();
            showNotification(`Imported: ${name}`, 'success');
          });
        });

      } catch (error) {
        console.error('RepairDesk fetch error:', error);
        repairDeskLoading.classList.add('hidden');
        repairDeskError.classList.remove('hidden');
        repairDeskErrorMsg.textContent = error.message || 'Network error';
      }
    });

    closeRepairDeskBtn.addEventListener('click', closeRepairDeskModal);
    repairDeskBackdrop.addEventListener('click', closeRepairDeskModal);

    async function createCheckout(planId, button, originalText) {
      try {
        button.disabled = true;
        button.textContent = 'Creating checkout...';

        const authResponse = await fetch('/api/auth/session');
        if (!authResponse.ok) {
          showNotification('Please log in to subscribe', 'error');
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        
        const authData = await authResponse.json();
        if (!authData.user?.email) {
          showNotification('Please log in to subscribe', 'error');
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: authData.user.email, planId: planId })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error(data.error || 'Failed to create checkout session');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        showNotification('Failed to start checkout', 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function updateSubscriptionDisplay() {
      try {
        const authResponse = await fetch('/api/auth/session');
        if (!authResponse.ok) return;
        
        const authData = await authResponse.json();
        if (!authData.user?.email) return;

        const response = await fetch(`/api/subscription-status?email=${encodeURIComponent(authData.user.email)}`);
        if (!response.ok) return;

        const data = await response.json();
        
        const starterCard = document.getElementById('starter-plan-card');
        const proCard = document.getElementById('pro-plan-card');
        const starterBtn = document.getElementById('subscribe-starter-btn');
        const proBtn = document.getElementById('subscribe-pro-btn');

        starterCard.classList.remove('border-green-500', 'border-2');
        proCard.classList.remove('border-green-500', 'border-2');
        starterCard.classList.add('border-gray-100');
        proCard.classList.add('border-accent');

        if (data.subscription_status === 'active') {
          const planId = data.plan;
          
          if (planId === 'starter') {
            starterCard.classList.remove('border-gray-100');
            starterCard.classList.add('border-green-500', 'border-2');
            starterBtn.textContent = '‚úì Active Plan';
            starterBtn.disabled = true;
          } else if (planId === 'pro') {
            proCard.classList.remove('border-accent');
            proCard.classList.add('border-green-500', 'border-2');
            proBtn.textContent = '‚úì Active Plan';
            proBtn.disabled = true;
          }
        }
      } catch (error) {
        console.error('Failed to fetch subscription status:', error);
      }
    }

    const subscribeStarterBtn = document.getElementById('subscribe-starter-btn');
    if (subscribeStarterBtn) {
      subscribeStarterBtn.addEventListener('click', function() {
        createCheckout('starter', this, 'Subscribe to Starter');
      });
    }

    const subscribeProBtn = document.getElementById('subscribe-pro-btn');
    if (subscribeProBtn) {
      subscribeProBtn.addEventListener('click', function() {
        createCheckout('pro', this, 'Subscribe to Pro');
      });
    }

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const data = await response.json();
          
          if (data.success) {
            showLoginModal();
          } else {
            showNotification('Logout failed', 'error');
          }
        } catch (error) {
          console.error('Logout error:', error);
          showNotification('Logout failed', 'error');
        }
      });
    }

    const saveSettingsBtn = document.getElementById('save-settings-btn');
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', async function() {
        await saveSettings();
        loadUserOnPageLoad();
      });
    }

    const saveTelegramBtn = document.getElementById('save-telegram-btn');
    if (saveTelegramBtn) saveTelegramBtn.addEventListener('click', saveTelegramConfig);

    const testTelegramBtn = document.getElementById('test-telegram-btn');
    if (testTelegramBtn) testTelegramBtn.addEventListener('click', testTelegramConnection);

    const disconnectTelegramBtn = document.getElementById('disconnect-telegram-btn');
    if (disconnectTelegramBtn) disconnectTelegramBtn.addEventListener('click', disconnectTelegram);

    const copyReplyBtn = document.getElementById('copy-reply-btn');
    if (copyReplyBtn) copyReplyBtn.addEventListener('click', copyReplyToClipboard);

    // Generate AI Reply button
    const generateReplyBtn = document.getElementById('generate-reply-btn');
    if (generateReplyBtn) {
      generateReplyBtn.addEventListener('click', generateAIReply);
    }

    // Manual AI Reply Generator button
    const manualAiReplyBtn = document.getElementById('manual-ai-reply-btn');
    if (manualAiReplyBtn) {
      manualAiReplyBtn.addEventListener('click', () => {
        clearAIReviewForm();
        document.getElementById('ai-reply-container').classList.add('hidden');
        document.getElementById('ai-reply-assistant-panel').classList.remove('hidden');
        document.getElementById('ai-reply-assistant-panel').scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }

    // Bulk Review Sender
    let bulkTicketsData = [];
    let activeQuickFilter = null;
    let bulkSelectedTickets = new Set();
    let followupCustomersData = [];
    let followupSelectedCustomers = new Set();

    async function loadFollowupCustomers() {
      const loading = document.getElementById('followup-loading');
      const empty = document.getElementById('followup-empty');
      const list = document.getElementById('followup-list');
      const selectionBar = document.getElementById('followup-selection-bar');
      const badge = document.getElementById('followup-count-badge');

      loading.classList.remove('hidden');
      empty.classList.add('hidden');
      list.classList.add('hidden');
      selectionBar.classList.add('hidden');

      try {
        const response = await fetch('/api/customers/needs-followup');
        const data = await response.json();

        loading.classList.add('hidden');

        if (!data.success) {
          empty.classList.remove('hidden');
          return;
        }

        followupCustomersData = data.customers || [];
        followupSelectedCustomers.clear();

        if (followupCustomersData.length > 0) {
          badge.textContent = followupCustomersData.length;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }

        renderFollowupCustomers();

      } catch (err) {
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
      }
    }

    function renderFollowupCustomers() {
      const list = document.getElementById('followup-list');
      const empty = document.getElementById('followup-empty');

      if (followupCustomersData.length === 0) {
        empty.classList.remove('hidden');
        list.classList.add('hidden');
        return;
      }

      list.innerHTML = followupCustomersData.map(customer => {
        const isSelected = followupSelectedCustomers.has(customer.id);
        const selectedClass = isSelected ? 'bg-amber-50 border-amber-300' : 'border-gray-200';
        const sentDate = new Date(customer.last_sms_sent_at);
        const daysAgo = Math.floor((Date.now() - sentDate) / (1000 * 60 * 60 * 24));

        return `
          <div class="followup-row p-3 border ${selectedClass} rounded-lg hover:bg-amber-50 cursor-pointer transition-colors flex items-center gap-3" 
               data-id="${customer.id}"
               data-name="${customer.name}"
               data-phone="${customer.phone}">
            <input type="checkbox" class="followup-checkbox w-5 h-5 text-amber-600 rounded border-gray-300 focus:ring-amber-500" ${isSelected ? 'checked' : ''}>
            <div class="flex-1">
              <div class="font-medium text-gray-900">${customer.name}</div>
              <div class="text-sm text-gray-500">${customer.phone}</div>
            </div>
            <div class="text-right">
              <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">${daysAgo}d ago</span>
            </div>
          </div>
        `;
      }).join('');

      list.classList.remove('hidden');

      document.querySelectorAll('.followup-row').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return;
          const checkbox = row.querySelector('.followup-checkbox');
          checkbox.checked = !checkbox.checked;
          handleFollowupSelection(row, checkbox.checked);
        });

        row.querySelector('.followup-checkbox').addEventListener('change', (e) => {
          handleFollowupSelection(row, e.target.checked);
        });
      });
    }

    function handleFollowupSelection(row, isChecked) {
      const customerId = parseInt(row.dataset.id);
      const selectionBar = document.getElementById('followup-selection-bar');
      const countEl = document.getElementById('followup-selected-count');

      if (isChecked && followupSelectedCustomers.size < 5) {
        followupSelectedCustomers.add(customerId);
        row.classList.add('bg-amber-50', 'border-amber-300');
        row.classList.remove('border-gray-200');
      } else if (!isChecked) {
        followupSelectedCustomers.delete(customerId);
        row.classList.remove('bg-amber-50', 'border-amber-300');
        row.classList.add('border-gray-200');
      } else {
        row.querySelector('.followup-checkbox').checked = false;
        showNotification('Maximum 5 customers can be selected', 'error');
      }

      countEl.textContent = followupSelectedCustomers.size;
      selectionBar.classList.toggle('hidden', followupSelectedCustomers.size === 0);
    }

    async function sendFollowupReminders() {
      if (followupSelectedCustomers.size === 0) {
        showNotification('Please select at least one customer', 'error');
        return;
      }

      const btn = document.getElementById('followup-send-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">&#9696;</span> Sending...';

      try {
        const response = await fetch('/api/customers/send-followups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerIds: Array.from(followupSelectedCustomers) })
        });

        const data = await response.json();

        if (data.success) {
          showNotification(`Follow-up reminders sent to ${data.sent} customers!`, 'success');
          followupSelectedCustomers.clear();
          loadFollowupCustomers();
        } else {
          showNotification(data.error || 'Failed to send reminders', 'error');
        }
      } catch (err) {
        showNotification('Network error sending reminders', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
          Send Reminders
        `;
      }
    }

    document.getElementById('followup-send-btn')?.addEventListener('click', sendFollowupReminders);

    async function loadBulkTickets() {
      const loading = document.getElementById('bulk-tickets-loading');
      const error = document.getElementById('bulk-tickets-error');
      const errorMsg = document.getElementById('bulk-tickets-error-msg');
      const list = document.getElementById('bulk-tickets-list');
      const selectionBar = document.getElementById('bulk-selection-bar');

      loading.classList.remove('hidden');
      error.classList.add('hidden');
      list.classList.add('hidden');
      selectionBar.classList.add('hidden');

      try {
        const response = await fetch('/api/repairdesk/tickets');
        const data = await response.json();

        loading.classList.add('hidden');

        if (!data.success) {
          error.classList.remove('hidden');
          errorMsg.textContent = data.error || 'Unknown error';
          return;
        }

        bulkTicketsData = data.tickets || [];
        bulkSelectedTickets.clear();
        
        // Fetch sent status for all phone numbers
        const phoneNumbers = bulkTicketsData.map(t => t.customer_phone).filter(p => p);
        if (phoneNumbers.length > 0) {
          try {
            const statusResponse = await fetch('/api/customers/sent-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phoneNumbers })
            });
            const statusData = await statusResponse.json();
            if (statusData.success) {
              window.bulkSentStatus = statusData.sentStatus || {};
            }
          } catch (err) {
            console.log('Could not fetch sent status:', err);
            window.bulkSentStatus = {};
          }
        }
        
        renderBulkTickets();

      } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        errorMsg.textContent = err.message || 'Network error';
      }
    }

    function renderBulkTickets() {
      const list = document.getElementById('bulk-tickets-list');
      const toggle = document.getElementById('bulk-completed-toggle');
      const searchInput = document.getElementById('bulk-search-input');
      const showCompletedOnly = toggle?.checked || false;
      const searchTerm = (searchInput?.value || '').toLowerCase().trim();

      let filteredTickets = bulkTicketsData;
      
      // Apply completed filter
      if (showCompletedOnly) {
        filteredTickets = filteredTickets.filter(t => 
          t.status === 'Repaired & Collected' || 
          t.status === 'Collected' || 
          t.status === 'Closed' ||
          t.status === 'Complete'
        );
      }
      
      // Apply search filter (match against customer name OR device name)
      if (searchTerm) {
        filteredTickets = filteredTickets.filter(t => {
          const customerName = (t.customer_name || '').toLowerCase();
          const deviceName = (t.device_name || '').toLowerCase();
          return customerName.includes(searchTerm) || deviceName.includes(searchTerm);
        });
      }

      // Apply quick filters
      if (activeQuickFilter === 'iphone') {
        filteredTickets = filteredTickets.filter(t => {
          const device = (t.device_name || '').toLowerCase();
          return device.includes('iphone');
        });
      } else if (activeQuickFilter === 'high-value') {
        filteredTickets = filteredTickets.filter(t => {
          const cost = parseFloat(t.cost) || 0;
          return cost > 100;
        });
      } else if (activeQuickFilter === 'last30') {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        filteredTickets = filteredTickets.filter(t => {
          const createdDate = t.created_at ? new Date(t.created_at) : null;
          return createdDate && createdDate >= thirtyDaysAgo;
        });
      }

      if (filteredTickets.length === 0) {
        const message = searchTerm ? `No tickets matching "${searchInput.value}"` : 'No tickets found';
        list.innerHTML = `<div class="text-center py-8 text-gray-500">${message}</div>`;
        list.classList.remove('hidden');
        return;
      }

      list.innerHTML = filteredTickets.map(ticket => {
        let statusClass = 'bg-gray-100 text-gray-600';
        if (ticket.status === 'Collected' || ticket.status === 'Repaired & Collected' || ticket.status === 'Closed' || ticket.status === 'Complete') {
          statusClass = 'bg-green-100 text-green-700';
        } else if (ticket.status === 'In Progress') {
          statusClass = 'bg-amber-100 text-amber-700';
        }

        const isSelected = bulkSelectedTickets.has(ticket.id);
        const selectedClass = isSelected ? 'bg-purple-50 border-purple-300' : 'border-gray-200';

        const sentStatus = window.bulkSentStatus?.[ticket.customer_phone];
        const sentBadge = sentStatus 
          ? `<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-medium">Last SMS: ${sentStatus}</span>`
          : `<span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 font-medium">Never Contacted</span>`;

        return `
          <div class="bulk-ticket-row p-3 border ${selectedClass} rounded-lg hover:bg-purple-50 cursor-pointer transition-colors flex items-center gap-3" 
               data-id="${ticket.id}"
               data-name="${ticket.customer_name}"
               data-phone="${ticket.customer_phone}"
               data-device="${ticket.device_name}">
            <input type="checkbox" class="bulk-checkbox w-5 h-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500" ${isSelected ? 'checked' : ''}>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-mono text-gray-500">#${ticket.id}</span>
                <span class="text-xs px-2 py-0.5 rounded-full ${statusClass}">${ticket.status}</span>
                ${sentBadge}
              </div>
              <div class="font-medium text-gray-900">${ticket.customer_name}</div>
              <div class="text-sm text-gray-500">${ticket.device_name}</div>
            </div>
            <div class="text-right text-sm text-gray-500">
              ${ticket.customer_phone}
            </div>
          </div>
        `;
      }).join('');

      list.classList.remove('hidden');

      document.querySelectorAll('.bulk-ticket-row').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return;
          const checkbox = row.querySelector('.bulk-checkbox');
          checkbox.checked = !checkbox.checked;
          handleBulkSelection(row, checkbox.checked);
        });

        row.querySelector('.bulk-checkbox').addEventListener('change', (e) => {
          handleBulkSelection(row, e.target.checked);
        });
      });

      updateBulkSelectionBar();
    }

    function handleBulkSelection(row, isChecked) {
      const ticketId = row.dataset.id;

      if (isChecked) {
        if (bulkSelectedTickets.size >= 5) {
          row.querySelector('.bulk-checkbox').checked = false;
          showNotification('Maximum 5 customers can be selected', 'error');
          return;
        }
        bulkSelectedTickets.add(ticketId);
        row.classList.add('bg-purple-50', 'border-purple-300');
        row.classList.remove('border-gray-200');
      } else {
        bulkSelectedTickets.delete(ticketId);
        row.classList.remove('bg-purple-50', 'border-purple-300');
        row.classList.add('border-gray-200');
      }

      updateBulkSelectionBar();
    }

    function updateBulkSelectionBar() {
      const selectionBar = document.getElementById('bulk-selection-bar');
      const countSpan = document.getElementById('bulk-selected-count');

      countSpan.textContent = bulkSelectedTickets.size;

      if (bulkSelectedTickets.size > 0) {
        selectionBar.classList.remove('hidden');
      } else {
        selectionBar.classList.add('hidden');
      }
    }

    const bulkCompletedToggle = document.getElementById('bulk-completed-toggle');
    if (bulkCompletedToggle) {
      bulkCompletedToggle.addEventListener('change', renderBulkTickets);
    }

    const bulkSearchInput = document.getElementById('bulk-search-input');
    if (bulkSearchInput) {
      bulkSearchInput.addEventListener('input', renderBulkTickets);
    }

    const bulkRefreshBtn = document.getElementById('bulk-refresh-btn');
    if (bulkRefreshBtn) {
      bulkRefreshBtn.addEventListener('click', loadBulkTickets);
    }

    // Quick Filter button handlers
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter;
        const clearBtn = document.getElementById('filter-clear');
        
        if (filter === 'clear') {
          activeQuickFilter = null;
          clearBtn.classList.add('hidden');
          document.querySelectorAll('.quick-filter-btn').forEach(b => {
            b.classList.remove('ring-2', 'ring-offset-1');
          });
        } else {
          if (activeQuickFilter === filter) {
            activeQuickFilter = null;
            clearBtn.classList.add('hidden');
            btn.classList.remove('ring-2', 'ring-offset-1');
          } else {
            activeQuickFilter = filter;
            clearBtn.classList.remove('hidden');
            document.querySelectorAll('.quick-filter-btn').forEach(b => {
              b.classList.remove('ring-2', 'ring-offset-1');
            });
            btn.classList.add('ring-2', 'ring-offset-1');
          }
        }
        renderBulkTickets();
      });
    });

    const bulkSendBtn = document.getElementById('bulk-send-btn');
    if (bulkSendBtn) {
      bulkSendBtn.addEventListener('click', async () => {
        if (bulkSelectedTickets.size === 0) {
          showNotification('Please select at least one customer', 'error');
          return;
        }

        const campaignMessage = document.getElementById('campaign-message').value.trim();
        if (!campaignMessage) {
          showErrorModal('Please enter a campaign message before launching.');
          return;
        }

        const selectedNumbers = [];
        document.querySelectorAll('.bulk-ticket-row').forEach(row => {
          if (bulkSelectedTickets.has(row.dataset.id)) {
            selectedNumbers.push(row.dataset.phone);
          }
        });

        bulkSendBtn.disabled = true;
        bulkSendBtn.innerHTML = '<span class="inline-block animate-spin">‚è≥</span> Sending...';

        try {
          const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          const payload = {
            campaign_name: `Reactivation ${today}`,
            message: campaignMessage,
            numbers: selectedNumbers
          };

          const response = await fetch('/api/campaigns/launch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            showNotification('üöÄ Campaign Launched! Messages are being sent.', 'success');
            bulkSelectedTickets.clear();
            document.getElementById('campaign-message').value = '';
            renderBulkTickets();
          } else {
            showErrorModal('Failed to launch campaign. Please try again.');
          }
        } catch (err) {
          console.error('Campaign launch error:', err);
          showErrorModal('Network error. Could not reach the campaign server.');
        }

        bulkSendBtn.disabled = false;
        bulkSendBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg> Launch Reactivation Campaign`;
      });
    }

    // Load bulk tickets when bulk-sms section is shown
    const originalShowSection = showSection;
    showSection = function(sectionId) {
      originalShowSection(sectionId);
      if (sectionId === 'bulk-sms' && bulkTicketsData.length === 0) {
        loadBulkTickets();
      }
    };

    function showLoginModal() {
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('login-email').focus();
    }

    function hideLoginModal() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('login-error').classList.add('hidden');
      document.getElementById('login-modal-form').reset();
    }

    const loginModalBackdrop = document.getElementById('login-modal-backdrop');
    if (loginModalBackdrop) {
      loginModalBackdrop.addEventListener('click', () => {
        hideLoginModal();
      });
    }

    const loginModalForm = document.getElementById('login-modal-form');
    if (loginModalForm) {
      loginModalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const loginBtn = document.getElementById('login-modal-btn');
        const loginError = document.getElementById('login-error');
        
        loginError.classList.add('hidden');
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';
        
        const formData = {
          email: document.getElementById('login-email').value.trim(),
          password: document.getElementById('login-password').value
        };
        
        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(formData)
          });
          
          const data = await response.json();
          
          if (data.success) {
            hideLoginModal();
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
            loadUserOnPageLoad();
            loadStats();
            loadMessages();
            loadCustomers();
            showNotification('Welcome back!', 'success');
          } else {
            loginError.textContent = data.error || 'Login failed';
            loginError.classList.remove('hidden');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
          }
        } catch (error) {
          loginError.textContent = 'Network error. Please try again.';
          loginError.classList.remove('hidden');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Log In';
        }
      });
    }

    async function loadUserOnPageLoad() {
      try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();
        
        if (data.success && data.user) {
          const user = data.user;
          hideLoginModal();
          
          const userDisplay = document.getElementById('user-display-name');
          const userEmail = document.getElementById('user-email');
          const userAvatar = document.getElementById('user-avatar');
          const sidebarBrand = document.getElementById('sidebar-brand');
          const headerBranding = document.getElementById('header-branding');
          
          if (userDisplay) userDisplay.textContent = user.first_name || 'User';
          if (userEmail) userEmail.textContent = user.email || 'user@example.com';
          if (userAvatar && user.first_name) userAvatar.textContent = user.first_name.charAt(0).toUpperCase();
          
          businessName = user.business_name || 'Our Store';
          
          if (sidebarBrand) {
            sidebarBrand.textContent = user.business_name || 'ReviewGuard';
          }
          const mobileBrand = document.getElementById('mobile-brand');
          if (mobileBrand) {
            mobileBrand.textContent = user.business_name || 'ReviewGuard';
          }
          if (headerBranding) {
            headerBranding.textContent = user.business_name ? `${user.business_name} SMS Manager` : 'SMS Manager';
          }
          
          updatePreview();
        } else {
          showLoginModal();
        }
      } catch (error) {
        console.error('Error loading user:', error);
        showLoginModal();
      }
    }

    // Google Reviews Management
    let currentReviewsFilter = 'pending';
    
    async function loadGoogleReviews(status = currentReviewsFilter) {
      currentReviewsFilter = status;
      try {
        const response = await fetch(`/api/reviews?status=${status}`);
        const data = await response.json();
        
        const container = document.getElementById('google-reviews-list');
        
        if (data.success && data.reviews && data.reviews.length > 0) {
          container.innerHTML = data.reviews.map(review => `
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5" data-review-id="${review.id}">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center flex-shrink-0">
                    <span class="text-white font-medium">${review.reviewer_name.charAt(0).toUpperCase()}</span>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-gray-900">${review.reviewer_name}</span>
                      <span class="text-yellow-500">${'‚≠ê'.repeat(review.star_rating)}</span>
                    </div>
                    <div class="text-xs text-gray-400">${review.review_date ? new Date(review.review_date).toLocaleDateString() : 'Unknown date'}</div>
                  </div>
                </div>
                <span class="px-2 py-1 text-xs rounded-full ${review.status === 'pending' ? 'bg-amber-100 text-amber-700' : review.status === 'posted' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">${review.status}</span>
              </div>
              
              ${review.comment ? `<div class="bg-gray-50 rounded-lg p-3 mb-4 text-sm text-gray-700">"${review.comment}"</div>` : ''}
              
              ${review.status === 'pending' ? `
                <div class="mb-4">
                  <label class="text-xs font-medium text-gray-500 uppercase tracking-wide block mb-1.5">AI Draft Reply (editable)</label>
                  <textarea id="draft-${review.id}" rows="3" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent resize-none">${review.ai_reply_draft || ''}</textarea>
                </div>
                <div class="flex gap-2">
                  <button data-action="openAIReply" data-name="${review.reviewer_name.replace(/"/g, '&quot;')}" data-rating="${review.star_rating}" data-text="${(review.comment || '').replace(/"/g, '&quot;')}" class="px-4 py-2 bg-accent text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    Reply
                  </button>
                  <button data-action="postReply" data-id="${review.id}" class="flex-1 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    Post Reply
                  </button>
                  <button data-action="ignoreReview" data-id="${review.id}" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors">
                    Ignore
                  </button>
                </div>
              ` : review.status === 'posted' ? `
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                  <div class="text-xs font-medium text-green-600 mb-1">Posted Reply:</div>
                  <div class="text-sm text-green-800">${review.posted_reply || 'No reply text saved'}</div>
                </div>
              ` : ''}
            </div>
          `).join('');
        } else {
          container.innerHTML = `<div class="text-center py-12 text-gray-500">No ${status === 'all' ? '' : status} reviews found</div>`;
        }
        
        loadReviewStats();
      } catch (error) {
        console.error('Error loading reviews:', error);
        document.getElementById('google-reviews-list').innerHTML = '<div class="text-center py-12 text-red-500">Error loading reviews</div>';
      }
    }
    
    async function loadReviewStats() {
      try {
        const response = await fetch('/api/reviews/stats');
        const data = await response.json();
        if (data.success && data.stats) {
          document.getElementById('reviews-pending-count').textContent = data.stats.pending_count || 0;
          document.getElementById('reviews-posted-count').textContent = data.stats.posted_count || 0;
          document.getElementById('reviews-ignored-count').textContent = data.stats.ignored_count || 0;
          document.getElementById('reviews-avg-rating').textContent = data.stats.avg_rating ? `${data.stats.avg_rating}‚≠ê` : '-';
        }
      } catch (error) {
        console.error('Error loading review stats:', error);
      }
    }
    
    // Event delegation for dynamically created buttons
    document.addEventListener('click', async function(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      
      const action = btn.dataset.action;
      console.log('[EVENT] Button clicked:', action, btn.dataset);
      
      if (action === 'filterReviews') {
        const status = btn.dataset.status;
        document.querySelectorAll('.reviews-filter-btn').forEach(b => {
          b.classList.remove('bg-gray-900', 'text-white');
          b.classList.add('bg-white', 'border', 'border-gray-200', 'text-gray-600');
        });
        btn.classList.remove('bg-white', 'border', 'border-gray-200', 'text-gray-600');
        btn.classList.add('bg-gray-900', 'text-white');
        loadGoogleReviews(status);
      }
      
      else if (action === 'postReply') {
        const reviewId = btn.dataset.id;
        const draftTextarea = document.getElementById(`draft-${reviewId}`);
        const replyText = draftTextarea ? draftTextarea.value.trim() : '';
        
        if (!replyText) {
          showNotification('Please enter a reply', 'error');
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-spin">‚è≥</span> Posting...';
        
        try {
          const response = await fetch('/api/reviews/post-reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reviewId: parseInt(reviewId), replyText })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Reply posted successfully!', 'success');
            loadGoogleReviews();
          } else {
            showNotification(data.error || 'Failed to post reply', 'error');
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Post Reply';
          }
        } catch (error) {
          console.error('Error posting reply:', error);
          showNotification('Failed to post reply', 'error');
          btn.disabled = false;
        }
      }
      
      else if (action === 'ignoreReview') {
        const reviewId = btn.dataset.id;
        if (!confirm('Are you sure you want to ignore this review?')) return;
        
        try {
          const response = await fetch('/api/reviews/ignore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reviewId: parseInt(reviewId) })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Review ignored', 'success');
            loadGoogleReviews();
          } else {
            showNotification(data.error || 'Failed to ignore review', 'error');
          }
        } catch (error) {
          console.error('Error ignoring review:', error);
          showNotification('Failed to ignore review', 'error');
        }
      }
      
      else if (action === 'sendReminder') {
        const { id, name, phone, link } = btn.dataset;
        if (!confirm(`Send reminder to ${name}?`)) return;
        try {
          const response = await fetch('/api/send-reminder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messageId: parseInt(id), customerName: name, customerPhone: phone, reviewLink: link })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Reminder sent successfully!', 'success');
            loadHistory();
          } else {
            showNotification(data.error || 'Failed to send reminder', 'error');
          }
        } catch (error) {
          console.error('Error sending reminder:', error);
          showNotification('Failed to send reminder', 'error');
        }
      }
      
      else if (action === 'resendMessage') {
        const { name, phone } = btn.dataset;
        if (!confirm(`Resend review request to ${name}?`)) return;
        // Load customer data and navigate to Send SMS
        document.getElementById('customer-name').value = name;
        document.getElementById('customer-phone').value = phone;
        showSection('send-sms');
        showNotification('Customer loaded - ready to resend!', 'success');
      }
      
      else if (action === 'viewFeedback') {
        // Navigate to Feedback section
        showSection('feedback');
        showNotification('Viewing feedback inbox', 'success');
      }
      
      else if (action === 'loadCustomerData') {
        const { name, phone } = btn.dataset;
        document.getElementById('customer-name').value = name;
        document.getElementById('customer-phone').value = phone;
        showSection('send-sms');
        showNotification('Customer data loaded!', 'success');
      }
      
      else if (action === 'markFeedbackRead') {
        const feedbackId = parseInt(btn.dataset.id);
        try {
          const response = await fetch('/api/feedback/mark-read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedbackId })
          });
          const data = await response.json();
          if (data.success) {
            loadFeedback();
            showNotification('Feedback marked as read', 'success');
          }
        } catch (error) {
          console.error('Error marking feedback as read:', error);
        }
      }
      
      else if (action === 'smsApology') {
        const { id, name, phone } = btn.dataset;
        window.openApologyModal(name, phone, id);
      }
      
      else if (action === 'callCustomer') {
        const { id } = btn.dataset;
        try {
          const response = await fetch(`/api/feedback/${id}/called`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await response.json();
          if (data.success) {
            loadFeedback();
            showNotification('Call tracked successfully', 'success');
          }
        } catch (error) {
          console.error('Error tracking call:', error);
        }
      }
      
      else if (action === 'markAsRead') {
        const { id } = btn.dataset;
        try {
          const response = await fetch(`/api/feedback/${id}/mark-read`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await response.json();
          if (data.success) {
            loadFeedback();
            showNotification('Feedback marked as read', 'success');
          } else {
            showNotification(data.error || 'Failed to mark as read', 'error');
          }
        } catch (error) {
          console.error('Error marking as read:', error);
          showNotification('Failed to mark as read', 'error');
        }
      }
      
      else if (action === 'blockFeedback') {
        const feedbackId = parseInt(btn.dataset.id);
        if (!confirm('Mark this feedback as ignored/spam?')) return;
        try {
          const response = await fetch('/api/feedback/block', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedbackId })
          });
          const data = await response.json();
          if (data.success) {
            loadFeedback();
            showNotification('Feedback marked as ignored', 'success');
          } else {
            showNotification(data.error || 'Failed to block feedback', 'error');
          }
        } catch (error) {
          console.error('Error blocking feedback:', error);
          showNotification('Failed to block feedback', 'error');
        }
      }
      
      else if (action === 'openAIReply') {
        const { name, rating, text } = btn.dataset;
        showAIReplyPanel(name, rating, text);
      }
      
      else if (action === 'reactivateCustomer') {
        const { name, phone } = btn.dataset;
        document.getElementById('customer-name').value = name;
        document.getElementById('customer-phone').value = phone;
        document.getElementById('message-type').value = 'review';
        showSection('send-sms');
        updatePreview();
        showNotification(`Ready to send reactivation message to ${name}`, 'success');
      }
    });

    // Handle hash navigation (e.g., #feedback from /feedback.html redirect)
    const hash = window.location.hash.replace('#', '');
    if (hash && ['dashboard', 'send-sms', 'history', 'customers', 'reviews', 'billing', 'feedback', 'settings'].includes(hash)) {
      showSection(hash);
    } else {
      showSection('dashboard');
    }
    loadUserOnPageLoad();
    updatePreview();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // CLEANUP MODE: Unregister ALL service workers and clear ALL caches
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            console.log('Unregistering service worker:', registration.scope);
            await registration.unregister();
          }
          
          // Clear ALL caches
          const cacheNames = await caches.keys();
          await Promise.all(
            cacheNames.map(name => {
              console.log('Deleting cache:', name);
              return caches.delete(name);
            })
          );
          
          console.log('All service workers and caches cleared');
        } catch (error) {
          console.log('Cleanup error:', error);
        }
      });
    }
  </script>

</body>
</html>
